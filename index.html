<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ThunderChat</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading ThunderChat...</div>
    </div>

    <header>
        <h1>ThunderChat</h1>
        <div class="header-tabs">
            <button id="groups-tab" class="tab-btn">Groups</button>
            <button id="contacts-tab" class="tab-btn">Contacts</button>
            <button id="calls-tab" class="tab-btn">Calls</button>
            <button id="posts-tab" class="tab-btn">Posts</button>
            <button id="settings-tab" class="tab-btn">Settings</button>
        </div>
    </header>

    <main>
        <div id="auth-section" class="auth-form">
            <div id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input id="login-email" type="email" placeholder="Enter your email" />
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input id="login-password" type="password" placeholder="Enter your password" />
                </div>
                <button id="login-btn">Login</button>
                <div id="toggle-to-register" class="toggle-form">Don't have an account? Register</div>
            </div>

            <div id="register-form" style="display: none;">
                <div class="form-group">
                    <label for="reg-username">Username</label>
                    <input id="reg-username" type="text" placeholder="Choose a username" />
                </div>
                <div class="form-group">
                    <label for="reg-email">Email</label>
                    <input id="reg-email" type="email" placeholder="Enter your email" />
                </div>
                <div class="form-group">
                    <label for="reg-password">Password</label>
                    <input id="reg-password" type="password" placeholder="Create a password" />
                </div>
                <button id="register-btn">Register</button>
                <div id="toggle-to-login" class="toggle-form">Already have an account? Login</div>
            </div>
        </div>

        <div id="group-options" class="group-options">
            <h2>Welcome, <span id="username-display"></span></h2>
            <button id="create-group-btn">Create Group ‚ú®</button>
            <button id="join-group-btn">Join New Group ü§ù</button>
            
            <div class="groups-list">
                <h3>Your Groups (<span id="groups-count">0</span>)</h3>
                <div id="joined-groups-list">
                    <div class="no-groups">You haven't joined any groups yet</div>
                </div>
            </div>
        </div>

        <div id="chat-section" class="chat-section">
            <div class="chat-header">
                <button class="back-btn" id="back-btn">‚Üê</button>
                <h2 id="group-name-display"></h2>
                <button class="group-settings-btn" id="group-settings-btn">‚öôÔ∏è</button>
            </div>
            <div id="messages"></div>
            <footer>
                <input id="msg-input" type="text" placeholder="Type a message..." />
                <button id="send-btn">Send ‚û§</button>
            </footer>
        </div>

        <!-- ... other sections ... -->

<div id="contacts-section" class="contacts-section">
            <div class="contacts-list">
                <h2>Your Contacts</h2>
                <button id="add-contact-btn">Add Contact ‚ûï</button>
                
                <div class="contacts-container">
                    <div id="contacts-list">
                        <div class="no-contacts">You don't have any contacts yet</div>
                    </div>
                </div>
            </div>
        </div>
    
<!-- ... other sections, including your new call-screen div ... -->

        <div id="private-chat-section" class="private-chat-section">
            <div class="private-chat-header">
                <button class="back-btn" id="back-private-btn">‚Üê</button>
                <h2 id="contact-name-display"></h2>
                </div>
            <div id="private-messages"></div>
            <footer>
                <input id="private-msg-input" type="text" placeholder="Type a message..." />
                <button id="send-private-btn">Send ‚û§</button>
            </footer>
        </div>

        <div id="posts-section" class="posts-section">
            <h2>Community Posts</h2>
            <button id="create-post-btn">Create New Post üìù</button>
            
            <div class="post-categories">
                <button id="new-posts-btn" class="secondary active">New</button>
                <button id="trending-posts-btn" class="secondary">Trending</button>
            </div>

            <div id="posts-container" class="posts-container">
                <div class="no-posts">No posts available yet. Be the first to share!</div>
            </div>
        </div>

        <div id="posts-studio-section" class="posts-studio-section">
            <div class="posts-studio-header"> <button class="back-btn" id="back-to-settings-btn">‚Üê</button>
                <h2>Your Posts Studio</h2>
                <div></div> </div>
            <div class="posts-studio-controls">
                <input type="text" id="post-studio-search" placeholder="Search your posts..." />
                <select id="post-studio-sort">
                    <option value="newest">Sort by: Newest</option>
                    <option value="oldest">Sort by: Oldest</option>
                    <option value="most-likes">Sort by: Most Likes</option>
                    <option value="most-comments">Sort by: Most Comments</option>
                </select>
            </div>
            <div class="posts-studio-analytics">
                <p>Total Posts: <span id="total-posts-count">0</span></p>
                <p>Total Likes Received: <span id="total-likes-received">0</span></p>
                <p>Total Comments Received: <span id="total-comments-received">0</span></p>
            </div>
            <div id="user-posts-list" class="user-posts-list">
                <h3>Your Uploaded Posts</h3>
                <div class="no-user-posts">You haven't uploaded any posts yet.</div>
            </div>
        </div>

        <div id="settings-section" class="settings-section">
            <h2>Your Profile</h2>
            
            <div class="avatar-upload">
                <div class="avatar-preview" id="profile-avatar-preview">
                    
                </div>
                <div class="form-group" style="width: 100%;">
                    <label for="profile-avatar-url">Profile Picture URL</label>
                    <input type="text" id="profile-avatar-url" placeholder="Enter image URL" />
                </div>
            </div>
            
            <div class="form-group">
                <label for="profile-username">Username</label>
                <input id="profile-username" type="text" placeholder="Your username" />
                </div>
            
            <div class="form-group">
                <label for="profile-status">Status</label>
                <input id="profile-status" type="text" placeholder="Your status" />
            </div>

            <div class="form-group theme-switcher">
                <label>Theme</label>
                <div class="theme-options">
                    <button id="light-theme-btn" class="secondary">Light</button>
                    <button id="dark-theme-btn" class="secondary">Dark</button>
                </div>
            </div>
            
            <div class="user-id-display">
                <strong>Your ID:</strong>
                <div id="user-id-text">Loading...</div>
                </div>
            
            <button id="posts-studio-btn" class="secondary">Posts Studio üì∏</button> <button id="save-profile-btn">Save Changes ‚úÖ</button>
            <button id="logout-btn" class="secondary">Logout üö™</button>
        </div>
    </main>

    <div id="group-settings-menu" class="settings-menu">
        <div class="settings-header">
            <h3>Group Settings</h3>
            <button class="close-settings" id="close-group-settings">√ó</button>
        </div>
        
        <div class="avatar-upload">
            <div class="avatar-preview" id="group-avatar-preview">
                
            </div>
            <div class="form-group" style="width: 100%;">
                <label for="group-avatar-url">Group Picture URL</label>
                <input type="text" id="group-avatar-url" placeholder="Enter image URL" />
            </div>
        </div>
        
        <div class="form-group">
            <label>Group Name</label>
            <input id="group-name-setting" type="text" readonly />
            <small>Note: Group name cannot be changed.</small>
        </div>
        
        <div class="form-group">
            <label>Group Password</label>
            <input id="group-password-setting" type="text" readonly />
            <small>Note: Group password cannot be changed.</small>
        </div>
        
        <div class="form-group">
            <label for="group-desc-setting">Group Description</label>
            <textarea id="group-desc-setting" placeholder="Enter group description"></textarea>
        </div>
        
        <button id="save-group-settings-btn">Save Changes ‚úÖ</button>
    </div>

    <div id="create-post-modal" class="custom-alert-modal">
        <div class="create-post-content">
            <span id="close-create-post-modal" class="close-alert-btn">&times;</span>
            <h3>Create New Post</h3>
            <div class="form-group template-selector">
                <label for="post-template-select">Choose a Template</label>
                <select id="post-template-select">
                    <option value="">-- Select a template --</option>
                    <option value="announcement">üì¢ Announcement</option>
                    <option value="inspiration">‚ú® Daily Inspiration</option>
                    <option value="question">‚ùì Question of the Day</option>
                    <option value="sale">üí∞ Item for Sale</option>
                </select>
            </div>
            <div class="form-group">
                <label for="post-image-url">Image URL (Optional)</label>
                <input type="text" id="post-image-url" placeholder="Enter image URL" />
            </div>
            <div class="form-group">
                <label for="post-description">Post Content</label>
                <textarea id="post-description" placeholder="What's on your mind?"></textarea>
                <div class="emoji-input-group">
                    <input type="text" id="emoji-input" placeholder="Type emoji (e.g., üòä)" maxlength="2" />
                    <button id="add-emoji-btn">Add Emoji</button>
                </div>
            </div>
            <button id="submit-post-btn">Post It! üöÄ</button>
        </div>
    </div>

    <div id="edit-post-modal" class="custom-alert-modal">
        <div class="edit-post-content">
            <span id="close-edit-post-modal" class="close-alert-btn">&times;</span>
            <h3>Edit Post</h3>
            <div class="form-group">
                <label for="edit-post-image-url">Image URL (Optional)</label>
                <input type="text" id="edit-post-image-url" placeholder="Enter image URL" />
            </div>
            <div class="form-group">
                <label for="edit-post-description">Post Content</label>
                <textarea id="edit-post-description" placeholder="Edit your post content"></textarea>
                <div class="emoji-input-group">
                    <input type="text" id="edit-emoji-input" placeholder="Type emoji (e.g., üòä)" maxlength="2" />
                    <button id="add-edit-emoji-btn">Add Emoji</button>
                </div>
            </div>
            <button id="save-edited-post-btn">Save Changes ‚úÖ</button>
        </div>
    </div>

    <div id="custom-alert-modal" class="custom-alert-modal">
        <div class="custom-alert-content">
            <span id="close-alert-btn" class="close-alert-btn">&times;</span>
            <p id="custom-alert-message"></p>
            <button id="custom-alert-ok-btn">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            push, 
            onChildAdded, 
            get, 
            child,
            update,
            onValue,
            remove // Import remove for deleting posts
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBD4bDQgVtMd9cwq9Hfdz54NYSBcQvPr1Y",
            authDomain: "thunderboundthunderchat.firebaseapp.com",
            databaseURL: "https://thunderboundthunderchat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "thunderboundthunderchat",
            storageBucket: "thunderboundthunderchat.appspot.com",
            messagingSenderId: "79690962383",
            appId: "1:79690962383:web:fecf12881a13a4fdf22eba"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authSection = document.getElementById('auth-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const groupOptions = document.getElementById('group-options');
        const chatSection = document.getElementById('chat-section');
        const contactsSection = document.getElementById('contacts-section');
        const privateChatSection = document.getElementById('private-chat-section');
        const postsSection = document.getElementById('posts-section'); 
        const postsStudioSection = document.getElementById('posts-studio-section');
        const settingsSection = document.getElementById('settings-section');
        const messagesDiv = document.getElementById('messages');
        const privateMessagesDiv = document.getElementById('private-messages');
        const usernameDisplay = document.getElementById('username-display');
        const groupNameDisplay = document.getElementById('group-name-display');
        const contactNameDisplay = document.getElementById('contact-name-display');
        const joinedGroupsList = document.getElementById('joined-groups-list');
        const groupsCount = document.getElementById('groups-count');
        const contactsList = document.getElementById('contacts-list');
        const postsContainer = document.getElementById('posts-container'); 
        const userPostsList = document.getElementById('user-posts-list');
        const groupsTab = document.getElementById('groups-tab');
        const contactsTab = document.getElementById('contacts-tab');
        const postsTab = document.getElementById('posts-tab'); 
        const settingsTab = document.getElementById('settings-tab');
        const groupSettingsMenu = document.getElementById('group-settings-menu');
        const closeGroupSettings = document.getElementById('close-group-settings');
        const groupSettingsBtn = document.getElementById('group-settings-btn');
        const addContactBtn = document.getElementById('add-contact-btn');
        const profileAvatarPreview = document.getElementById('profile-avatar-preview');
        const groupAvatarPreview = document.getElementById('group-avatar-preview');
        
        const profileAvatarUrlInput = document.getElementById('profile-avatar-url');
        const groupAvatarUrlInput = document.getElementById('group-avatar-url');

        const userIdText = document.getElementById('user-id-text');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const saveGroupSettingsBtn = document.getElementById('save-group-settings-btn');

        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const regUsernameInput = document.getElementById('reg-username');
        const regEmailInput = document.getElementById('reg-email');
        const regPasswordInput = document.getElementById('reg-password');
        const registerBtn = document.getElementById('register-btn');
        const toggleToRegister = document.getElementById('toggle-to-register');
        const toggleToLogin = document.getElementById('toggle-to-login');

        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
        const closeAlertBtn = document.getElementById('close-alert-btn');

        const lightThemeBtn = document.getElementById('light-theme-btn');
        const darkThemeBtn = document.getElementById('dark-theme-btn');

        const createPostBtn = document.getElementById('create-post-btn');
        const newPostsBtn = document.getElementById('new-posts-btn');
        const trendingPostsBtn = document.getElementById('trending-posts-btn');
        const createPostModal = document.getElementById('create-post-modal');
        const closeCreatePostModal = document.getElementById('close-create-post-modal');
        const postImageUrlInput = document.getElementById('post-image-url');
        const postDescriptionInput = document.getElementById('post-description');
        const submitPostBtn = document.getElementById('submit-post-btn');
        const postTemplateSelect = document.getElementById('post-template-select');
        const emojiInput = document.getElementById('emoji-input');
        const addEmojiBtn = document.getElementById('add-emoji-btn');

        // Posts Studio elements
        const postsStudioBtn = document.getElementById('posts-studio-btn');
        const backToSettingsBtn = document.getElementById('back-to-settings-btn');
        const postStudioSearchInput = document.getElementById('post-studio-search');
        const postStudioSortSelect = document.getElementById('post-studio-sort');
        const totalPostsCountSpan = document.getElementById('total-posts-count');
        const totalLikesReceivedSpan = document.getElementById('total-likes-received');
        const totalCommentsReceivedSpan = document.getElementById('total-comments-received');

        // Edit Post Modal elements
        const editPostModal = document.getElementById('edit-post-modal');
        const closeEditPostModal = document.getElementById('close-edit-post-modal');
        const editPostImageUrlInput = document.getElementById('edit-post-image-url');
        const editPostDescriptionInput = document.getElementById('edit-post-description');
        const editEmojiInput = document.getElementById('edit-emoji-input');
        const addEditEmojiBtn = document.getElementById('add-edit-emoji-btn');
        const saveEditedPostBtn = document.getElementById('save-edited-post-btn');

        let currentGroup = "";
        let currentContact = "";
        let currentPostCategory = "new"; // Default post category for community posts
        let currentUser = null;
        let userGroups = [];
        let userContacts = [];
        let userData = {}; // Stores additional user profile data from Realtime DB
        let allPosts = []; // Store all community posts for sorting
        let userPosts = []; // Store only current user's posts for Posts Studio
        let editingPostId = null; // To keep track of the post being edited

        // Listener references for cleanup - these will now store unsubscribe functions
        let currentGroupChatUnsubscribe = null;
        let currentPrivateChatUnsubscribe = null;
        let currentCommunityPostsUnsubscribe = null;
        let currentUserPostsUnsubscribe = null;
        let alertTimeoutId = null; // To manage alert auto-hide

        // Initialize the app
        window.addEventListener('DOMContentLoaded', () => {
            loadingScreen.style.display = 'none';
            loadUserTheme(); // Load theme as soon as possible
            // The onAuthStateChanged listener will handle the initial section display
        });

        // Custom Alert Modal functions
        function showAlert(message, duration = 3000) { // Default duration 3 seconds
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex'; // Use flex to center
            clearTimeout(alertTimeoutId); // Clear any existing timeout
            alertTimeoutId = setTimeout(hideAlert, duration);
        }

        function hideAlert() {
            customAlertModal.style.display = 'none';
        }

        customAlertOkBtn.addEventListener('click', hideAlert);
        closeAlertBtn.addEventListener('click', hideAlert);

        // --- Theme Switcher Logic ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                darkThemeBtn.classList.add('active');
                lightThemeBtn.classList.remove('active');
            } else {
                document.body.classList.remove('dark-theme');
                lightThemeBtn.classList.add('active');
                darkThemeBtn.classList.remove('active');
            }
            // Save theme preference to local storage
            localStorage.setItem('theme', theme);
            // Optionally, save to Firebase for cross-device sync
            if (currentUser && currentUser.uid) {
                update(ref(db, `users/${currentUser.uid}`), { theme: theme }).catch(e => console.error("Failed to save theme to DB:", e));
            }
        }

        async function loadUserTheme() {
            let savedTheme = localStorage.getItem('theme');
            if (currentUser && currentUser.uid) {
                const snapshot = await get(child(ref(db), `users/${currentUser.uid}/theme`));
                if (snapshot.exists()) {
                    savedTheme = snapshot.val();
                }
            }
            applyTheme(savedTheme || 'light'); // Default to light if no theme saved
        }

        lightThemeBtn.addEventListener('click', () => applyTheme('light'));
        darkThemeBtn.addEventListener('click', () => applyTheme('dark'));


        // --- Auth Functionality ---

        // Toggle between login and register forms
        toggleToRegister.addEventListener('click', () => {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        });

        toggleToLogin.addEventListener('click', () => {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        // Function to generate a memorable ID
        function generateMemorableId() {
            const randomNumber = Math.floor(1000 + Math.random() * 9000); // 4-digit number
            return `${randomNumber}ThunderChat`;
        }

        // Register User
        registerBtn.addEventListener('click', async () => {
            const email = regEmailInput.value;
            const password = regPasswordInput.value;
            const username = regUsernameInput.value;

            if (!email || !password || !username) {
                showAlert('Please fill in all registration fields.');
                return;
            }

            showLoading('Registering...');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const memorableId = generateMemorableId(); // Generate memorable ID

                // Store user data in Realtime Database
                await set(ref(db, `users/${user.uid}`), {
                    username: username,
                    email: email,
                    status: 'Online',
                    avatarUrl: '', // Default empty avatar URL
                    theme: 'light', // Default theme for new users
                    memorableId: memorableId // Store the memorable ID
                });

                // Immediately update the user ID display after successful registration
                userIdText.textContent = memorableId; 

                hideLoading();
                showAlert('Registration successful! You are now logged in.');
                // onAuthStateChanged will handle UI update
            } catch (error) {
                hideLoading();
                console.error("Error during registration:", error);
                showAlert(`Registration failed: ${error.message}`);
            }
        });

        // Login User
        loginBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            if (!email || !password) {
                showAlert('Please enter your email and password.');
                return;
            }

            showLoading('Logging in...');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideLoading();
                showAlert('Login successful!');
                // onAuthStateChanged will handle UI update
            } catch (error) {
                hideLoading();
                console.error("Error during login:", error);
                showAlert(`Login failed: ${error.message}`);
            }
        });

        // Auth state handler
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                showLoading('Loading your data...');
                const snapshot = await get(child(ref(db), `users/${user.uid}`));
                if (snapshot.exists()) {
                    currentUser = { ...user, ...snapshot.val() }; // Merge Firebase Auth user with Realtime DB data
                    userData = snapshot.val(); // Keep userData for other profile updates
                    hideLoading();
                    
                    authSection.style.display = 'none';
                    showSection('group-options'); // Show groups by default after login
                    usernameDisplay.textContent = currentUser.username;
                    
                    // Initialize sections after login
                    loadUserGroups();
                    loadUserContacts();
                    loadPosts(); // Load community posts after login
                    loadUserPostsForStudio(); // Load user's own posts for studio
                    loadUserProfile();
                    loadUserTheme(); // Re-load theme after user data is available
                } else {
                    // This case might happen if user registered but data wasn't saved (e.g., error)
                    hideLoading();
                    showAlert('User data not found in database. Please contact support or try registering again.');
                    signOut(auth); // Force logout if user data is missing
                }
            } else {
                hideLoading();
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                groupOptions.style.display = 'none';
                chatSection.style.display = 'none';
                contactsSection.style.display = 'none';
                privateChatSection.style.display = 'none';
                postsSection.style.display = 'none'; 
                postsStudioSection.style.display = 'none'; // Hide posts studio on logout
                settingsSection.style.display = 'none';
                // Reset current user info on logout
                currentUser = null;
                userData = {};
                userGroups = [];
                userContacts = [];
                allPosts = []; // Clear community posts on logout
                userPosts = []; // Clear user's own posts on logout
                applyTheme('light'); // Revert to default theme on logout
                showSection('auth-section'); // Show auth section by default when logged out
            }
        });


        // Tab switching
        function showSection(sectionId) {
            const sections = [authSection, groupOptions, chatSection, contactsSection, privateChatSection, postsSection, postsStudioSection, settingsSection];
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.style.display = 'flex';
                } else {
                    section.style.display = 'none';
                }
            });

            // Update active tab button
            const tabs = [groupsTab, contactsTab, postsTab, settingsTab];
            tabs.forEach(tab => {
                // Determine which tab should be active based on the sectionId
                if (sectionId === 'group-options' && tab.id === 'groups-tab') {
                    tab.classList.add('active');
                } else if (sectionId === 'contacts-section' && tab.id === 'contacts-tab') {
                    tab.classList.add('active');
                } else if (sectionId === 'posts-section' && tab.id === 'posts-tab') {
                    tab.classList.add('active');
                } else if (sectionId === 'settings-section' && tab.id === 'settings-tab') {
                    tab.classList.add('active');
                } else if (sectionId === 'posts-studio-section' && tab.id === 'settings-tab') {
                    // Posts Studio is accessed from Settings, so Settings tab should remain active
                    tab.classList.add('active');
                }
                else {
                    tab.classList.remove('active');
                }
            });
            // If auth-section or private-chat-section is shown, no main header tab should be active
            if (sectionId === 'auth-section' || sectionId === 'private-chat-section' || sectionId === 'chat-section') {
                tabs.forEach(tab => tab.classList.remove('active'));
            }
        }

        // Add event listeners for main navigation tabs
        groupsTab.addEventListener('click', () => showSection('group-options'));
        contactsTab.addEventListener('click', () => showSection('contacts-section'));
        postsTab.addEventListener('click', () => showSection('posts-section'));
        settingsTab.addEventListener('click', () => showSection('settings-section'));


        // Group settings
        groupSettingsBtn.addEventListener('click', () => {
            groupSettingsMenu.classList.add('open');
            loadGroupSettings();
        });

        closeGroupSettings.addEventListener('click', () => {
            groupSettingsMenu.classList.remove('open');
        });

        // Save profile
        saveProfileBtn.addEventListener('click', async () => {
            const username = document.getElementById('profile-username').value;
            const status = document.getElementById('profile-status').value;
            const avatarUrl = profileAvatarUrlInput.value.trim(); // Get URL from input
            
            showLoading('Saving profile...');
            try {
                await update(ref(db, `users/${currentUser.uid}`), {
                    username,
                    status,
                    avatarUrl // Use the URL directly
                });
                
                // Update local data and display
                userData = { ...userData, username, status, avatarUrl };
                currentUser.username = username; // Update currentUser's username
                usernameDisplay.textContent = username;
                
                hideLoading();
                showAlert('Profile saved successfully!');
                loadUserProfile(); // Reload profile to ensure avatar is updated
            } catch (error) {
                hideLoading();
                console.error("Error saving profile:", error);
                showAlert(`Failed to save profile: ${error.message}`);
            }
        });

        // Save group settings
        saveGroupSettingsBtn.addEventListener('click', async () => {
            const description = document.getElementById('group-desc-setting').value;
            const groupAvatarUrl = groupAvatarUrlInput.value.trim(); // Get URL from input
            
            showLoading('Saving group settings...');
            try {
                await update(ref(db, `groups/${currentGroup}`), {
                    description,
                    avatarUrl: groupAvatarUrl // Use the URL directly
                });
                
                hideLoading();
                groupSettingsMenu.classList.remove('open');
                showAlert('Group settings saved!');
                loadUserGroups(); // Reload groups to reflect changes
            } catch (error) {
                hideLoading();
                console.error("Error saving group settings:", error);
                showAlert(`Failed to save group settings: ${error.message}`);
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            showLoading('Logging out...');
            try {
                await signOut(auth);
                hideLoading();
                // The onAuthStateChanged listener will handle redirecting to auth section
            } catch (error) {
                hideLoading();
                console.error("Error during logout:", error);
                showAlert(`Logout failed: ${error.message}`);
            }
        });

        // Add contact
        addContactBtn.addEventListener('click', () => {
            const contactId = prompt("Enter the user's ID you want to add:");
            if (contactId) {
                if (contactId === currentUser.memorableId) { // Check against memorableId
                    showAlert("You can't add yourself as a contact!");
                } else {
                    addContact(contactId);
                }
            }
        });

        // Load user profile
        async function loadUserProfile() {
            if (!currentUser || !currentUser.uid) return;
            
            const snapshot = await get(child(ref(db), `users/${currentUser.uid}`));
            if (snapshot.exists()) {
                userData = snapshot.val();
                document.getElementById('profile-username').value = userData.username || '';
                document.getElementById('profile-status').value = userData.status || '';
                profileAvatarUrlInput.value = userData.avatarUrl || ''; // Populate URL input
                
                // Display the memorable ID if available, otherwise fallback to Firebase UID
                userIdText.textContent = userData.memorableId || currentUser.uid;
                
                if (userData.avatarUrl) {
                    profileAvatarPreview.innerHTML = `<img src="${userData.avatarUrl}" alt="Profile" onerror="this.onerror=null;this.src='https://placehold.co/140x140/00bcd4/ffffff?text=${userData.username?.charAt(0).toUpperCase() || 'U'}'" />`;
                    profileAvatarPreview.style.backgroundColor = 'transparent'; // Reset background for image
                    profileAvatarPreview.style.color = 'inherit';
                } else {
                    profileAvatarPreview.innerHTML = `<div>${userData.username?.charAt(0).toUpperCase() || 'U'}</div>`;
                    profileAvatarPreview.style.backgroundColor = 'var(--color-cyan-primary)'; // Fallback background
                    profileAvatarPreview.style.color = 'white';
                }
            }
        }

        // Load group settings
        async function loadGroupSettings() {
            if (!currentGroup) return;
            
            const snapshot = await get(child(ref(db), `groups/${currentGroup}`));
            if (snapshot.exists()) {
                const groupData = snapshot.val();
                document.getElementById('group-name-setting').value = currentGroup;
                document.getElementById('group-password-setting').value = groupData.password || 'No password set';
                document.getElementById('group-desc-setting').value = groupData.description || '';
                groupAvatarUrlInput.value = groupData.avatarUrl || ''; // Populate URL input
                
                if (groupData.avatarUrl) {
                    groupAvatarPreview.innerHTML = `<img src="${groupData.avatarUrl}" alt="Group" onerror="this.onerror=null;this.src='https://placehold.co/140x140/00bcd4/ffffff?text=${currentGroup.charAt(0).toUpperCase()}'" />`;
                    groupAvatarPreview.style.backgroundColor = 'transparent'; // Reset background for image
                    groupAvatarPreview.style.color = 'inherit';
                } else {
                    groupAvatarPreview.innerHTML = `<div>${currentGroup.charAt(0).toUpperCase()}</div>`;
                    groupAvatarPreview.style.backgroundColor = 'var(--color-cyan-primary)'; // Fallback background
                    groupAvatarPreview.style.color = 'white';
                }
            }
        }

        // Add contact function
        async function addContact(contactId) {
            showLoading('Adding contact...');
            
            // Check if user exists (by memorable ID or Firebase UID)
            let targetUserId = null;
            const usersRef = ref(db, 'users');
            const usersSnapshot = await get(usersRef);

            if (usersSnapshot.exists()) {
                usersSnapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    if (user.memorableId === contactId || childSnapshot.key === contactId) {
                        targetUserId = childSnapshot.key;
                        return true; // Break forEach loop
                    }
                });
            }

            if (!targetUserId) {
                hideLoading();
                showAlert('User not found!');
                return;
            }
            
            if (targetUserId === currentUser.uid) {
                hideLoading();
                showAlert("You can't add yourself as a contact!");
                return;
            }

            // Check if already in contacts
            const contactsSnapshot = await get(child(ref(db), `userContacts/${currentUser.uid}`));
            if (contactsSnapshot.exists() && contactsSnapshot.val()[targetUserId]) {
                hideLoading();
                showAlert('This user is already in your contacts!');
                return;
            }
            
            // Add to contacts
            await set(ref(db, `userContacts/${currentUser.uid}/${targetUserId}`), {
                addedAt: Date.now()
            });
            
            // Optionally, add reverse contact
            // This creates a mutual connection. Decide if this is desired behavior.
            await set(ref(db, `userContacts/${targetUserId}/${currentUser.uid}`), {
                addedAt: Date.now()
            });
            
            hideLoading();
            loadUserContacts();
            showAlert('Contact added successfully!');
        }

        // Load user contacts
        async function loadUserContacts() {
            if (!currentUser) return;
            
            try {
                const snapshot = await get(child(ref(db), `userContacts/${currentUser.uid}`));
                if (snapshot.exists()) {
                    const contacts = snapshot.val();
                    const contactIds = Object.keys(contacts);
                    
                    // Get details for each contact
                    userContacts = [];
                    for (const contactId of contactIds) {
                        const userSnapshot = await get(child(ref(db), `users/${contactId}`));
                        if (userSnapshot.exists()) {
                            userContacts.push({
                                id: contactId,
                                ...userSnapshot.val(),
                                ...contacts[contactId]
                            });
                        }
                    }
                    
                    renderContactsList();
                } else {
                    userContacts = [];
                    renderContactsList();
                }
            } catch (error) {
                console.error("Error loading contacts:", error);
                userContacts = [];
                renderContactsList();
            }
        }

        // Render contacts list
        function renderContactsList() {
            if (userContacts.length === 0) {
                contactsList.innerHTML = '<div class="no-contacts">You don\'t have any contacts yet</div>';
                return;
            }
            
            contactsList.innerHTML = userContacts.map(contact => `
                <div class="contact-item" data-contact="${contact.id}">
                    <div class="contact-avatar">
                        ${contact.avatarUrl ? 
                            `<img src="${contact.avatarUrl}" alt="${contact.username}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/00bcd4/ffffff?text=${contact.username?.charAt(0).toUpperCase() || 'U'}'" />` : 
                            `<div>${contact.username?.charAt(0).toUpperCase() || 'U'}</div>`}
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.username || 'Unknown User'}</div>
                        <div class="contact-status">${contact.status || 'No status'}</div>
                    </div>
                </div>
            `).join('');

            // Apply styles for fallback avatars (initials)
            document.querySelectorAll('.contact-avatar div').forEach(div => {
                div.style.backgroundColor = 'var(--color-cyan-primary)'; /* Use the primary cyan */
                div.style.color = 'white';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.fontSize = '1.8em'; /* Larger initials */
            });
            
            // Add click event to contacts
            document.querySelectorAll('.contact-item').forEach(item => {
                item.addEventListener('click', () => {
                    const contactId = item.getAttribute('data-contact');
                    const contact = userContacts.find(c => c.id === contactId);
                    if (contact) {
                        enterPrivateChat(contact);
                    }
                });
            });
        }

        // Enter private chat
        function enterPrivateChat(contact) {
            currentContact = contact.id;
            showSection('private-chat-section'); // Use showSection
            contactNameDisplay.textContent = contact.username || 'Unknown User';
            privateMessagesDiv.innerHTML = '';
            
            // Detach previous listener if exists
            if (currentPrivateChatUnsubscribe) {
                currentPrivateChatUnsubscribe(); // Call the unsubscribe function
                currentPrivateChatUnsubscribe = null;
            }

            const chatId = [currentUser.uid, contact.id].sort().join('_');
            const chatRef = ref(db, `privateMessages/${chatId}`);
            
            // Attach new listener and store its reference
            currentPrivateChatUnsubscribe = onChildAdded(chatRef, async (data) => {
                const msgData = data.val();
                const msg = document.createElement('div');
                msg.className = `message ${msgData.senderId === currentUser?.uid ? 'sent' : 'received'}`;
                
                // Fetch sender's username and avatar for display
                let senderUsername = 'Unknown';
                try {
                    const senderSnapshot = await get(child(ref(db), `users/${msgData.senderId}`));
                    if (senderSnapshot.exists()) {
                        const senderInfo = senderSnapshot.val();
                        senderUsername = senderInfo.username || 'Unknown';
                    }
                } catch (e) {
                    console.error("Error fetching sender info:", e);
                }

                msg.innerHTML = `
                    <div class="sender">${senderUsername}</div>
                    <div class="text">${msgData.text}</div>
                    <div class="timestamp">${formatTime(msgData.timestamp)}</div>
                `;
                
                privateMessagesDiv.appendChild(msg);
                privateMessagesDiv.scrollTop = privateMessagesDiv.scrollHeight;
            });
            console.log("Entered private chat with:", contact.username, "Private chat section display:", privateChatSection.style.display);
        }

        // Back button for private chat
        document.getElementById('back-private-btn').addEventListener('click', () => {
            showSection('contacts-section'); // Use showSection
            currentContact = "";
            // Detach the listener when leaving private chat
            if (currentPrivateChatUnsubscribe) {
                currentPrivateChatUnsubscribe(); // Call the unsubscribe function
                currentPrivateChatUnsubscribe = null;
            }
        });

        // Send private message
        document.getElementById('send-private-btn').addEventListener('click', sendPrivateMessage);
        document.getElementById('private-msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default Enter key behavior (e.g., new line in textarea)
                sendPrivateMessage();
            }
        });

        function sendPrivateMessage() {
            const input = document.getElementById('private-msg-input');
            const text = input.value.trim();
            
            if (text && currentContact && currentUser) {
                const chatId = [currentUser.uid, currentContact].sort().join('_');
                const chatRef = ref(db, `privateMessages/${chatId}`);
                
                push(chatRef, {
                    text: text,
                    sender: currentUser.username || currentUser.email,
                    senderId: currentUser.uid,
                    timestamp: Date.now()
                });
                
                input.value = "";
            }
        }


        // --- Group Functionality (Existing, slightly modified for clarity) ---

        // Create Group
        document.getElementById('create-group-btn').addEventListener('click', async () => {
            const groupName = prompt("Enter new group name:");
            if (!groupName) return;
            
            const groupPassword = prompt("Enter group password (optional):");

            showLoading('Creating group...');
            try {
                const groupRef = ref(db, `groups/${groupName}`);
                const snapshot = await get(groupRef);
                
                if (snapshot.exists()) {
                    showAlert('Group name already exists!');
                    hideLoading();
                    return;
                }
                
                await set(groupRef, {
                    name: groupName,
                    password: groupPassword || null,
                    createdAt: Date.now(),
                    admin: currentUser.uid,
                    description: '',
                    avatarUrl: ''
                });

                // Add user to group members
                await set(ref(db, `groupMembers/${groupName}/${currentUser.uid}`), {
                    joinedAt: Date.now()
                });

                // Add group to user's joined groups
                await set(ref(db, `userGroups/${currentUser.uid}/${groupName}`), {
                    joinedAt: Date.now()
                });

                hideLoading();
                showAlert('Group created and joined successfully!');
                loadUserGroups(); // Reload groups after creation
            } catch (error) {
                hideLoading();
                console.error("Error creating group:", error);
                showAlert(`Failed to create group: ${error.message}`);
            }
        });

        // Join New Group
        document.getElementById('join-group-btn').addEventListener('click', async () => {
            const groupName = prompt("Enter group name to join:");
            if (!groupName) return;
            
            showLoading('Joining group...');
            try {
                const groupRef = ref(db, `groups/${groupName}`);
                const snapshot = await get(groupRef);
                
                if (!snapshot.exists()) {
                    showAlert('Group does not exist!');
                    hideLoading();
                    return;
                }
                
                const groupData = snapshot.val();
                if (groupData.password) {
                    const enteredPassword = prompt("Enter group password:");
                    if (enteredPassword !== groupData.password) {
                        showAlert('Incorrect password!');
                        hideLoading();
                        return;
                    }
                }

                // Check if already a member
                const memberSnapshot = await get(child(ref(db), `groupMembers/${groupName}/${currentUser.uid}`));
                if (memberSnapshot.exists()) {
                    showAlert('You are already a member of this group!');
                    hideLoading();
                    return;
                }
                
                await set(ref(db, `groupMembers/${groupName}/${currentUser.uid}`), {
                    joinedAt: Date.now()
                });
                await set(ref(db, `userGroups/${currentUser.uid}/${groupName}`), {
                    joinedAt: Date.now()
                });
                
                hideLoading();
                showAlert('Joined group successfully!');
                loadUserGroups(); // Reload groups after joining
            } catch (error) {
                hideLoading();
                console.error("Error joining group:", error);
                showAlert(`Failed to join group: ${error.message}`);
            }
        });

        // Load User Groups
        async function loadUserGroups() {
            if (!currentUser) return;
            
            try {
                const snapshot = await get(child(ref(db), `userGroups/${currentUser.uid}`));
                if (snapshot.exists()) {
                    const groups = snapshot.val();
                    const groupNames = Object.keys(groups);
                    userGroups = [];
                    for (const groupName of groupNames) {
                        const groupSnapshot = await get(child(ref(db), `groups/${groupName}`));
                        if (groupSnapshot.exists()) {
                            userGroups.push({
                                id: groupName,
                                ...groupSnapshot.val()
                            });
                        }
                    }
                    renderGroupsList();
                } else {
                    userGroups = [];
                    renderGroupsList();
                }
            } catch (error) {
                console.error("Error loading groups:", error);
                userGroups = [];
                renderGroupsList();
            }
        }

        // Render Groups List
        function renderGroupsList() {
            groupsCount.textContent = userGroups.length;
            if (userGroups.length === 0) {
                joinedGroupsList.innerHTML = '<div class="no-groups">You haven\'t joined any groups yet</div>';
                return;
            }
            
            joinedGroupsList.innerHTML = userGroups.map(group => `
                <div class="group-item" data-group="${group.id}">
                    <div class="group-avatar">
                        ${group.avatarUrl ? 
                            `<img src="${group.avatarUrl}" alt="${group.name}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/00bcd4/ffffff?text=${group.name.charAt(0).toUpperCase()}'" />` : 
                            `<div>${group.name.charAt(0).toUpperCase()}</div>`}
                    </div>
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-desc">${group.description || 'No description'}</div>
                    </div>
                </div>
            `).join('');

            // Apply styles for fallback avatars (initials)
            document.querySelectorAll('.group-avatar div').forEach(div => {
                div.style.backgroundColor = 'var(--color-cyan-primary)'; /* Use the primary cyan */
                div.style.color = 'white';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.fontSize = '1.8em'; /* Larger initials */
            });

            // Add click event to each group item
            document.querySelectorAll('.group-item').forEach(item => {
                item.addEventListener('click', () => {
                    const groupId = item.getAttribute('data-group');
                    enterGroupChat(groupId);
                });
            });
        }

        // Enter Group Chat
        function enterGroupChat(groupId) {
            currentGroup = groupId;
            showSection('chat-section'); // Use showSection
            groupNameDisplay.textContent = groupId;
            messagesDiv.innerHTML = ''; // Clear previous messages
            
            // Detach previous listener if exists
            if (currentGroupChatUnsubscribe) {
                currentGroupChatUnsubscribe(); // Call the unsubscribe function
                currentGroupChatUnsubscribe = null;
            }

            const messagesRef = ref(db, `groupMessages/${groupId}`);
            
            // Attach new listener and store its reference
            currentGroupChatUnsubscribe = onChildAdded(messagesRef, async (data) => {
                const msgData = data.val();
                const msg = document.createElement('div');
                msg.className = `message ${msgData.senderId === currentUser?.uid ? 'sent' : 'received'}`;
                
                // Fetch sender's username and avatar for display
                let senderUsername = 'Unknown';
                try {
                    const senderSnapshot = await get(child(ref(db), `users/${msgData.senderId}`));
                    if (senderSnapshot.exists()) {
                        const senderInfo = senderSnapshot.val();
                        senderUsername = senderInfo.username || 'Unknown';
                    }
                } catch (e) {
                    console.error("Error fetching sender info:", e);
                }

                msg.innerHTML = `
                    <div class="sender">${senderUsername}</div>
                    <div class="text">${msgData.text}</div>
                    <div class="timestamp">${formatTime(msgData.timestamp)}</div>
                `;
                
                messagesDiv.appendChild(msg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // Back button for group chat
        document.getElementById('back-btn').addEventListener('click', () => {
            showSection('group-options'); // Use showSection
            currentGroup = "";
            // Detach the listener when leaving group chat
            if (currentGroupChatUnsubscribe) {
                currentGroupChatUnsubscribe(); // Call the unsubscribe function
                currentGroupChatUnsubscribe = null;
            }
        });

        // Send Group Message
        document.getElementById('send-btn').addEventListener('click', sendGroupMessage);
        document.getElementById('msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default Enter key behavior
                sendGroupMessage();
            }
        });

        function sendGroupMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            
            if (text && currentGroup && currentUser) {
                const messagesRef = ref(db, `groupMessages/${currentGroup}`);
                push(messagesRef, {
                    text: text,
                    sender: currentUser.username || currentUser.email, // Use username from updated currentUser
                    senderId: currentUser.uid,
                    timestamp: Date.now()
                });
                input.value = "";
            }
        }

        // --- Community Posts Functionality ---

        // Open Create Post Modal
        createPostBtn.addEventListener('click', () => {
            if (!currentUser) {
                showAlert("Please log in to create a post.");
                return;
            }
            createPostModal.style.display = 'flex';
            postImageUrlInput.value = '';
            postDescriptionInput.value = '';
            postTemplateSelect.value = ''; // Reset template selection
            emojiInput.value = ''; // Reset emoji input
        });

        // Close Create Post Modal
        closeCreatePostModal.addEventListener('click', () => {
            createPostModal.style.display = 'none';
        });

        // Handle Template Selection
        postTemplateSelect.addEventListener('change', () => {
            const selectedTemplate = postTemplateSelect.value;
            switch (selectedTemplate) {
                case 'announcement':
                    postImageUrlInput.value = 'https://placehold.co/600x300/00bcd4/ffffff?text=Announcement';
                    postDescriptionInput.value = 'Important Announcement: [Your message here]';
                    break;
                case 'inspiration':
                    postImageUrlInput.value = 'https://placehold.co/600x300/80deea/263238?text=Inspiration';
                    postDescriptionInput.value = 'Daily Dose of Inspiration: "The only way to do great work is to love what you do." - Steve Jobs ‚ú®';
                    break;
                case 'question':
                    postImageUrlInput.value = 'https://placehold.co/600x300/e0f7fa/00838f?text=Question';
                    postDescriptionInput.value = 'Question of the Day: What\'s your favorite book and why? ÔøΩ';
                    break;
                case 'sale':
                    postImageUrlInput.value = 'https://placehold.co/600x300/ffcc80/263238?text=Item+for+Sale';
                    postDescriptionInput.value = 'For Sale: [Item Name] - [Price]. DM me for details! üí∏';
                    break;
                default:
                    postImageUrlInput.value = '';
                    postDescriptionInput.value = '';
                    break;
            }
        });

        // Add Emoji to Post Description
        addEmojiBtn.addEventListener('click', () => {
            const emoji = emojiInput.value.trim();
            if (emoji) {
                postDescriptionInput.value += ` ${emoji}`; // Append emoji to description
                emojiInput.value = ''; // Clear emoji input
            }
        });

        // Submit New Post
        submitPostBtn.addEventListener('click', async () => {
            const imageUrl = postImageUrlInput.value.trim();
            const description = postDescriptionInput.value.trim();

            if (!imageUrl && !description) {
                showAlert('Please provide an image URL or a description for your post.');
                return;
            }

            if (!currentUser) {
                showAlert("You must be logged in to create a post.");
                return;
            }

            const MAX_POST_CHARS = 7500;
            if (description.length > MAX_POST_CHARS) {
                showAlert(`Post content cannot exceed ${MAX_POST_CHARS} characters.`);
                return;
            }

            showLoading('Creating post...');
            try {
                const newPostRef = push(ref(db, 'posts'));
                await set(newPostRef, {
                    userId: currentUser.uid,
                    username: currentUser.username || 'Anonymous',
                    avatarUrl: currentUser.avatarUrl || '',
                    imageUrl: imageUrl,
                    description: description,
                    timestamp: Date.now(),
                    likes: {},
                    comments: {}
                });
                hideLoading();
                createPostModal.style.display = 'none';
                showAlert('Post created successfully!');
                loadPosts(); // Reload community posts to show the new one
                loadUserPostsForStudio(); // Also reload user's posts for the studio
            } catch (error) {
                hideLoading();
                console.error("Error creating post:", error);
                showAlert(`Failed to create post: ${error.message}`);
            }
        });

        // Load Community Posts
        function loadPosts() {
            if (!currentUser) return;

            // Detach previous listener if exists
            if (currentCommunityPostsUnsubscribe) {
                currentCommunityPostsUnsubscribe();
                currentCommunityPostsUnsubscribe = null;
            }

            const postsRef = ref(db, 'posts');
            currentCommunityPostsUnsubscribe = onValue(postsRef, (snapshot) => {
                allPosts = [];
                snapshot.forEach((childSnapshot) => {
                    allPosts.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                renderPosts(); // Render community posts whenever data changes
            }, (error) => {
                console.error("Error loading community posts:", error);
                showAlert("Failed to load community posts.");
                allPosts = [];
                renderPosts();
            });
        }

        // Render Community Posts
        function renderPosts() {
            let postsToDisplay = [...allPosts]; // Create a copy to sort

            if (currentPostCategory === 'new') {
                postsToDisplay.sort((a, b) => b.timestamp - a.timestamp); // Latest first
            } else if (currentPostCategory === 'trending') {
                postsToDisplay.sort((a, b) => {
                    const likesA = Object.keys(a.likes || {}).length;
                    const likesB = Object.keys(b.likes || {}).length;
                    return likesB - likesA; // Most likes first
                });
            }

            if (postsToDisplay.length === 0) {
                postsContainer.innerHTML = '<div class="no-posts">No posts available yet. Be the first to share!</div>';
                return;
            }

            postsContainer.innerHTML = postsToDisplay.map(post => {
                const likeCount = Object.keys(post.likes || {}).length;
                const isLiked = post.likes && post.likes[currentUser?.uid];
                const commentsHtml = post.comments ? Object.values(post.comments).map(comment => `
                    <div class="comment-item">
                        <span class="comment-author">${comment.username || 'Anonymous'}:</span>
                        <span class="comment-text">${comment.text}</span>
                        <div class="comment-timestamp">${formatTime(comment.timestamp)}</div>
                    </div>
                `).join('') : '';

                const originalDescription = post.description || '';
                const TRUNCATE_LENGTH = 300; // Characters for "show less"
                let displayDescription = originalDescription;
                let showMoreLessButton = '';

                if (originalDescription.length > TRUNCATE_LENGTH) {
                    displayDescription = originalDescription.substring(0, TRUNCATE_LENGTH) + '...';
                    showMoreLessButton = `
                        <button class="show-more-less-btn secondary" data-post-id="${post.id}" data-action="show-more">Show More</button>
                    `;
                }

                return `
                    <div class="post-item" data-post-id="${post.id}">
                        <div class="post-header">
                            <div class="post-avatar">
                                ${post.avatarUrl ? 
                                    `<img src="${post.avatarUrl}" alt="${post.username}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/00bcd4/ffffff?text=${post.username?.charAt(0).toUpperCase() || 'U'}'" />` : 
                                    `<div>${post.username?.charAt(0).toUpperCase() || 'U'}</div>`}
                            </div>
                            <div class="post-username">${post.username || 'Anonymous'}</div>
                            <div class="post-timestamp">${formatTime(post.timestamp)}</div>
                        </div>
                        ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" class="post-image" onerror="this.onerror=null;this.style.display='none';">` : ''}
                        <p class="post-description" data-full-text="${originalDescription}" data-truncated-text="${displayDescription}">
                            ${displayDescription}
                        </p>
                        ${showMoreLessButton}
                        <div class="post-actions">
                            <button class="like-btn ${isLiked ? 'liked' : ''}" data-post-id="${post.id}">Like</button>
                            <span class="like-count">${likeCount} Likes</span>
                        </div>
                        <div class="comment-section">
                            <div class="comment-input-group">
                                <input type="text" class="comment-input" placeholder="Add a comment..." data-post-id="${post.id}" />
                                <button class="send-comment-btn" data-post-id="${post.id}">Send</button>
                            </div>
                            <div class="comment-list">
                                ${commentsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Re-attach event listeners for dynamic content
            document.querySelectorAll('.like-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    toggleLike(postId);
                });
            });

            document.querySelectorAll('.send-comment-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    const input = e.currentTarget.previousElementSibling;
                    addComment(postId, input.value);
                    input.value = '';
                });
            });

            document.querySelectorAll('.comment-input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const postId = e.currentTarget.getAttribute('data-post-id');
                        addComment(postId, e.currentTarget.value);
                        e.currentTarget.value = '';
                    }
                });
            });

            document.querySelectorAll('.show-more-less-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    togglePostDescription(postId, e.currentTarget);
                });
            });

            // Apply styles for fallback avatars (initials) for posts
            document.querySelectorAll('.post-avatar div').forEach(div => {
                div.style.backgroundColor = 'var(--color-cyan-primary)'; /* Use the primary cyan */
                div.style.color = 'white';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.fontSize = '1.5em'; /* Larger initials for posts */
            });
        }

        // Toggle Like on a Post
        async function toggleLike(postId) {
            if (!currentUser) {
                showAlert("You must be logged in to like posts.");
                return;
            }
            const postRef = ref(db, `posts/${postId}/likes/${currentUser.uid}`);
            const snapshot = await get(postRef);

            if (snapshot.exists()) {
                // User already liked, so unlike
                await set(postRef, null); // Remove the like
            } else {
                // User hasn't liked, so like
                await set(postRef, true);
            }
            // loadPosts() will automatically re-render with updated like count
        }

        // Add Comment to a Post
        async function addComment(postId, commentText) {
            const trimmedComment = commentText.trim();
            if (!trimmedComment) {
                showAlert("Comment cannot be empty.");
                return;
            }
            if (!currentUser) {
                showAlert("You must be logged in to comment.");
                return;
            }

            const commentsRef = ref(db, `posts/${postId}/comments`);
            await push(commentsRef, {
                userId: currentUser.uid,
                username: currentUser.username || 'Anonymous',
                text: trimmedComment,
                timestamp: Date.now()
            });
            // loadPosts() will automatically re-render with new comment
        }

        // Toggle Post Description (Show More/Less)
        function togglePostDescription(postId, buttonElement) {
            const postItem = document.querySelector(`.post-item[data-post-id="${postId}"]`);
            const descriptionElement = postItem.querySelector('.post-description');
            
            const fullText = descriptionElement.getAttribute('data-full-text');
            const truncatedText = descriptionElement.getAttribute('data-truncated-text');

            if (buttonElement.getAttribute('data-action') === 'show-more') {
                descriptionElement.textContent = fullText;
                buttonElement.textContent = 'Show Less';
                buttonElement.setAttribute('data-action', 'show-less');
            } else {
                descriptionElement.textContent = truncatedText;
                buttonElement.textContent = 'Show More';
                buttonElement.setAttribute('data-action', 'show-more');
            }
        }

        // Event listeners for post categories
        newPostsBtn.addEventListener('click', () => {
            currentPostCategory = 'new';
            newPostsBtn.classList.add('active');
            trendingPostsBtn.classList.remove('active');
            renderPosts();
        });

        trendingPostsBtn.addEventListener('click', () => {
            currentPostCategory = 'trending';
            trendingPostsBtn.classList.add('active');
            newPostsBtn.classList.remove('active');
            renderPosts();
        });

        // --- Posts Studio Functionality ---

        // Add event listener for Posts Studio button
        postsStudioBtn.addEventListener('click', () => {
            showSection('posts-studio-section');
        });

        // Add event listener for back to settings button in Posts Studio
        backToSettingsBtn.addEventListener('click', () => {
            showSection('settings-section');
        });

        // Load User's Posts for Studio
        function loadUserPostsForStudio() {
            if (!currentUser) return;

            // Detach previous listener if exists
            if (currentUserPostsUnsubscribe) {
                currentUserPostsUnsubscribe();
                currentUserPostsUnsubscribe = null;
            }

            const postsRef = ref(db, 'posts');
            currentUserPostsUnsubscribe = onValue(postsRef, async (snapshot) => {
                userPosts = [];
                let totalLikes = 0;
                let totalComments = 0;

                // Fetch pinned post ID from user data
                let pinnedPostId = null;
                const userSnapshot = await get(child(ref(db), `users/${currentUser.uid}/pinnedPostId`));
                if (userSnapshot.exists()) {
                    pinnedPostId = userSnapshot.val();
                }

                snapshot.forEach((childSnapshot) => {
                    const post = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    if (post.userId === currentUser.uid) {
                        userPosts.push(post);
                        totalLikes += Object.keys(post.likes || {}).length;
                        totalComments += Object.keys(post.comments || {}).length;
                    }
                });
                
                totalPostsCountSpan.textContent = userPosts.length;
                totalLikesReceivedSpan.textContent = totalLikes;
                totalCommentsReceivedSpan.textContent = totalComments;

                renderUserPostsForStudio(pinnedPostId); // Pass pinnedPostId to render function
            }, (error) => {
                console.error("Error loading user posts for studio:", error);
                showAlert("Failed to load your posts for the studio.");
                userPosts = [];
                renderUserPostsForStudio(null);
            });
        }

        // Render User's Posts for Studio
        function renderUserPostsForStudio(pinnedPostId) {
            let postsToDisplay = [...userPosts]; // Create a copy to sort and filter

            // Filter by search term
            const searchTerm = postStudioSearchInput.value.toLowerCase();
            if (searchTerm) {
                postsToDisplay = postsToDisplay.filter(post => 
                    (post.description && post.description.toLowerCase().includes(searchTerm)) ||
                    (post.imageUrl && post.imageUrl.toLowerCase().includes(searchTerm))
                );
            }

            // Sort based on selected option
            const sortOption = postStudioSortSelect.value;
            if (sortOption === 'newest') {
                postsToDisplay.sort((a, b) => b.timestamp - a.timestamp);
            } else if (sortOption === 'oldest') {
                postsToDisplay.sort((a, b) => a.timestamp - b.timestamp);
            } else if (sortOption === 'most-likes') {
                postsToDisplay.sort((a, b) => {
                    const likesA = Object.keys(a.likes || {}).length;
                    const likesB = Object.keys(b.likes || {}).length;
                    return likesB - likesA;
                });
            } else if (sortOption === 'most-comments') {
                postsToDisplay.sort((a, b) => {
                    const commentsA = Object.keys(a.comments || {}).length;
                    const commentsB = Object.keys(b.comments || {}).length;
                    return commentsB - commentsA;
                });
            }

            // Move pinned post to the top if it exists and is in the filtered/sorted list
            if (pinnedPostId) {
                const pinnedPostIndex = postsToDisplay.findIndex(post => post.id === pinnedPostId);
                if (pinnedPostIndex !== -1) {
                    const pinnedPost = postsToDisplay.splice(pinnedPostIndex, 1)[0];
                    postsToDisplay.unshift(pinnedPost); // Add to the beginning
                }
            }

            if (postsToDisplay.length === 0) {
                userPostsList.innerHTML = '<div class="no-user-posts">You haven\'t uploaded any posts yet.</div>';
                return;
            }

            userPostsList.innerHTML = `<h3>Your Uploaded Posts</h3>` + postsToDisplay.map(post => `
                <div class="user-post-item" data-post-id="${post.id}">
                    <div class="post-header">
                        <div class="post-avatar">
                            ${post.avatarUrl ? 
                                `<img src="${post.avatarUrl}" alt="${post.username}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/00bcd4/ffffff?text=${post.username?.charAt(0).toUpperCase() || 'U'}'" />` : 
                                `<div>${post.username?.charAt(0).toUpperCase() || 'U'}</div>`}
                        </div>
                        <div class="post-username">${post.username || 'Anonymous'} ${post.id === pinnedPostId ? 'üìå' : ''}</div>
                        <div class="post-timestamp">${formatTime(post.timestamp)}</div>
                    </div>
                    ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" class="post-image" onerror="this.onerror=null;this.style.display='none';">` : ''}
                    <p class="post-description">${post.description || ''}</p>
                    <div class="user-post-actions">
                        <button class="edit-btn" data-post-id="${post.id}">Edit</button>
                        <button class="delete-btn" data-post-id="${post.id}">Delete</button>
                        <button class="pin-btn ${post.id === pinnedPostId ? 'pinned' : ''}" data-post-id="${post.id}">${post.id === pinnedPostId ? 'Unpin' : 'Pin'}</button>
                        <button class="share-btn" data-post-id="${post.id}">Share</button>
                    </div>
                </div>
            `).join('');

            // Apply styles for fallback avatars (initials) for posts
            document.querySelectorAll('.user-post-item .post-avatar div').forEach(div => {
                div.style.backgroundColor = 'var(--color-cyan-primary)';
                div.style.color = 'white';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.fontSize = '1.5em';
            });

            // Attach event listeners for edit and delete buttons
            document.querySelectorAll('.user-post-item .edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    const postToEdit = userPosts.find(p => p.id === postId);
                    if (postToEdit) {
                        openEditPostModal(postToEdit);
                    }
                });
            });

            document.querySelectorAll('.user-post-item .delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    deletePost(postId);
                });
            });

            document.querySelectorAll('.user-post-item .pin-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    togglePinPost(postId);
                });
            });

            document.querySelectorAll('.user-post-item .share-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    copyPostLink(postId);
                });
            });
        }

        // Event listeners for Posts Studio controls
        postStudioSearchInput.addEventListener('input', () => renderUserPostsForStudio(userData.pinnedPostId));
        postStudioSortSelect.addEventListener('change', () => renderUserPostsForStudio(userData.pinnedPostId));

        // Toggle Pin Post
        async function togglePinPost(postId) {
            if (!currentUser) {
                showAlert("You must be logged in to pin posts.");
                return;
            }

            showLoading('Updating pin status...');
            try {
                const userRef = ref(db, `users/${currentUser.uid}`);
                const currentPinnedId = userData.pinnedPostId;

                if (currentPinnedId === postId) {
                    // Unpin the post
                    await update(userRef, { pinnedPostId: null });
                    userData.pinnedPostId = null;
                    showAlert('Post unpinned successfully!');
                } else {
                    // Pin the new post
                    await update(userRef, { pinnedPostId: postId });
                    userData.pinnedPostId = postId;
                    showAlert('Post pinned successfully!');
                }
                loadUserPostsForStudio(); // Re-render to reflect changes
            } catch (error) {
                console.error("Error toggling pin status:", error);
                showAlert(`Failed to update pin status: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Copy Post Link to Clipboard
        function copyPostLink(postId) {
            // In a real application, this would be a public URL to the post.
            // For this demo, we'll create a dummy link.
            const dummyLink = `https://thunderchat.app/posts/${postId}`;
            
            // Use document.execCommand('copy') for better iframe compatibility
            const tempInput = document.createElement('textarea');
            tempInput.value = dummyLink;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showAlert('Post link copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showAlert('Failed to copy link. Please try manually: ' + dummyLink);
            }
            document.body.removeChild(tempInput);
        }

        // Open Edit Post Modal
        function openEditPostModal(post) {
            editingPostId = post.id;
            editPostImageUrlInput.value = post.imageUrl || '';
            editPostDescriptionInput.value = post.description || '';
            editPostModal.style.display = 'flex';
        }

        // Close Edit Post Modal
        closeEditPostModal.addEventListener('click', () => {
            editPostModal.style.display = 'none';
            editingPostId = null;
        });

        // Add Emoji to Edit Post Description
        addEditEmojiBtn.addEventListener('click', () => {
            const emoji = editEmojiInput.value.trim();
            if (emoji) {
                editPostDescriptionInput.value += ` ${emoji}`;
                editEmojiInput.value = '';
            }
        });

        // Save Edited Post
        saveEditedPostBtn.addEventListener('click', async () => {
            if (!editingPostId) return;

            const newImageUrl = editPostImageUrlInput.value.trim();
            const newDescription = editPostDescriptionInput.value.trim();

            if (!newImageUrl && !newDescription) {
                showAlert('Please provide an image URL or a description for your post.');
                return;
            }

            const MAX_POST_CHARS = 7500;
            if (newDescription.length > MAX_POST_CHARS) {
                showAlert(`Post content cannot exceed ${MAX_POST_CHARS} characters.`);
                return;
            }

            showLoading('Saving changes...');
            try {
                await update(ref(db, `posts/${editingPostId}`), {
                    imageUrl: newImageUrl,
                    description: newDescription,
                    lastEdited: Date.now() // Add a last edited timestamp
                });
                hideLoading();
                editPostModal.style.display = 'none';
                showAlert('Post updated successfully!');
                // loadUserPostsForStudio() will be triggered by the onValue listener
                // loadPosts() will also be triggered for community view
            } catch (error) {
                hideLoading();
                console.error("Error saving edited post:", error);
                showAlert(`Failed to save changes: ${error.message}`);
            } finally {
                editingPostId = null;
            }
        });

        // Delete Post
        async function deletePost(postId) {
            // Using custom alert modal instead of confirm()
            customAlertMessage.innerHTML = 'Are you sure you want to delete this post? This action cannot be undone.';
            customAlertOkBtn.textContent = 'Yes, Delete';
            customAlertOkBtn.classList.add('delete-confirm-btn'); // Add a class to distinguish
            customAlertModal.style.display = 'flex';

            // Temporarily store original click handlers
            const originalOkBtnClickListener = customAlertOkBtn.onclick;
            const originalCloseBtnClickListener = closeAlertBtn.onclick;

            // Override OK button for delete confirmation
            customAlertOkBtn.onclick = async () => {
                hideAlert();
                showLoading('Deleting post...');
                try {
                    await remove(ref(db, `posts/${postId}`));
                    hideLoading();
                    showAlert('Post deleted successfully!');
                } catch (error) {
                    hideLoading();
                    console.error("Error deleting post:", error);
                    showAlert(`Failed to delete post: ${error.message}`);
                } finally {
                    // Restore original click handlers after operation
                    customAlertOkBtn.onclick = originalOkBtnClickListener;
                    customAlertOkBtn.classList.remove('delete-confirm-btn');
                    closeAlertBtn.onclick = originalCloseBtnClickListener;
                }
            };
            // Override Close button to just hide and restore original handlers
            closeAlertBtn.onclick = () => {
                hideAlert();
                customAlertOkBtn.onclick = originalOkBtnClickListener;
                customAlertOkBtn.classList.remove('delete-confirm-btn');
                closeAlertBtn.onclick = originalCloseBtnClickListener;
            };
        }


        // Helper functions
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();

            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            const diffWeeks = Math.floor(diffDays / 7);
            const diffMonths = Math.floor(diffDays / 30);
            const diffYears = Math.floor(diffDays / 365);

            if (diffSeconds < 60) {
                return `${diffSeconds}s ago`;
            } else if (diffMinutes < 60) {
                return `${diffMinutes}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            } else if (diffWeeks < 4) {
                return `${diffWeeks}w ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
        }
        function showLoading(message = 'Loading...') {
            loadingScreen.style.display = 'flex';
            loadingScreen.querySelector('.loading-text').textContent = message;
        }

        function hideLoading() {
            loadingScreen.style.display = 'none';
        }
                // --- START OF NEW CODE FOR CALLS BUTTON ---

        // Get a reference to the new Calls button
        const callsTab = document.getElementById('calls-tab');

        // Add event listener for the Calls button
        // This will redirect the entire page to calls.html
        callsTab.addEventListener('click', () => {
            window.location.href = 'calls.html'; 
        });

        // Optionally, if you want the "Calls" tab to appear active when on calls.html
        // (This would require calls.html to set a flag or for index.html to check URL)
        // For a simple redirect, this isn't strictly necessary, but good for completeness
        // if you ever switch to a more complex SPA routing.
        // For now, it will just redirect.

        // --- END OF NEW CODE FOR CALLS BUTTON ---

    </script>
</body>
</html>
ÔøΩ
