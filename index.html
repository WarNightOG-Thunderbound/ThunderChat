<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ThunderChat</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        /* CSS Variables for Theming */
        :root { /* Light theme variables */
            --bg-body: linear-gradient(135deg, #f0f8ff 0%, #e0f7fa 100%);
            --color-text-primary: #263238;
            --color-text-secondary: #78909c;
            --color-cyan-dark: #00838f;
            --color-cyan-primary: #00bcd4;
            --color-cyan-light: #80deea;
            --color-cyan-gradient-start: #00bcd4;
            --color-cyan-gradient-end: #00acc1;
            --color-white: #ffffff;
            --color-light-blue-bg: #f5faff;
            --color-border-light: #e0f2f7;
            --color-input-border: #b0bec5;
            --color-input-focus-bg: #f5feff;
            --color-modal-bg: #fefefe;
            --shadow-light: rgba(0,0,0,0.15);
            --shadow-medium: rgba(0,0,0,0.25);
            --shadow-strong: rgba(0, 188, 212, 0.4);
        }

        body.dark-theme { /* Dark theme overrides */
            --bg-body: linear-gradient(135deg, #263238 0%, #1a2226 100%); /* Dark grey to black */
            --color-text-primary: #e0f7fa; /* Light cyan text */
            --color-text-secondary: #a7b9c2; /* Lighter grey */
            --color-cyan-dark: #4dd0e1; /* Lighter cyan */
            --color-cyan-primary: #00bcd4;
            --color-cyan-light: #80deea;
            --color-cyan-gradient-start: #00838f; /* Darker cyan gradient */
            --color-cyan-gradient-end: #00bcd4;
            --color-white: #37474f; /* Darker white for elements */
            --color-light-blue-bg: #37474f; /* Dark background for items */
            --color-border-light: #455a64; /* Darker border */
            --color-input-border: #546e7a;
            --color-input-focus-bg: #2d3b42;
            --color-modal-bg: #2d3b42;
            --shadow-light: rgba(0,0,0,0.4);
            --shadow-medium: rgba(0,0,0,0.5);
            --shadow-strong: rgba(0, 188, 212, 0.6);
        }

        /* Universal box-sizing for consistent layout and base font */
        * {
            box-sizing: border-box;
            font-size: 18px; /* Base font size for readability */
            -webkit-font-smoothing: antialiased; /* Smoother fonts for Webkit browsers */
            -moz-osx-font-smoothing: grayscale; /* Smoother fonts for Firefox */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif; /* Modern, clean font */
            background: var(--bg-body); /* Use CSS variable */
            color: var(--color-text-primary); /* Use CSS variable */
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensure full viewport height */
            width: 100%; /* Ensure full width */
            overflow-x: hidden; /* Prevent horizontal scrolling */
            transition: background 0.5s ease; /* Smooth transition for background changes */
        }

        /* Header Styling */
        header {
            padding: 1.5em 1em; /* Generous padding */
            background: linear-gradient(90deg, var(--color-cyan-gradient-start) 0%, var(--color-cyan-gradient-end) 100%); /* Use CSS variables */
            color: white;
            text-align: center;
            box-shadow: 0 8px 20px var(--shadow-strong); /* Strong, vibrant shadow */
            border-bottom-left-radius: 30px; /* Very rounded bottom corners */
            border-bottom-right-radius: 30px;
            position: relative;
            z-index: 20;
            overflow: hidden; /* Hide overflow for pseudo-elements */
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            opacity: 0.3;
            animation: headerGlow 10s infinite linear; /* Subtle background animation */
        }

        @keyframes headerGlow {
            0% { transform: rotate(0deg); opacity: 0.3; }
            50% { transform: rotate(180deg); opacity: 0.5; }
            100% { transform: rotate(360deg); opacity: 0.3; }
        }

        header h1 {
            font-size: 3em; /* Super large title */
            margin: 0;
            font-weight: 800; /* Extra bold */
            text-shadow: 2px 2px 5px rgba(0,0,0,0.2); /* Stronger text shadow */
            letter-spacing: 0.08em; /* More spaced out letters */
        }

        /* Header Tabs */
        .header-tabs {
            display: flex;
            justify-content: center;
            margin-top: 1.5em; /* More space below title */
            gap: 1.2em; /* Increased space between tabs */
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        }

        .tab-btn {
            background: rgba(255,255,255,0.15); /* Slightly less transparent */
            border: 2px solid rgba(255,255,255,0.5); /* More prominent border */
            color: white;
            padding: 0.8em 1.8em; /* More padding */
            font-size: 1.1em; /* Slightly larger font */
            cursor: pointer;
            border-radius: 30px; /* Very rounded */
            transition: all 0.3s ease-in-out; /* Smooth transitions */
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            backdrop-filter: blur(5px); /* Frosted glass effect */
            flex-grow: 1; /* Allow buttons to grow */
            max-width: 180px; /* Limit max width for tabs */
            text-align: center;
        }

        .tab-btn.active {
            background: rgba(255,255,255,0.4); /* More opaque when active */
            box-shadow: 0 6px 15px var(--shadow-strong); /* Stronger shadow for active */
            transform: translateY(-4px); /* More pronounced lift */
            border-color: white; /* Solid white border for active */
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Main Content Area */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 2em; /* Increased padding */
            width: 100%;
            display: flex; /* Use flex for centering content */
            justify-content: center;
            align-items: flex-start; /* Align items to the top within main */
        }

        /* Footer Styling */
        footer {
            padding: 1.2em; /* More padding */
            background: var(--color-white); /* Use CSS variable */
            border-top: 3px solid var(--color-border-light); /* Use CSS variable */
            border-top-left-radius: 25px; /* More rounded corners */
            border-top-right-radius: 25px;
            box-shadow: 0 -8px 20px var(--shadow-light); /* Stronger shadow */
            display: flex;
            gap: 0.8em; /* More space between input and button */
            align-items: center;
            position: relative; /* For z-index */
            z-index: 10;
            flex-wrap: wrap; /* Allow footer elements to wrap */
            width: 100%; /* Ensure footer takes full width */
        }

        /* Message Bubbles */
        .message {
            margin: 1em 0; /* More vertical space */
            padding: 1.2em 1.5em; /* Generous padding */
            background: var(--color-white); /* Use CSS variable */
            border-radius: 22px; /* Super rounded */
            box-shadow: 0 4px 12px var(--shadow-light); /* Deeper shadow */
            max-width: 90%; /* Wider messages */
            word-wrap: break-word;
            transform: translateY(30px); /* Start further down */
            opacity: 0;
            animation: messageAppear 0.5s ease-out forwards; /* Slower, smoother animation */
            position: relative;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Message bubble corners */
        .message::before {
            content: '';
            position: absolute;
            bottom: 0;
            width: 0;
            height: 0;
            border: 10px solid transparent;
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(to right, var(--color-cyan-light), var(--color-cyan-primary)); /* Vibrant light cyan gradient */
            color: var(--color-text-primary); /* Ensure text is readable */
            border-bottom-right-radius: 8px; /* Pointed corner */
            margin-right: 10px; /* Space from edge */
        }

        .message.sent::before {
            border-bottom-right-radius: 8px;
            right: -10px;
            border-left-color: var(--color-cyan-primary); /* Match gradient end color */
            border-bottom-color: var(--color-cyan-primary);
        }

        .message.received {
            align-self: flex-start;
            background: var(--color-white); /* Use CSS variable */
            border: 1px solid var(--color-border-light); /* Subtle border for received messages */
            color: var(--color-text-primary); /* Ensure text is readable */
            border-bottom-left-radius: 8px; /* Pointed corner */
            margin-left: 10px; /* Space from edge */
        }

        .message.received::before {
            border-bottom-left-radius: 8px;
            left: -10px;
            border-right-color: var(--color-white); /* Match background color */
            border-bottom-color: var(--color-white);
        }

        .message .sender {
            font-weight: 700; /* Bolder sender name */
            color: var(--color-cyan-dark); /* Darker cyan */
            margin-bottom: 0.5em;
            font-size: 0.95em; /* Slightly larger sender name */
        }

        .message .text {
            color: var(--color-text-primary); /* Explicitly set text color for messages */
        }

        .timestamp {
            font-size: 0.7em;
            color: var(--color-text-secondary); /* Softer grey */
            text-align: right;
            margin-top: 0.5em;
        }

        /* Input, Button, Textarea General Styles */
        input, button, textarea {
            padding: 1em; /* Generous padding */
            border: 1px solid var(--color-input-border); /* Softer border color */
            border-radius: 15px; /* More rounded */
            width: 100%;
            font-size: 1.05em; /* Slightly larger font */
            transition: all 0.3s ease; /* Smooth transitions */
            background-color: var(--color-white); /* Use CSS variable */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); /* Subtle inner shadow */
            color: var(--color-text-primary); /* Ensure input text is visible */
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--color-cyan-primary); /* Vibrant cyan focus */
            box-shadow: 0 0 0 5px var(--shadow-strong); /* Stronger, wider focus glow */
            background-color: var(--color-input-focus-bg); /* Very light cyan on focus */
        }

        /* Primary Button Styles */
        button {
            background: linear-gradient(45deg, var(--color-cyan-gradient-start) 0%, var(--color-cyan-gradient-end) 100%); /* Bold cyan gradient */
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            font-weight: 700; /* Bolder text */
            box-shadow: 0 5px 15px var(--shadow-strong); /* Vibrant shadow */
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        button:hover {
            background: linear-gradient(45deg, var(--color-cyan-gradient-end) 0%, var(--color-cyan-gradient-start) 100%); /* Reverse gradient on hover */
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 20px var(--shadow-strong); /* Stronger shadow */
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Secondary Button Styles */
        button.secondary {
            background: var(--color-border-light); /* Light grey/cyan */
            color: var(--color-text-primary); /* Darker text */
            border: 1px solid var(--color-input-border); /* Use CSS variable */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        button.secondary:hover {
            background: var(--color-cyan-light); /* Slightly darker light cyan on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Section Containers (Auth, Groups, Contacts, Settings) */
        .auth-form, .group-options, .chat-section, .contacts-section, .settings-section, .private-chat-section {
            display: none; /* Controlled by JS */
            flex-direction: column;
            align-items: center;
            padding: 3em; /* Very generous padding */
            width: 100%; /* Full width on mobile */
            max-width: 650px; /* Wider containers on desktop */
            margin: 2em auto; /* More vertical margin */
            background: var(--color-white); /* Use CSS variable */
            border-radius: 25px; /* Very rounded container */
            box-shadow: 0 10px 30px var(--shadow-light); /* Deeper, softer shadow */
            border: 1px solid var(--color-border-light); /* Subtle border */
            animation: fadeIn 0.8s ease-out forwards; /* Fade in animation */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            width: 100%;
            margin-bottom: 1.5em; /* More space */
        }

        .form-group label {
            display: block;
            margin-bottom: 0.8em; /* More space */
            color: var(--color-text-primary); /* Use CSS variable */
            font-weight: 700; /* Bolder label */
            font-size: 1.1em;
        }

        .toggle-form {
            color: var(--color-cyan-primary); /* Use CSS variable */
            text-decoration: underline;
            cursor: pointer;
            margin-top: 2em; /* More space */
            text-align: center;
            font-weight: 600;
            transition: color 0.2s;
        }

        .toggle-form:hover {
            color: var(--color-cyan-dark); /* Darker cyan on hover */
        }

        /* Chat Messages Container */
        #messages, #private-messages {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 1em; /* More space between messages */
            padding-bottom: 1.5em; /* Space for footer */
            flex-grow: 1; /* Allow messages to take up available space */
        }

        /* Chat Header */
        .chat-header, .private-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2em 1.5em; /* More padding */
            background: linear-gradient(90deg, var(--color-cyan-gradient-start) 0%, var(--color-cyan-gradient-end) 100%); /* Bold cyan gradient */
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 5px 15px var(--shadow-strong); /* Use CSS variable */
            margin-bottom: 1em; /* Space below header */
        }

        .chat-header h2, .private-chat-header h2 {
            font-size: 1.8em;
            font-weight: 700;
            margin: 0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em; /* Larger arrow */
            cursor: pointer;
            transition: transform 0.2s ease-out;
            padding: 0.2em; /* Make click target larger */
        }

        .back-btn:hover {
            transform: translateX(-5px) scale(1.1); /* More pronounced slide and scale */
        }

        /* Group/Contact Options & Lists */
        .group-options h2, .contacts-list h2 {
            font-size: 2.2em; /* Larger headings */
            margin-bottom: 1.5em;
            color: var(--color-cyan-dark); /* Darker cyan */
            text-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-weight: 800;
        }

        .group-options button, .contacts-list button {
            padding: 1.3em; /* More padding */
            margin: 0.8em 0; /* More margin */
            max-width: 400px; /* Wider buttons */
            border-radius: 18px; /* More rounded */
            font-size: 1.1em;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-body); /* Use CSS variable */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 80px; /* Even larger spinner */
            height: 80px;
            border: 10px solid var(--color-border-light); /* Thicker border */
            border-top-color: var(--color-cyan-primary); /* Vibrant cyan */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2em;
            box-shadow: 0 0 0 5px rgba(0, 188, 212, 0.2); /* Subtle glow */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--color-cyan-primary); /* Use CSS variable */
            font-size: 2em; /* Larger text */
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .groups-list, .contacts-container {
            width: 100%;
            max-width: 550px; /* Wider lists */
            margin: 2em auto;
            background: var(--color-white); /* Use CSS variable */
            border-radius: 20px;
            padding: 2em;
            box-shadow: 0 5px 20px var(--shadow-light); /* Stronger shadow */
            border: 1px solid var(--color-border-light); /* Use CSS variable */
        }

        .groups-list h3 {
            font-size: 1.5em;
            color: var(--color-cyan-dark); /* Darker cyan */
            margin-bottom: 1.2em;
            font-weight: 700;
        }

        .group-item, .contact-item {
            padding: 1.2em; /* More padding */
            margin: 0.8em 0; /* More margin */
            background: var(--color-light-blue-bg); /* Very light blue background */
            border-radius: 15px; /* More rounded */
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); /* More visible item shadow */
            border: 1px solid var(--color-border-light); /* Use CSS variable */
        }

        .group-item:hover, .contact-item:hover {
            background: var(--color-border-light); /* Lighter cyan on hover */
            transform: translateY(-3px) scale(1.02); /* More pronounced lift and slight scale */
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }

        /* Avatars */
        .group-avatar, .contact-avatar, .profile-avatar {
            width: 60px; /* Even larger avatars */
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--color-cyan-primary), var(--color-cyan-gradient-end)); /* Gradient avatar background */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.5em; /* More margin */
            font-weight: 700;
            overflow: hidden;
            flex-shrink: 0;
            border: 4px solid var(--color-white); /* White border */
            box-shadow: 0 0 0 4px var(--shadow-strong); /* Stronger glow */
        }

        .group-avatar img, .contact-avatar img, .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .group-avatar div, .contact-avatar div, .profile-avatar div {
            font-size: 1.8em !important; /* Ensure initials are very visible */
            color: white; /* Ensure initials are white */
        }

        .group-info, .contact-info {
            flex: 1;
            text-align: left;
            min-width: 0; /* Allow text to shrink */
        }

        .group-name, .contact-name {
            font-weight: 700; /* Bolder names */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 1.2em; /* Larger names */
            color: var(--color-text-primary); /* Use CSS variable */
        }

        .group-desc, .contact-status {
            font-size: 0.9em; /* Slightly larger */
            color: var(--color-text-secondary); /* Use CSS variable */
            margin-top: 0.3em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .no-groups, .no-contacts {
            text-align: center;
            color: var(--color-text-secondary); /* Use CSS variable */
            padding: 2em;
            font-style: italic;
            font-size: 1.1em;
        }

        /* Settings Gear Icon */
        .group-settings-btn, .contact-settings-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1em; /* Decreased size */
            transition: transform 0.3s ease-out;
            padding: 0.2em; /* Smaller padding */
            margin-left: 1em; /* Space from group name */
        }

        .group-settings-btn:hover, .contact-settings-btn:hover {
            transform: rotate(60deg) scale(1.1); /* More pronounced spin and scale */
        }

        /* Settings Menu */
        .settings-menu {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 350px; /* Wider settings menu */
            background: linear-gradient(to bottom, var(--color-white) 0%, var(--color-light-blue-bg) 100%); /* Subtle gradient */
            box-shadow: -8px 0 30px var(--shadow-medium); /* Stronger shadow */
            z-index: 1000; /* Ensure it's on top */
            padding: 2em;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Springy animation */
            overflow-y: auto;
            border-left: 1px solid var(--color-border-light); /* Use CSS variable */
        }

        .settings-menu.open {
            transform: translateX(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2em;
            padding-bottom: 1.5em;
            border-bottom: 2px solid var(--color-border-light); /* Thicker border */
        }

        .settings-header h3 {
            font-size: 2em;
            color: var(--color-cyan-dark); /* Darker cyan */
            margin: 0;
            font-weight: 700;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 1.8em; /* Slightly larger close icon */
            cursor: pointer;
            color: var(--color-text-secondary); /* Softer grey */
            transition: color 0.3s, transform 0.3s;
            padding: 0.2em; /* Smaller padding */
        }

        .close-settings:hover {
            color: var(--color-text-primary); /* Darker on hover */
            transform: rotate(180deg) scale(1.1); /* Full spin and scale */
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 2em 0;
        }

        .avatar-preview {
            width: 140px; /* Huge avatars */
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--color-border-light), var(--color-cyan-light)); /* Light cyan gradient */
            margin-bottom: 1.5em;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em; /* Massive for initials */
            color: var(--color-cyan-dark); /* Use CSS variable */
            font-weight: 800;
            border: 5px solid var(--color-white); /* White border */
            box-shadow: 0 0 0 6px var(--shadow-strong), 0 5px 20px var(--shadow-light); /* Double glow and shadow */
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-id-display {
            background: var(--color-light-blue-bg); /* Very light blue background */
            padding: 1.2em;
            border-radius: 12px;
            margin: 2em 0;
            font-family: 'Consolas', 'Monaco', monospace; /* More distinct monospace font */
            word-break: break-all;
            text-align: left;
            width: 100%;
            border: 1px solid var(--color-input-border); /* Use CSS variable */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); /* Deeper inner shadow */
            color: var(--color-text-primary); /* Use CSS variable */
        }

        .user-id-display strong {
            color: var(--color-text-primary); /* Use CSS variable */
            font-size: 1em;
            display: block;
            margin-bottom: 0.8em;
        }

        /* Custom Alert Modal */
        .custom-alert-modal {
            display: none; /* Hidden by default, controlled by JS */
            position: fixed;
            z-index: 2001; /* Ensure it's on top */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Even darker overlay */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px); /* More intense blur */
            animation: fadeInOverlay 0.3s ease-out forwards;
        }

        @keyframes fadeInOverlay {
            from { background-color: rgba(0,0,0,0); }
            to { background-color: rgba(0,0,0,0.7); }
        }

        .custom-alert-content {
            background-color: var(--color-modal-bg); /* Use CSS variable */
            margin: auto;
            padding: 40px; /* Very generous padding */
            border: 2px solid var(--color-border-light); /* More prominent border */
            width: 95%;
            max-width: 500px; /* Wider max-width */
            border-radius: 20px; /* More rounded */
            box-shadow: 0 15px 40px var(--shadow-medium); /* Very pronounced shadow */
            position: relative;
            text-align: center;
            animation: fadeInScale 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; /* Springy animation */
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .close-alert-btn {
            color: var(--color-input-border); /* Softer grey */
            font-size: 28px; /* Adjusted size */
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
        }

        .close-alert-btn:hover,
        .close-alert-btn:focus {
            color: var(--color-text-primary); /* Use CSS variable */
            transform: rotate(90deg);
        }

        #custom-alert-message {
            margin-bottom: 30px; /* More space */
            font-size: 1.3em; /* Larger message text */
            color: var(--color-text-primary); /* Use CSS variable */
            line-height: 1.5;
            font-weight: 500;
        }

        #custom-alert-ok-btn {
            background: linear-gradient(45deg, var(--color-cyan-gradient-start), var(--color-cyan-gradient-end)); /* Use CSS variables */
            color: white;
            padding: 15px 30px; /* More padding */
            border: none;
            border-radius: 10px; /* More rounded */
            cursor: pointer;
            font-size: 1.2em; /* Larger text */
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 12px var(--shadow-strong); /* Use CSS variable */
        }

        #custom-alert-ok-btn:hover {
            background: linear-gradient(45deg, var(--color-cyan-gradient-end), var(--color-cyan-gradient-start)); /* Use CSS variables */
            transform: translateY(-2px);
        }

        /* Theme Switcher specific styles */
        .theme-switcher {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align label and options to start */
            margin-top: 2em;
        }

        .theme-options {
            display: flex;
            gap: 1em;
            margin-top: 0.5em;
            width: 100%; /* Ensure options take full width */
            justify-content: flex-start; /* Align buttons to start */
        }

        .theme-options button {
            flex-grow: 1; /* Allow buttons to grow */
            max-width: 150px; /* Limit button width */
            text-align: center;
        }
        .theme-options button.active {
            box-shadow: 0 0 0 3px var(--color-cyan-primary); /* Highlight active theme */
            transform: translateY(-2px);
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            main {
                padding: 3em;
            }
            .auth-form, .group-options, .chat-section, .contacts-section, .settings-section, .private-chat-section {
                padding: 3.5em;
            }
            .message {
                padding: 1.5em 1.8em;
            }
            input, button, textarea {
                padding: 1.2em;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 2em;
            }
            .header-tabs {
                flex-direction: column; /* Stack tabs vertically */
                align-items: center;
            }
            .tab-btn {
                padding: 0.6em 1em;
                font-size: 0.9em;
                width: 80%; /* Make tabs wider on small screens */
                max-width: none; /* Remove max-width constraint */
            }
            .auth-form, .group-options, .chat-section, .contacts-section, .settings-section, .private-chat-section {
                padding: 1.5em;
                margin: 1em auto; /* Reduce vertical margin */
            }
            .settings-menu {
                width: 100%; /* Full width on small screens */
            }
            .avatar-preview {
                width: 100px;
                height: 100px;
                font-size: 3em;
            }
            footer {
                flex-direction: column; /* Stack footer elements */
                gap: 1em; /* More space when stacked */
                padding: 1em;
            }
            footer input {
                margin-bottom: 0.5em; /* Space between input and button */
            }
            .group-settings-btn {
                font-size: 0.8em; /* Further decrease size on very small screens */
            }
            .theme-options {
                flex-direction: column; /* Stack theme buttons vertically on small screens */
            }
            .theme-options button {
                max-width: none; /* Allow full width */
            }
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading ThunderChat...</div>
    </div>

    <header>
        <h1>ThunderChat</h1>
        <div class="header-tabs">
            <button id="groups-tab" class="tab-btn active">Groups</button>
            <button id="contacts-tab" class="tab-btn">Contacts</button>
            <button id="settings-tab" class="tab-btn">Settings</button>
        </div>
    </header>

    <main>
        <div id="auth-section" class="auth-form">
            <div id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input id="login-email" type="email" placeholder="Enter your email" />
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input id="login-password" type="password" placeholder="Enter your password" />
                </div>
                <button id="login-btn">Login</button>
                <div id="toggle-to-register" class="toggle-form">Don't have an account? Register</div>
            </div>

            <div id="register-form" style="display: none;">
                <div class="form-group">
                    <label for="reg-username">Username</label>
                    <input id="reg-username" type="text" placeholder="Choose a username" />
                </div>
                <div class="form-group">
                    <label for="reg-email">Email</label>
                    <input id="reg-email" type="email" placeholder="Enter your email" />
                </div>
                <div class="form-group">
                    <label for="reg-password">Password</label>
                    <input id="reg-password" type="password" placeholder="Create a password" />
                </div>
                <button id="register-btn">Register</button>
                <div id="toggle-to-login" class="toggle-form">Already have an account? Login</div>
            </div>
        </div>

        <div id="group-options" class="group-options">
            <h2>Welcome, <span id="username-display"></span></h2>
            <button id="create-group-btn">Create Group</button>
            <button id="join-group-btn">Join New Group</button>
            
            <div class="groups-list">
                <h3>Your Groups (<span id="groups-count">0</span>)</h3>
                <div id="joined-groups-list">
                    <div class="no-groups">You haven't joined any groups yet</div>
                </div>
            </div>
        </div>

        <div id="chat-section" class="chat-section">
            <div class="chat-header">
                <button class="back-btn" id="back-btn">←</button>
                <h2 id="group-name-display"></h2>
                <button class="group-settings-btn" id="group-settings-btn">⚙️</button>
            </div>
            <div id="messages"></div>
            <footer>
                <input id="msg-input" type="text" placeholder="Type a message..." />
                <button id="send-btn">Send</button>
            </footer>
        </div>

        <div id="contacts-section" class="contacts-section">
            <div class="contacts-list">
                <h2>Your Contacts</h2>
                <button id="add-contact-btn">Add Contact</button>
                
                <div class="contacts-container">
                    <div id="contacts-list">
                        <div class="no-contacts">You don't have any contacts yet</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="private-chat-section" class="private-chat-section">
            <div class="private-chat-header">
                <button class="back-btn" id="back-private-btn">←</button>
                <h2 id="contact-name-display"></h2>
                <button class="group-settings-btn" id="block-contact-btn">🚫</button> 
            </div>
            <div id="private-messages"></div>
            <footer>
                <input id="private-msg-input" type="text" placeholder="Type a message..." />
                <button id="send-private-btn">Send</button>
            </footer>
        </div>

        <div id="settings-section" class="settings-section">
            <h2>Your Profile</h2>
            
            <div class="avatar-upload">
                <div class="avatar-preview" id="profile-avatar-preview">
                    
                </div>
                <div class="form-group" style="width: 100%;">
                    <label for="profile-avatar-url">Profile Picture URL</label>
                    <input type="text" id="profile-avatar-url" placeholder="Enter image URL" />
                </div>
            </div>
            
            <div class="form-group">
                <label for="profile-username">Username</label>
                <input id="profile-username" type="text" placeholder="Your username" />
                </div>
            
            <div class="form-group">
                <label for="profile-status">Status</label>
                <input id="profile-status" type="text" placeholder="Your status" />
            </div>

            <div class="form-group theme-switcher">
                <label>Theme</label>
                <div class="theme-options">
                    <button id="light-theme-btn" class="secondary">Light</button>
                    <button id="dark-theme-btn" class="secondary">Dark</button>
                </div>
            </div>
            
            <div class="user-id-display">
                <strong>Your ID:</strong>
                <div id="user-id-text">Loading...</div>
                </div>
            
            <button id="save-profile-btn">Save Changes</button>
            <button id="logout-btn" class="secondary">Logout</button>
        </div>
    </main>

    <div id="group-settings-menu" class="settings-menu">
        <div class="settings-header">
            <h3>Group Settings</h3>
            <button class="close-settings" id="close-group-settings">×</button>
        </div>
        
        <div class="avatar-upload">
            <div class="avatar-preview" id="group-avatar-preview">
                
            </div>
            <div class="form-group" style="width: 100%;">
                <label for="group-avatar-url">Group Picture URL</label>
                <input type="text" id="group-avatar-url" placeholder="Enter image URL" />
            </div>
        </div>
        
        <div class="form-group">
            <label>Group Name</label>
            <input id="group-name-setting" type="text" readonly />
            <small>Note: Group name cannot be changed.</small>
        </div>
        
        <div class="form-group">
            <label>Group Password</label>
            <input id="group-password-setting" type="text" readonly />
            <small>Note: Group password cannot be changed.</small>
        </div>
        
        <div class="form-group">
            <label for="group-desc-setting">Group Description</label>
            <textarea id="group-desc-setting" placeholder="Enter group description"></textarea>
        </div>
        
        <button id="save-group-settings-btn">Save Changes</button>
    </div>

    <div id="custom-alert-modal" class="custom-alert-modal">
        <div class="custom-alert-content">
            <span id="close-alert-btn" class="close-alert-btn">&times;</span>
            <p id="custom-alert-message"></p>
            <button id="custom-alert-ok-btn">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            push, 
            onChildAdded, 
            get, 
            child,
            update,
            onValue,
            off // Import off to detach listeners
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        // No longer need getStorage, ref as storageRef, uploadBytes, getDownloadURL

        const firebaseConfig = {
            apiKey: "AIzaSyBD4bDQgVtMd9cwq9Hfdz54NYSBcQvPr1Y",
            authDomain: "thunderboundthunderchat.firebaseapp.com",
            databaseURL: "https://thunderboundthunderchat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "thunderboundthunderchat",
            storageBucket: "thunderboundthunderchat.appspot.com",
            messagingSenderId: "79690962383",
            appId: "1:79690962383:web:fecf12881a13a4fdf22eba"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authSection = document.getElementById('auth-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const groupOptions = document.getElementById('group-options');
        const chatSection = document.getElementById('chat-section');
        const contactsSection = document.getElementById('contacts-section');
        const privateChatSection = document.getElementById('private-chat-section');
        const settingsSection = document.getElementById('settings-section');
        const messagesDiv = document.getElementById('messages');
        const privateMessagesDiv = document.getElementById('private-messages');
        const usernameDisplay = document.getElementById('username-display');
        const groupNameDisplay = document.getElementById('group-name-display');
        const contactNameDisplay = document.getElementById('contact-name-display');
        const joinedGroupsList = document.getElementById('joined-groups-list');
        const groupsCount = document.getElementById('groups-count');
        const contactsList = document.getElementById('contacts-list');
        const groupsTab = document.getElementById('groups-tab');
        const contactsTab = document.getElementById('contacts-tab');
        const settingsTab = document.getElementById('settings-tab');
        const groupSettingsMenu = document.getElementById('group-settings-menu');
        const closeGroupSettings = document.getElementById('close-group-settings');
        const groupSettingsBtn = document.getElementById('group-settings-btn');
        const addContactBtn = document.getElementById('add-contact-btn');
        const profileAvatarPreview = document.getElementById('profile-avatar-preview');
        const groupAvatarPreview = document.getElementById('group-avatar-preview');
        
        // New URL input fields
        const profileAvatarUrlInput = document.getElementById('profile-avatar-url');
        const groupAvatarUrlInput = document.getElementById('group-avatar-url');


        const userIdText = document.getElementById('user-id-text');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const saveGroupSettingsBtn = document.getElementById('save-group-settings-btn');

        // Auth specific elements
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const regUsernameInput = document.getElementById('reg-username');
        const regEmailInput = document.getElementById('reg-email');
        const regPasswordInput = document.getElementById('reg-password');
        const registerBtn = document.getElementById('register-btn');
        const toggleToRegister = document.getElementById('toggle-to-register');
        const toggleToLogin = document.getElementById('toggle-to-login');

        // Custom Alert Modal elements
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
        const closeAlertBtn = document.getElementById('close-alert-btn');

        // Theme switcher elements
        const lightThemeBtn = document.getElementById('light-theme-btn');
        const darkThemeBtn = document.getElementById('dark-theme-btn');


        let currentGroup = "";
        let currentContact = "";
        let currentUser = null;
        let userGroups = [];
        let userContacts = [];
        let userData = {}; // Stores additional user profile data from Realtime DB

        // Listener references for cleanup
        let currentGroupChatListener = null;
        let currentPrivateChatListener = null;
        let alertTimeoutId = null; // To manage alert auto-hide

        // Initialize the app
        window.addEventListener('DOMContentLoaded', () => {
            loadingScreen.style.display = 'none';
            loadUserTheme(); // Load theme as soon as possible
        });

        // Custom Alert Modal functions
        function showAlert(message, duration = 3000) { // Default duration 3 seconds
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex'; // Use flex to center
            clearTimeout(alertTimeoutId); // Clear any existing timeout
            alertTimeoutId = setTimeout(hideAlert, duration);
        }

        function hideAlert() {
            customAlertModal.style.display = 'none';
        }

        customAlertOkBtn.addEventListener('click', hideAlert);
        closeAlertBtn.addEventListener('click', hideAlert);

        // --- Theme Switcher Logic ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                darkThemeBtn.classList.add('active');
                lightThemeBtn.classList.remove('active');
            } else {
                document.body.classList.remove('dark-theme');
                lightThemeBtn.classList.add('active');
                darkThemeBtn.classList.remove('active');
            }
            // Save theme preference to local storage
            localStorage.setItem('theme', theme);
            // Optionally, save to Firebase for cross-device sync
            if (currentUser && currentUser.uid) {
                update(ref(db, `users/${currentUser.uid}`), { theme: theme }).catch(e => console.error("Failed to save theme to DB:", e));
            }
        }

        async function loadUserTheme() {
            let savedTheme = localStorage.getItem('theme');
            if (currentUser && currentUser.uid) {
                const snapshot = await get(child(ref(db), `users/${currentUser.uid}/theme`));
                if (snapshot.exists()) {
                    savedTheme = snapshot.val();
                }
            }
            applyTheme(savedTheme || 'light'); // Default to light if no theme saved
        }

        lightThemeBtn.addEventListener('click', () => applyTheme('light'));
        darkThemeBtn.addEventListener('click', () => applyTheme('dark'));


        // --- Auth Functionality ---

        // Toggle between login and register forms
        toggleToRegister.addEventListener('click', () => {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        });

        toggleToLogin.addEventListener('click', () => {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        // Function to generate a memorable ID
        function generateMemorableId() {
            const randomNumber = Math.floor(1000 + Math.random() * 9000); // 4-digit number
            return `${randomNumber}ThunderChat`;
        }

        // Register User
        registerBtn.addEventListener('click', async () => {
            const email = regEmailInput.value;
            const password = regPasswordInput.value;
            const username = regUsernameInput.value;

            if (!email || !password || !username) {
                showAlert('Please fill in all registration fields.');
                return;
            }

            showLoading('Registering...');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const memorableId = generateMemorableId(); // Generate memorable ID

                // Store user data in Realtime Database
                await set(ref(db, `users/${user.uid}`), {
                    username: username,
                    email: email,
                    status: 'Online',
                    avatarUrl: '', // Default empty avatar URL
                    theme: 'light', // Default theme for new users
                    memorableId: memorableId // Store the memorable ID
                });

                hideLoading();
                showAlert('Registration successful! You are now logged in.');
                // onAuthStateChanged will handle UI update
            } catch (error) {
                hideLoading();
                console.error("Error during registration:", error);
                showAlert(`Registration failed: ${error.message}`);
            }
        });

        // Login User
        loginBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            if (!email || !password) {
                showAlert('Please enter your email and password.');
                return;
            }

            showLoading('Logging in...');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideLoading();
                showAlert('Login successful!');
                // onAuthStateChanged will handle UI update
            } catch (error) {
                hideLoading();
                console.error("Error during login:", error);
                showAlert(`Login failed: ${error.message}`);
            }
        });

        // Auth state handler
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                showLoading('Loading your data...');
                const snapshot = await get(child(ref(db), `users/${user.uid}`));
                if (snapshot.exists()) {
                    currentUser = { ...user, ...snapshot.val() }; // Merge Firebase Auth user with Realtime DB data
                    userData = snapshot.val(); // Keep userData for other profile updates
                    hideLoading();
                    
                    authSection.style.display = 'none';
                    groupOptions.style.display = 'flex'; // Show groups by default
                    usernameDisplay.textContent = currentUser.username;
                    
                    // Initialize sections after login
                    loadUserGroups();
                    loadUserContacts();
                    loadUserProfile();
                    loadUserTheme(); // Re-load theme after user data is available
                } else {
                    // This case might happen if user registered but data wasn't saved (e.g., error)
                    hideLoading();
                    showAlert('User data not found in database. Please contact support or try registering again.');
                    signOut(auth); // Force logout if user data is missing
                }
            } else {
                hideLoading();
                authSection.style.display = 'flex';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                groupOptions.style.display = 'none';
                chatSection.style.display = 'none';
                contactsSection.style.display = 'none';
                privateChatSection.style.display = 'none';
                settingsSection.style.display = 'none';
                // Reset current user info on logout
                currentUser = null;
                userData = {};
                userGroups = [];
                userContacts = [];
                applyTheme('light'); // Revert to default theme on logout
            }
        });


        // Tab switching
        groupsTab.addEventListener('click', () => {
            if (!currentUser) return;
            groupsTab.classList.add('active');
            contactsTab.classList.remove('active');
            settingsTab.classList.remove('active');
            groupOptions.style.display = 'flex';
            contactsSection.style.display = 'none';
            settingsSection.style.display = 'none';
            chatSection.style.display = 'none'; // Ensure chat is hidden
            privateChatSection.style.display = 'none'; // Ensure private chat is hidden
        });

        contactsTab.addEventListener('click', () => {
            if (!currentUser) return;
            contactsTab.classList.add('active');
            groupsTab.classList.remove('active');
            settingsTab.classList.remove('active');
            contactsSection.style.display = 'flex';
            groupOptions.style.display = 'none';
            settingsSection.style.display = 'none';
            chatSection.style.display = 'none'; // Ensure chat is hidden
            privateChatSection.style.display = 'none'; // Ensure private chat is hidden
            loadUserContacts(); // Reload contacts when tab is clicked
        });

        settingsTab.addEventListener('click', () => {
            if (!currentUser) return;
            settingsTab.classList.add('active');
            groupsTab.classList.remove('active');
            contactsTab.classList.remove('active');
            settingsSection.style.display = 'flex';
            groupOptions.style.display = 'none';
            contactsSection.style.display = 'none';
            chatSection.style.display = 'none'; // Ensure chat is hidden
            privateChatSection.style.display = 'none'; // Ensure private chat is hidden
            loadUserProfile();
        });

        // Group settings
        groupSettingsBtn.addEventListener('click', () => {
            groupSettingsMenu.classList.add('open');
            loadGroupSettings();
        });

        closeGroupSettings.addEventListener('click', () => {
            groupSettingsMenu.classList.remove('open');
        });

        // Save profile
        saveProfileBtn.addEventListener('click', async () => {
            const username = document.getElementById('profile-username').value;
            const status = document.getElementById('profile-status').value;
            const avatarUrl = profileAvatarUrlInput.value.trim(); // Get URL from input
            
            showLoading('Saving profile...');
            await update(ref(db, `users/${currentUser.uid}`), {
                username,
                status,
                avatarUrl // Use the URL directly
            });
            
            // Update local data and display
            userData = { ...userData, username, status, avatarUrl };
            currentUser.username = username; // Update currentUser's username
            usernameDisplay.textContent = username;
            
            hideLoading();
            showAlert('Profile saved successfully!');
            loadUserProfile(); // Reload profile to ensure avatar is updated
        });

        // Save group settings
        saveGroupSettingsBtn.addEventListener('click', async () => {
            const description = document.getElementById('group-desc-setting').value;
            const groupAvatarUrl = groupAvatarUrlInput.value.trim(); // Get URL from input
            
            showLoading('Saving group settings...');
            await update(ref(db, `groups/${currentGroup}`), {
                description,
                avatarUrl: groupAvatarUrl // Use the URL directly
            });
            
            hideLoading();
            groupSettingsMenu.classList.remove('open');
            showAlert('Group settings saved!');
            loadUserGroups(); // Reload groups to reflect changes
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            showLoading('Logging out...');
            await signOut(auth);
            hideLoading();
            // The onAuthStateChanged listener will handle redirecting to auth section
        });

        // Add contact
        addContactBtn.addEventListener('click', () => {
            const contactId = prompt("Enter the user's ID you want to add:");
            if (contactId) {
                if (contactId === currentUser.memorableId) { // Check against memorableId
                    showAlert("You can't add yourself as a contact!");
                } else {
                    addContact(contactId);
                }
            }
        });

        // Load user contacts
        async function loadUserContacts() {
            if (!currentUser) return;
            
            try {
                const snapshot = await get(child(ref(db), `userContacts/${currentUser.uid}`));
                if (snapshot.exists()) {
                    const contacts = snapshot.val();
                    const contactIds = Object.keys(contacts);
                    
                    // Get details for each contact
                    userContacts = [];
                    for (const contactId of contactIds) {
                        const userSnapshot = await get(child(ref(db), `users/${contactId}`));
                        if (userSnapshot.exists()) {
                            userContacts.push({
                                id: contactId,
                                ...userSnapshot.val(),
                                ...contacts[contactId]
                            });
                        }
                    }
                    
                    renderContactsList();
                } else {
                    userContacts = [];
                    renderContactsList();
                }
            } catch (error) {
                console.error("Error loading contacts:", error);
                userContacts = [];
                renderContactsList();
            }
        }

        // Render contacts list
        function renderContactsList() {
            if (userContacts.length === 0) {
                contactsList.innerHTML = '<div class="no-contacts">You don\'t have any contacts yet</div>';
                return;
            }
            
            contactsList.innerHTML = userContacts.map(contact => `
                <div class="contact-item" data-contact="${contact.id}">
                    <div class="contact-avatar">
                        ${contact.avatarUrl ? 
                            `<img src="${contact.avatarUrl}" alt="${contact.username}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/00bcd4/ffffff?text=${contact.username?.charAt(0).toUpperCase() || 'U'}'" />` : 
                            `<div>${contact.username?.charAt(0).toUpperCase() || 'U'}</div>`}
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.username || 'Unknown User'}</div>
                        <div class="contact-status">${contact.status || 'No status'}</div>
                    </div>
                </div>
            `).join('');

            // Apply styles for fallback avatars (initials)
            document.querySelectorAll('.contact-avatar div').forEach(div => {
                div.style.backgroundColor = 'var(--color-cyan-primary)'; /* Use the primary cyan */
                div.style.color = 'white';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.fontSize = '1.8em'; /* Larger initials */
            });
            
            // Add click event to contacts
            document.querySelectorAll('.contact-item').forEach(item => {
                item.addEventListener('click', () => {
                    const contactId = item.getAttribute('data-contact');
                    const contact = userContacts.find(c => c.id === contactId);
                    if (contact) {
                        enterPrivateChat(contact);
                    }
                });
            });
        }

        // Enter private chat
        function enterPrivateChat(contact) {
            currentContact = contact.id;
            contactsSection.style.display = 'none'; // Hide contacts section
            privateChatSection.style.display = 'flex'; // Show private chat section
            contactNameDisplay.textContent = contact.username || 'Unknown User';
            privateMessagesDiv.innerHTML = '';
            
            // Detach previous listener if exists
            if (currentPrivateChatListener) {
                off(currentPrivateChatListener);
                currentPrivateChatListener = null;
            }

            const chatId = [currentUser.uid, contact.id].sort().join('_');
            const chatRef = ref(db, `privateMessages/${chatId}`);
            
            // Attach new listener and store its reference
            currentPrivateChatListener = onChildAdded(chatRef, async (data) => {
                const msgData = data.val();
                const msg = document.createElement('div');
                msg.className = `message ${msgData.senderId === currentUser?.uid ? 'sent' : 'received'}`;
                
                // Fetch sender's username and avatar for display
                let senderUsername = 'Unknown';
                try {
                    const senderSnapshot = await get(child(ref(db), `users/${msgData.senderId}`));
                    if (senderSnapshot.exists()) {
                        const senderInfo = senderSnapshot.val();
                        senderUsername = senderInfo.username || 'Unknown';
                    }
                } catch (e) {
                    console.error("Error fetching sender info:", e);
                }

                msg.innerHTML = `
                    <div class="sender">${senderUsername}</div>
                    <div class="text">${msgData.text}</div>
                    <div class="timestamp">${formatTime(msgData.timestamp)}</div>
                `;
                
                privateMessagesDiv.appendChild(msg);
                privateMessagesDiv.scrollTop = privateMessagesDiv.scrollHeight;
            });
            console.log("Entered private chat with:", contact.username, "Private chat section display:", privateChatSection.style.display);
        }

        // Back button for private chat
        document.getElementById('back-private-btn').addEventListener('click', () => {
            privateChatSection.style.display = 'none';
            contactsSection.style.display = 'flex';
            currentContact = "";
            // Detach the listener when leaving private chat
            if (currentPrivateChatListener) {
                off(currentPrivateChatListener);
                currentPrivateChatListener = null;
            }
        });

        // Send private message
        document.getElementById('send-private-btn').addEventListener('click', sendPrivateMessage);
        document.getElementById('private-msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default Enter key behavior (e.g., new line in textarea)
                sendPrivateMessage();
            }
        });

        function sendPrivateMessage() {
            const input = document.getElementById('private-msg-input');
            const text = input.value.trim();
            
            if (text && currentContact && currentUser) {
                const chatId = [currentUser.uid, currentContact].sort().join('_');
                const chatRef = ref(db, `privateMessages/${chatId}`);
                
                push(chatRef, {
                    text: text,
                    sender: currentUser.username || currentUser.email,
                    senderId: currentUser.uid,
                    timestamp: Date.now()
                });
                
                input.value = "";
            }
        }


        // --- Group Functionality (Existing, slightly modified for clarity) ---

        // Create Group
        document.getElementById('create-group-btn').addEventListener('click', async () => {
            const groupName = prompt("Enter new group name:");
            if (!groupName) return;
            
            const groupPassword = prompt("Enter group password (optional):");

            showLoading('Creating group...');
            try {
                const groupRef = ref(db, `groups/${groupName}`);
                const snapshot = await get(groupRef);
                
                if (snapshot.exists()) {
                    showAlert('Group name already exists!');
                    hideLoading();
                    return;
                }
                
                await set(groupRef, {
                    name: groupName,
                    password: groupPassword || null,
                    createdAt: Date.now(),
                    admin: currentUser.uid,
                    description: '',
                    avatarUrl: ''
                });

                // Add user to group members
                await set(ref(db, `groupMembers/${groupName}/${currentUser.uid}`), {
                    joinedAt: Date.now()
                });

                // Add group to user's joined groups
                await set(ref(db, `userGroups/${currentUser.uid}/${groupName}`), {
                    joinedAt: Date.now()
                });

                hideLoading();
                showAlert('Group created and joined successfully!');
                loadUserGroups(); // Reload groups after creation
            } catch (error) {
                hideLoading();
                console.error("Error creating group:", error);
                showAlert(`Failed to create group: ${error.message}`);
            }
        });

        // Join New Group
        document.getElementById('join-group-btn').addEventListener('click', async () => {
            const groupName = prompt("Enter group name to join:");
            if (!groupName) return;
            
            showLoading('Joining group...');
            try {
                const groupRef = ref(db, `groups/${groupName}`);
                const snapshot = await get(groupRef);
                
                if (!snapshot.exists()) {
                    showAlert('Group does not exist!');
                    hideLoading();
                    return;
                }
                
                const groupData = snapshot.val();
                if (groupData.password) {
                    const enteredPassword = prompt("Enter group password:");
                    if (enteredPassword !== groupData.password) {
                        showAlert('Incorrect password!');
                        hideLoading();
                        return;
                    }
                }

                // Check if already a member
                const memberSnapshot = await get(child(ref(db), `groupMembers/${groupName}/${currentUser.uid}`));
                if (memberSnapshot.exists()) {
                    showAlert('You are already a member of this group!');
                    hideLoading();
                    return;
                }
                
                await set(ref(db, `groupMembers/${groupName}/${currentUser.uid}`), {
                    joinedAt: Date.now()
                });
                await set(ref(db, `userGroups/${currentUser.uid}/${groupName}`), {
                    joinedAt: Date.now()
                });
                
                hideLoading();
                showAlert('Joined group successfully!');
                loadUserGroups(); // Reload groups after joining
            } catch (error) {
                hideLoading();
                console.error("Error joining group:", error);
                showAlert(`Failed to join group: ${error.message}`);
            }
        });

        // Load User Groups
        async function loadUserGroups() {
            if (!currentUser) return;
            
            try {
                const snapshot = await get(child(ref(db), `userGroups/${currentUser.uid}`));
                if (snapshot.exists()) {
                    const groups = snapshot.val();
                    const groupNames = Object.keys(groups);
                    userGroups = [];
                    for (const groupName of groupNames) {
                        const groupSnapshot = await get(child(ref(db), `groups/${groupName}`));
                        if (groupSnapshot.exists()) {
                            userGroups.push({
                                id: groupName,
                                ...groupSnapshot.val()
                            });
                        }
                    }
                    renderGroupsList();
                } else {
                    userGroups = [];
                    renderGroupsList();
                }
            } catch (error) {
                console.error("Error loading groups:", error);
                userGroups = [];
                renderGroupsList();
            }
        }

        // Render Groups List
        function renderGroupsList() {
            groupsCount.textContent = userGroups.length;
            if (userGroups.length === 0) {
                joinedGroupsList.innerHTML = '<div class="no-groups">You haven\'t joined any groups yet</div>';
                return;
            }
            
            joinedGroupsList.innerHTML = userGroups.map(group => `
                <div class="group-item" data-group="${group.id}">
                    <div class="group-avatar">
                        ${group.avatarUrl ? 
                            `<img src="${group.avatarUrl}" alt="${group.name}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/00bcd4/ffffff?text=${group.name.charAt(0).toUpperCase()}'" />` : 
                            `<div>${group.name.charAt(0).toUpperCase()}</div>`}
                    </div>
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-desc">${group.description || 'No description'}</div>
                    </div>
                </div>
            `).join('');

            // Apply styles for fallback avatars (initials)
            document.querySelectorAll('.group-avatar div').forEach(div => {
                div.style.backgroundColor = 'var(--color-cyan-primary)'; /* Use the primary cyan */
                div.style.color = 'white';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.fontSize = '1.8em'; /* Larger initials */
            });

            // Add click event to each group item
            document.querySelectorAll('.group-item').forEach(item => {
                item.addEventListener('click', () => {
                    const groupId = item.getAttribute('data-group');
                    enterGroupChat(groupId);
                });
            });
        }

        // Enter Group Chat
        function enterGroupChat(groupId) {
            currentGroup = groupId;
            groupOptions.style.display = 'none';
            chatSection.style.display = 'flex';
            groupNameDisplay.textContent = groupId;
            messagesDiv.innerHTML = ''; // Clear previous messages
            
            // Detach previous listener if exists
            if (currentGroupChatListener) {
                off(currentGroupChatListener);
                currentGroupChatListener = null;
            }

            const messagesRef = ref(db, `groupMessages/${groupId}`);
            
            // Attach new listener and store its reference
            currentGroupChatListener = onChildAdded(messagesRef, async (data) => {
                const msgData = data.val();
                const msg = document.createElement('div');
                msg.className = `message ${msgData.senderId === currentUser?.uid ? 'sent' : 'received'}`;
                
                // Fetch sender's username and avatar for display
                let senderUsername = 'Unknown';
                try {
                    const senderSnapshot = await get(child(ref(db), `users/${msgData.senderId}`));
                    if (senderSnapshot.exists()) {
                        const senderInfo = senderSnapshot.val();
                        senderUsername = senderInfo.username || 'Unknown';
                    }
                } catch (e) {
                    console.error("Error fetching sender info:", e);
                }

                msg.innerHTML = `
                    <div class="sender">${senderUsername}</div>
                    <div class="text">${msgData.text}</div>
                    <div class="timestamp">${formatTime(msgData.timestamp)}</div>
                `;
                
                messagesDiv.appendChild(msg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // Back button for group chat
        document.getElementById('back-btn').addEventListener('click', () => {
            chatSection.style.display = 'none';
            groupOptions.style.display = 'flex';
            currentGroup = "";
            // Detach the listener when leaving group chat
            if (currentGroupChatListener) {
                off(currentGroupChatListener);
                currentGroupChatListener = null;
            }
        });

        // Send Group Message
        document.getElementById('send-btn').addEventListener('click', sendGroupMessage);
        document.getElementById('msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default Enter key behavior
                sendGroupMessage();
            }
        });

        function sendGroupMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            
            if (text && currentGroup && currentUser) {
                const messagesRef = ref(db, `groupMessages/${currentGroup}`);
                push(messagesRef, {
                    text: text,
                    sender: currentUser.username || currentUser.email, // Use username from updated currentUser
                    senderId: currentUser.uid,
                    timestamp: Date.now()
                });
                input.value = "";
            }
        }


        // Helper functions
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function showLoading(message = 'Loading...') {
            loadingScreen.style.display = 'flex';
            loadingScreen.querySelector('.loading-text').textContent = message;
        }

        function hideLoading() {
            loadingScreen.style.display = 'none';
        }
    </script>
</body>
</html>
