<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ThunderChat</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        /* CSS Variables for Theming */
        :root { /* Light theme variables */
            --bg-body: linear-gradient(135deg, #f0f8ff 0%, #e0f7fa 100%);
            --color-text-primary: #263238;
            --color-text-secondary: #78909c;
            --color-cyan-dark: #00838f;
            --color-cyan-primary: #00bcd4;
            --color-cyan-light: #80deea;
            --color-cyan-gradient-start: #00bcd4;
            --color-cyan-gradient-end: #00acc1;
            --color-white: #ffffff;
            --color-light-blue-bg: #f5faff;
            --color-border-light: #e0f2f7;
            --color-input-border: #b0bec5;
            --color-input-focus-bg: #f5feff;
            --color-modal-bg: #fefefe;
            --shadow-light: rgba(0,0,0,0.15);
            --shadow-medium: rgba(0,0,0,0.25);
            --shadow-strong: rgba(0, 188, 212, 0.4);
        }

        body.dark-theme { /* Dark theme overrides */
            --bg-body: linear-gradient(135deg, #263238 0%, #1a2226 100%); /* Dark grey to black */
            --color-text-primary: #e0f7fa; /* Light cyan text */
            --color-text-secondary: #a7b9c2; /* Lighter grey */
            --color-cyan-dark: #4dd0e1; /* Lighter cyan */
            --color-cyan-primary: #00bcd4;
            --color-cyan-light: #80deea;
            --color-cyan-gradient-start: #00838f; /* Darker cyan gradient */
            --color-cyan-gradient-end: #00bcd4;
            --color-white: #37474f; /* Darker white for elements */
            --color-light-blue-bg: #37474f; /* Dark background for items */
            --color-border-light: #455a64; /* Darker border */
            --color-input-border: #546e7a;
            --color-input-focus-bg: #2d3b42;
            --color-modal-bg: #2d3b42;
            --shadow-light: rgba(0,0,0,0.4);
            --shadow-medium: rgba(0,0,0,0.5);
            --shadow-strong: rgba(0, 188, 212, 0.6);
        }

        /* Universal box-sizing for consistent layout and base font */
        * {
            box-sizing: border-box;
            font-size: 18px; /* Base font size for readability */
            -webkit-font-smoothing: antialiased; /* Smoother fonts for Webkit browsers */
            -moz-osx-font-smoothing: grayscale; /* Smoother fonts for Firefox */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif; /* Modern, clean font */
            background: var(--bg-body); /* Use CSS variable */
            color: var(--color-text-primary); /* Use CSS variable */
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensure full viewport height */
            width: 100%; /* Ensure full width */
            overflow-x: hidden; /* Prevent horizontal scrolling */
            transition: background 0.5s ease; /* Smooth transition for background changes */
        }

        /* Header Styling */
        header {
            padding: 1.5em 1em; /* Generous padding */
            background: linear-gradient(90deg, var(--color-cyan-gradient-start) 0%, var(--color-cyan-gradient-end) 100%); /* Use CSS variables */
            color: white;
            text-align: center;
            box-shadow: 0 8px 20px var(--shadow-strong); /* Strong, vibrant shadow */
            border-bottom-left-radius: 30px; /* Very rounded bottom corners */
            border-bottom-right-radius: 30px;
            position: relative;
            z-index: 20;
            overflow: hidden; /* Hide overflow for pseudo-elements */
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            opacity: 0.3;
            animation: headerGlow 10s infinite linear; /* Subtle background animation */
        }

        @keyframes headerGlow {
            0% { transform: rotate(0deg); opacity: 0.3; }
            50% { transform: rotate(180deg); opacity: 0.5; }
            100% { transform: rotate(360deg); opacity: 0.3; }
        }

        header h1 {
            font-size: 3em; /* Super large title */
            margin: 0;
            font-weight: 800; /* Extra bold */
            text-shadow: 2px 2px 5px rgba(0,0,0,0.2); /* Stronger text shadow */
            letter-spacing: 0.08em; /* More spaced out letters */
        }

        /* Header Tabs */
        .header-tabs {
            display: flex;
            justify-content: center;
            margin-top: 1.5em; /* More space below title */
            gap: 1.2em; /* Increased space between tabs */
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        }

        .tab-btn {
            background: rgba(255,255,255,0.15); /* Slightly less transparent */
            border: 2px solid rgba(255,255,255,0.5); /* More prominent border */
            color: white;
            padding: 0.8em 1.8em; /* More padding */
            font-size: 1.1em; /* Slightly larger font */
            cursor: pointer;
            border-radius: 30px; /* Very rounded */
            transition: all 0.3s ease-in-out; /* Smooth transitions */
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            backdrop-filter: blur(5px); /* Frosted glass effect */
            flex-grow: 1; /* Allow buttons to grow */
            max-width: 180px; /* Limit max width for tabs */
            text-align: center;
        }

        .tab-btn.active {
            background: rgba(255,255,255,0.4); /* More opaque when active */
            box-shadow: 0 6px 15px var(--shadow-strong); /* Stronger shadow for active */
            transform: translateY(-4px); /* More pronounced lift */
            border-color: white; /* Solid white border for active */
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Main Content Area */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 1em; /* Optimized padding for smaller screens */
            width: 100%;
            display: flex; /* Use flex for centering content */
            justify-content: center;
            align-items: flex-start; /* Align items to the top within main */
        }

        /* Footer Styling */
        footer {
            padding: 1.2em; /* More padding */
            background: var(--color-white); /* Use CSS variable */
            border-top: 3px solid var(--color-border-light); /* Use CSS variable */
            border-top-left-radius: 25px; /* More rounded corners */
            border-top-right-radius: 25px;
            box-shadow: 0 -8px 20px var(--shadow-light); /* Stronger shadow */
            display: flex;
            gap: 0.8em; /* More space between input and button */
            align-items: center;
            position: relative; /* For z-index */
            z-index: 10;
            flex-wrap: wrap; /* Allow footer elements to wrap */
            width: 100%; /* Ensure footer takes full width */
        }

        /* Message Bubbles */
        .message {
            margin: 1em 0; /* More vertical space */
            padding: 1.2em 1.5em; /* Generous padding */
            background: var(--color-white); /* Use CSS variable */
            border-radius: 22px; /* Super rounded */
            box-shadow: 0 4px 12px var(--shadow-light); /* Deeper shadow */
            max-width: 90%; /* Wider messages */
            word-wrap: break-word;
            transform: translateY(30px); /* Start further down */
            opacity: 0;
            animation: messageAppear 0.5s ease-out forwards; /* Slower, smoother animation */
            position: relative;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Message bubble corners */
        .message::before {
            content: '';
            position: absolute;
            bottom: 0;
            width: 0;
            height: 0;
            border: 10px solid transparent;
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(to right, var(--color-cyan-light), var(--color-cyan-primary)); /* Vibrant light cyan gradient */
            color: var(--color-text-primary); /* Ensure text is readable */
            border-bottom-right-radius: 8px; /* Pointed corner */
            margin-right: 10px; /* Space from edge */
        }

        .message.sent::before {
            border-bottom-right-radius: 8px;
            right: -10px;
            border-left-color: var(--color-cyan-primary); /* Match gradient end color */
            border-bottom-color: var(--color-cyan-primary);
        }

        .message.received {
            align-self: flex-start;
            background: var(--color-white); /* Use CSS variable */
            border: 1px solid var(--color-border-light); /* Subtle border for received messages */
            color: var(--color-text-primary); /* Ensure text is readable */
            border-bottom-left-radius: 8px; /* Pointed corner */
            margin-left: 10px; /* Space from edge */
        }

        .message.received::before {
            border-bottom-left-radius: 8px;
            left: -10px;
            border-right-color: var(--color-white); /* Match background color */
            border-bottom-color: var(--color-white);
        }

        .message .sender {
            font-weight: 700; /* Bolder sender name */
            color: var(--color-cyan-dark); /* Darker cyan */
            margin-bottom: 0.5em;
            font-size: 0.95em; /* Slightly larger sender name */
        }

        .message .text {
            color: var(--color-text-primary); /* Explicitly set text color for messages */
        }

        .timestamp {
            font-size: 0.7em;
            color: var(--color-text-secondary); /* Softer grey */
            text-align: right;
            margin-top: 0.5em;
        }

        /* Input, Button, Textarea General Styles */
        input, button, textarea {
            padding: 1em; /* Generous padding */
            border: 1px solid var(--color-input-border); /* Softer border color */
            border-radius: 15px; /* More rounded */
            width: 100%;
            font-size: 1.05em; /* Slightly larger font */
            transition: all 0.3s ease; /* Smooth transitions */
            background-color: var(--color-white); /* Use CSS variable */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); /* Subtle inner shadow */
            color: var(--color-text-primary); /* Ensure input text is visible */
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--color-cyan-primary); /* Vibrant cyan focus */
            box-shadow: 0 0 0 5px var(--shadow-strong); /* Stronger, wider focus glow */
            background-color: var(--color-input-focus-bg); /* Very light cyan on focus */
        }

        /* Primary Button Styles */
        button {
            background: linear-gradient(45deg, var(--color-cyan-gradient-start) 0%, var(--color-cyan-gradient-end) 100%); /* Bold cyan gradient */
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            font-weight: 700; /* Bolder text */
            box-shadow: 0 5px 15px var(--shadow-strong); /* Vibrant shadow */
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            width: 100%; /* Ensures buttons take full available width in their container */
            max-width: 250px; /* Optimized max-width for mobile comfort */
        }

        button:hover {
            background: linear-gradient(45deg, var(--color-cyan-gradient-end) 0%, var(--color-cyan-gradient-start) 100%); /* Reverse gradient on hover */
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 20px var(--shadow-strong); /* Stronger shadow */
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Secondary Button Styles */
        button.secondary {
            background: var(--color-border-light); /* Light grey/cyan */
            color: var(--color-text-primary); /* Darker text */
            border: 1px solid var(--color-input-border); /* Use CSS variable */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        button.secondary:hover {
            background: var(--color-cyan-light); /* Slightly darker light cyan on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Section Containers (Auth, Groups, Contacts, Settings, Posts, Welcome) */
        .auth-form, .group-options, .chat-section, .contacts-section, .settings-section, .private-chat-section, .posts-section, .welcome-section, .posts-studio-section {
            display: none; /* Controlled by JS */
            flex-direction: column;
            align-items: center;
            padding: 1.5em; /* Optimized padding for mobile */
            width: 100%; /* Full width on mobile */
            max-width: 100%; /* Ensure full width on smaller screens */
            margin: 2em auto; /* More vertical margin */
            background: var(--color-white); /* Use CSS variable */
            border-radius: 25px; /* Very rounded container */
            box-shadow: 0 10px 30px var(--shadow-light); /* Deeper, softer shadow */
            border: 1px solid var(--color-border-light); /* Subtle border */
            animation: fadeIn 0.8s ease-out forwards; /* Fade in animation */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            width: 100%;
            margin-bottom: 1.5em; /* More space */
        }

        .form-group label {
            display: block;
            margin-bottom: 0.8em; /* More space */
            color: var(--color-text-primary); /* Use CSS variable */
            font-weight: 700; /* Bolder label */
            font-size: 1.1em;
        }

        .toggle-form {
            color: var(--color-cyan-primary); /* Use CSS variable */
            text-decoration: underline;
            cursor: pointer;
            margin-top: 2em; /* More space */
            text-align: center;
            font-weight: 600;
            transition: color 0.2s;
        }

        .toggle-form:hover {
            color: var(--color-cyan-dark); /* Darker cyan on hover */
        }

        /* Chat Messages Container */
        #messages, #private-messages {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 1em; /* More space between messages */
            padding-bottom: 1.5em; /* Space for footer */
            flex-grow: 1; /* Allow messages to take up available space */
        }

        /* Chat Header */
        .chat-header, .private-chat-header, .posts-studio-header { /* Added posts-studio-header */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2em 1.5em; /* More padding */
            background: linear-gradient(90deg, var(--color-cyan-gradient-start) 0%, var(--color-cyan-gradient-end) 100%); /* Bold cyan gradient */
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 5px 15px var(--shadow-strong); /* Use CSS variable */
            margin-bottom: 1em; /* Space below header */
        }

        .chat-header h2, .private-chat-header h2, .posts-studio-header h2 { /* Added posts-studio-header h2 */
            font-size: 1.8em;
            font-weight: 700;
            margin: 0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em; /* Larger arrow */
            cursor: pointer;
            transition: transform 0.2s ease-out;
            padding: 0.2em; /* Make click target larger */
        }

        .back-btn:hover {
            transform: translateX(-5px) scale(1.1); /* More pronounced slide and scale */
        }

        /* Group/Contact Options & Lists */
        .group-options h2, .contacts-list h2, .posts-section h2, .welcome-section h2, .posts-studio-section h2 {
            font-size: 2.2em; /* Larger headings */
            margin-bottom: 1.5em;
            color: var(--color-cyan-dark); /* Darker cyan */
            text-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-weight: 800;
        }

        .group-options button, .contacts-list button, .posts-section button, .posts-studio-section button {
            padding: 1.3em; /* More padding */
            margin: 0.8em 0; /* More margin */
            max-width: 280px; /* Optimized max-width for mobile */
            border-radius: 18px; /* More rounded */
            font-size: 1.1em;
            width: 100%; /* Ensure they fill their container */
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-body); /* Use CSS variable */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 80px; /* Even larger spinner */
            height: 80px;
            border: 10px solid var(--color-border-light); /* Thicker border */
            border-top-color: var(--color-cyan-primary); /* Vibrant cyan */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2em;
            box-shadow: 0 0 0 5px rgba(0, 188, 212, 0.2); /* Subtle glow */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--color-cyan-primary); /* Use CSS variable */
            font-size: 2em; /* Larger text */
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .groups-list, .contacts-container, .posts-container, .user-posts-list {
            width: 100%;
            max-width: 550px; /* Wider lists */
            margin: 2em auto;
            background: var(--color-white); /* Use CSS variable */
            border-radius: 20px;
            padding: 2em;
            box-shadow: 0 5px 20px var(--shadow-light); /* Stronger shadow */
            border: 1px solid var(--color-border-light); /* Use CSS variable */
        }

        .groups-list h3, .contacts-container h3, .posts-container h3, .user-posts-list h3 {
            font-size: 1.5em;
            color: var(--color-cyan-dark); /* Darker cyan */
            margin-bottom: 1.2em;
            font-weight: 700;
        }

        .group-item, .contact-item {
            padding: 1.2em; /* More padding */
            margin: 0.8em 0; /* More margin */
            background: var(--color-light-blue-bg); /* Very light blue background */
            border-radius: 15px; /* More rounded */
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); /* More visible item shadow */
            border: 1px solid var(--color-border-light); /* Use CSS variable */
        }

        .group-item:hover, .contact-item:hover {
            background: var(--color-border-light); /* Lighter cyan on hover */
            transform: translateY(-3px) scale(1.02); /* More pronounced lift and slight scale */
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }

        /* Avatars */
        .group-avatar, .contact-avatar, .profile-avatar, .post-avatar {
            width: 60px; /* Even larger avatars */
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--color-cyan-primary), var(--color-cyan-gradient-end)); /* Gradient avatar background */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.5em; /* More margin */
            font-weight: 700;
            overflow: hidden;
            flex-shrink: 0;
            border: 4px solid var(--color-white); /* White border */
            box-shadow: 0 0 0 4px var(--shadow-strong); /* Stronger glow */
        }

        .group-avatar img, .contact-avatar img, .profile-avatar img, .post-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .group-avatar div, .contact-avatar div, .profile-avatar div, .post-avatar div {
            font-size: 1.8em !important; /* Ensure initials are very visible */
            color: white; /* Ensure initials are white */
        }

        .group-info, .contact-info {
            flex: 1;
            text-align: left;
            min-width: 0; /* Allow text to shrink */
        }

        .group-name, .contact-name {
            font-weight: 700; /* Bolder names */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 1.2em; /* Larger names */
            color: var(--color-text-primary); /* Use CSS variable */
        }

        .group-desc, .contact-status {
            font-size: 0.9em; /* Slightly larger */
            color: var(--color-text-secondary); /* Use CSS variable */
            margin-top: 0.3em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .no-groups, .no-contacts, .no-posts, .no-user-posts {
            text-align: center;
            color: var(--color-text-secondary); /* Use CSS variable */
            padding: 2em;
            font-style: italic;
            font-size: 1.1em;
        }

        /* Settings Gear Icon (for group and contact chat headers) */
        .group-settings-btn {
            background: rgba(255,255,255,0.2); /* Subtle background */
            border: 1px solid rgba(255,255,255,0.5); /* Light border */
            color: white;
            cursor: pointer;
            font-size: 1.2em; /* Icon size */
            width: 35px; /* Fixed width */
            height: 35px; /* Fixed height */
            border-radius: 50%; /* Perfect circle */
            display: flex; /* To center the icon */
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease-out;
            margin-left: auto; /* Push to the right */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .group-settings-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: rotate(60deg) scale(1.05); /* Gentle spin and scale */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* Settings Menu */
        .settings-menu {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 350px; /* Wider settings menu */
            background: linear-gradient(to bottom, var(--color-white) 0%, var(--color-light-blue-bg) 100%); /* Subtle gradient */
            box-shadow: -8px 0 30px var(--shadow-medium); /* Stronger shadow */
            z-index: 1000; /* Ensure it's on top */
            padding: 2em;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Springy animation */
            overflow-y: auto;
            border-left: 1px solid var(--color-border-light); /* Use CSS variable */
        }

        .settings-menu.open {
            transform: translateX(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2em;
            padding-bottom: 1.5em;
            border-bottom: 2px solid var(--color-border-light); /* Thicker border */
        }

        .settings-header h3 {
            font-size: 2em;
            color: var(--color-cyan-dark); /* Darker cyan */
            margin: 0;
            font-weight: 700;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 1.8em; /* Slightly larger close icon */
            cursor: pointer;
            color: var(--color-text-secondary); /* Softer grey */
            transition: color 0.3s, transform 0.3s;
            padding: 0.2em; /* Smaller padding */
        }

        .close-settings:hover {
            color: var(--color-text-primary); /* Darker on hover */
            transform: rotate(180deg);
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 2em 0;
        }

        .avatar-preview {
            width: 140px; /* Huge avatars */
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--color-border-light), var(--color-cyan-light)); /* Light cyan gradient */
            margin-bottom: 1.5em;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em; /* Massive for initials */
            color: var(--color-cyan-dark); /* Use CSS variable */
            font-weight: 800;
            border: 5px solid var(--color-white); /* White border */
            box-shadow: 0 0 0 6px var(--shadow-strong), 0 5px 20px var(--shadow-light); /* Double glow and shadow */
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-id-display {
            background: var(--color-light-blue-bg); /* Very light blue background */
            padding: 1.2em;
            border-radius: 12px;
            margin: 2em 0;
            font-family: 'Consolas', 'Monaco', monospace; /* More distinct monospace font */
            word-break: break-all;
            text-align: left;
            width: 100%;
            border: 1px solid var(--color-input-border); /* Use CSS variable */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); /* Deeper inner shadow */
            color: var(--color-text-primary); /* Use CSS variable */
        }

        .user-id-display strong {
            color: var(--color-text-primary); /* Use CSS variable */
            font-size: 1em;
            display: block;
            margin-bottom: 0.8em;
        }

        /* Custom Alert Modal */
        .custom-alert-modal {
            display: none; /* Hidden by default, controlled by JS */
            position: fixed;
            z-index: 2001; /* Ensure it's on top */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Even darker overlay */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px); /* More intense blur */
            animation: fadeInOverlay 0.3s ease-out forwards;
        }

        @keyframes fadeInOverlay {
            from { background-color: rgba(0,0,0,0); }
            to { background-color: rgba(0,0,0,0.7); }
        }

        .custom-alert-content {
            background-color: var(--color-modal-bg); /* Use CSS variable */
            margin: auto;
            padding: 40px; /* Very generous padding */
            border: 2px solid var(--color-border-light); /* More prominent border */
            width: 95%;
            max-width: 500px; /* Wider max-width */
            border-radius: 20px; /* More rounded */
            box-shadow: 0 15px 40px var(--shadow-medium); /* Very pronounced shadow */
            position: relative;
            text-align: center;
            animation: fadeInScale 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; /* Springy animation */
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .close-alert-btn {
            color: var(--color-input-border); /* Softer grey */
            font-size: 28px; /* Adjusted size */
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
        }

        .close-alert-btn:hover,
        .close-alert-btn:focus {
            color: var(--color-text-primary); /* Use CSS variable */
            transform: rotate(90deg);
        }

        #custom-alert-message {
            margin-bottom: 30px; /* More space */
            font-size: 1.3em; /* Larger message text */
            color: var(--color-text-primary); /* Use CSS variable */
            line-height: 1.5;
            font-weight: 500;
        }

        #custom-alert-ok-btn {
            background: linear-gradient(45deg, var(--color-cyan-gradient-start), var(--color-cyan-gradient-end)); /* Use CSS variables */
            color: white;
            padding: 15px 30px; /* More padding */
            border: none;
            border-radius: 10px; /* More rounded */
            cursor: pointer;
            font-size: 1.2em; /* Larger text */
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 12px var(--shadow-strong); /* Use CSS variable */
        }

        #custom-alert-ok-btn:hover {
            background: linear-gradient(45deg, var(--color-cyan-gradient-end), var(--color-cyan-gradient-start)); /* Use CSS variables */
            transform: translateY(-2px);
        }

        /* Theme Switcher specific styles */
        .theme-switcher {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align label and options to start */
            margin-top: 2em;
        }

        .theme-options {
            display: flex;
            gap: 1em;
            margin-top: 0.5em;
            width: 100%; /* Ensure options take full width */
            justify-content: flex-start; /* Align buttons to start */
        }

        .theme-options button {
            flex-grow: 1; /* Allow buttons to grow */
            max-width: 150px; /* Limit button width */
            text-align: center;
        }
        .theme-options button.active {
            box-shadow: 0 0 0 3px var(--color-cyan-primary); /* Highlight active theme */
            transform: translateY(-2px);
        }

        /* Post Specific Styles */
        .posts-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 700px; /* Make posts section wider */
            padding: 1em; /* Add padding for mobile */
        }

        .post-categories {
            display: flex;
            flex-direction: row; /* Default: horizontal for wider screens */
            justify-content: center;
            gap: 1em;
            margin-top: 1.5em;
            margin-bottom: 2em;
            width: 100%;
            flex-wrap: wrap; /* Important: Allows wrapping if space is tight */
        }

        .post-categories button {
            flex-grow: 1; /* Allows buttons to grow */
            max-width: 180px; /* Max width when in a row for wider screens */
            font-size: 1em;
            padding: 0.8em 1.5em;
            border-radius: 25px;
            box-sizing: border-box; /* Essential to include padding/border in width */
        }

        .post-categories button.active {
            background: var(--color-cyan-primary);
            color: white;
            box-shadow: 0 4px 10px var(--shadow-strong);
        }

        .post-item {
            background: var(--color-white);
            border-radius: 20px;
            box-shadow: 0 8px 25px var(--shadow-light);
            margin-bottom: 1em; /* Decreased margin */
            padding: 1em; /* Decreased padding */
            width: 100%; /* Ensure it takes full width */
            animation: fadeIn 0.6s ease-out forwards;
            border: 1px solid var(--color-border-light);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.8em; /* Decreased margin */
        }

        .post-avatar {
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            margin-right: 1em;
        }

        .post-username {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--color-cyan-dark);
        }

        .post-timestamp {
            font-size: 0.8em;
            color: var(--color-text-secondary);
            margin-left: auto;
        }

        .post-image {
            width: 100%;
            height: auto;
            max-height: 300px; /* Decreased max-height */
            object-fit: contain; /* Ensure entire image is visible */
            border-radius: 15px;
            margin-bottom: 0.8em; /* Decreased margin */
            border: 1px solid var(--color-border-light);
        }

        .post-description {
            font-size: 1em;
            margin-bottom: 1em; /* Decreased margin */
            line-height: 1.6;
            color: var(--color-text-primary);
            word-wrap: break-word; /* Ensure long text wraps */
        }

        .post-actions {
            display: flex;
            align-items: center;
            gap: 0.8em; /* Decreased gap */
            margin-bottom: 1em; /* Decreased margin */
            padding-top: 0.8em; /* Decreased padding */
            border-top: 1px solid var(--color-border-light);
        }

        .like-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1em; /* Reduced font size */
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
            padding: 0.4em 0.8em; /* Adjusted padding to be smaller */
            border-radius: 10px;
            width: auto; /* Allow button to shrink to content */
            flex-shrink: 0; /* Prevent button from growing */
        }

        .like-btn:hover {
            color: var(--color-cyan-primary);
            transform: scale(1.1);
        }

        .like-btn.liked {
            color: #ff4d4d; /* Red for liked */
            transform: scale(1.1);
        }

        .like-count {
            font-weight: 600;
            color: var(--color-text-primary);
            font-size: 0.9em;
        }

        .comment-section {
            border-top: 1px solid var(--color-border-light);
            padding-top: 1em; /* Decreased padding */
        }

        .comment-input-group {
            display: flex;
            gap: 0.5em;
            margin-bottom: 0.8em; /* Decreased margin */
        }

        .comment-input-group input {
            flex-grow: 1;
            padding: 0.6em; /* Reduced padding */
            border-radius: 10px;
            font-size: 0.9em; /* Reduced font size */
        }

        .comment-input-group button {
            padding: 0.4em 0.8em; /* Reduced padding */
            font-size: 0.8em; /* Reduced font size */
            border-radius: 10px;
            text-transform: none;
            letter-spacing: normal;
            box-shadow: none;
            flex-shrink: 1; /* Allow button to shrink if needed */
            min-width: 50px; /* Ensure it doesn't get too small */
        }

        .comment-list {
            max-height: 100px; /* Reduced max-height for comments */
            overflow-y: auto;
            padding-right: 8px; /* Space for scrollbar */
        }

        .comment-item {
            background: var(--color-light-blue-bg);
            border-radius: 12px;
            padding: 0.6em 0.8em; /* Reduced padding */
            margin-bottom: 0.4em; /* Reduced margin */
            font-size: 0.85em; /* Reduced font size */
            border: 1px solid var(--color-border-light);
        }

        .comment-item .comment-author {
            font-weight: 600;
            color: var(--color-cyan-dark);
            margin-right: 0.5em;
        }

        .comment-item .comment-text {
            color: var(--color-text-primary);
            word-wrap: break-word;
        }

        .comment-item .comment-timestamp {
            font-size: 0.7em;
            color: var(--color-text-secondary);
            text-align: right;
            margin-top: 0.3em;
        }

        /* Create Post Modal */
        #create-post-modal, #edit-post-modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 2002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .create-post-content, .edit-post-content {
            background-color: var(--color-modal-bg);
            margin: auto;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--shadow-medium);
            width: 95%;
            max-width: 600px;
            position: relative;
            animation: fadeInScale 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            display: flex; /* Use flexbox for layout */
            flex-direction: column;
            gap: 1em; /* Space between form groups */
        }

        .create-post-content h3, .edit-post-content h3 {
            font-size: 2em;
            color: var(--color-cyan-dark);
            margin-bottom: 0.5em; /* Adjusted margin */
            text-align: center;
        }

        .create-post-content .form-group, .edit-post-content .form-group {
            margin-bottom: 0; /* Remove default margin as gap handles it */
        }

        .create-post-content button, .edit-post-content button {
            width: auto;
            min-width: 150px;
            margin-top: 1em; /* Adjusted margin */
            align-self: center; /* Center the button */
        }

        .emoji-input-group {
            display: flex;
            gap: 0.5em;
            align-items: center;
            margin-top: 0.5em;
        }

        .emoji-input-group input {
            flex-grow: 1;
        }

        .emoji-input-group button {
            width: auto;
            padding: 0.5em 1em;
            font-size: 1.2em;
            border-radius: 10px;
            box-shadow: none;
            background: var(--color-border-light);
            color: var(--color-text-primary);
        }
        .emoji-input-group button:hover {
            background: var(--color-cyan-light);
        }

        .template-selector {
            margin-top: 1em; /* Adjusted margin */
            margin-bottom: 1em; /* Adjusted margin */
        }

        .template-selector select {
            width: 100%;
            padding: 1em;
            border-radius: 15px;
            border: 1px solid var(--color-input-border);
            background-color: var(--color-white);
            color: var(--color-text-primary);
            font-size: 1.05em;
        }
        
        /* Welcome Section Specific Styles */
        .welcome-section {
            text-align: center;
            max-width: 800px;
        }

        .welcome-section p {
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 1.5em;
            color: var(--color-text-primary);
        }

        .welcome-section ul {
            list-style: none;
            padding: 0;
            margin: 2em 0;
            text-align: left;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .welcome-section li {
            background: var(--color-light-blue-bg);
            padding: 1em 1.5em;
            border-radius: 15px;
            margin-bottom: 1em;
            display: flex;
            align-items: center;
            gap: 1em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--color-border-light);
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .welcome-section li strong {
            color: var(--color-cyan-dark);
            font-size: 1.1em;
        }

        .welcome-section .get-started-btn {
            margin-top: 2em;
            padding: 1em 2em;
            font-size: 1.2em;
        }

        /* Posts Studio Specific Styles */
        .posts-studio-section .posts-studio-header { /* Specific header for studio */
            width: 100%;
            max-width: 650px; /* Match section width */
            border-radius: 25px 25px 0 0; /* Rounded top, flat bottom */
            margin-bottom: 0; /* Remove default margin */
            padding: 1.5em 2em; /* Adjusted padding */
            box-shadow: none; /* No shadow here, section has it */
        }
        .posts-studio-section .posts-studio-header h2 {
            font-size: 2em; /* Slightly larger for studio header */
        }


        .posts-studio-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
            margin-top: 1.5em; /* Adjusted margin */
            margin-bottom: 2em;
            width: 100%;
            max-width: 550px;
            justify-content: center;
            align-items: center;
        }

        .posts-studio-controls input,
        .posts-studio-controls select {
            flex-grow: 1;
            min-width: 150px;
            padding: 0.8em;
            border-radius: 10px;
            font-size: 0.95em;
        }

        .posts-studio-analytics {
            background: var(--color-light-blue-bg);
            padding: 1em;
            border-radius: 15px;
            width: 100%;
            max-width: 550px;
            margin-top: 1em;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--color-border-light);
            color: var(--color-text-primary);
        }

        .posts-studio-analytics p {
            margin: 0.5em 0;
            font-size: 1em;
            font-weight: 600;
        }

        .posts-studio-analytics span {
            color: var(--color-cyan-dark);
            font-weight: 700;
        }

        .user-post-item {
            background: var(--color-white);
            border-radius: 20px;
            box-shadow: 0 8px 25px var(--shadow-light);
            margin-bottom: 1em;
            padding: 1em;
            width: 100%;
            animation: fadeIn 0.6s ease-out forwards;
            border: 1px solid var(--color-border-light);
            position: relative; /* For action buttons */
        }

        .user-post-item .post-header {
            margin-bottom: 0.8em;
        }

        .user-post-item .post-image {
            width: 100%;
            height: auto;
            max-height: 250px; /* Slightly smaller for studio view */
            object-fit: contain;
            border-radius: 15px;
            margin-bottom: 0.8em;
            border: 1px solid var(--color-border-light);
        }

        .user-post-item .post-description {
            font-size: 0.95em;
            margin-bottom: 1em;
            line-height: 1.6;
            color: var(--color-text-primary);
            word-wrap: break-word;
        }

        .user-post-actions {
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            gap: 0.8em;
            padding-top: 0.8em;
            border-top: 1px solid var(--color-border-light);
            margin-top: 1em;
        }

        .user-post-actions button {
            padding: 0.6em 1.2em;
            font-size: 0.9em;
            border-radius: 12px;
            text-transform: none;
            letter-spacing: normal;
            box-shadow: none;
            flex-shrink: 0;
            width: auto;
        }

        .user-post-actions .edit-btn {
            background: var(--color-cyan-primary);
            color: white;
        }

        .user-post-actions .delete-btn {
            background: #ff4d4d; /* Red for delete */
            color: white;
        }
        
        .user-post-actions .pin-btn, .user-post-actions .share-btn { /* New buttons */
            background: var(--color-border-light);
            color: var(--color-text-primary);
        }

        .user-post-actions .pin-btn.pinned {
            background: var(--color-cyan-dark);
            color: white;
        }
        
        .user-post-actions .pin-btn:hover, .user-post-actions .share-btn:hover {
            background: var(--color-cyan-light);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }


        /* Responsive adjustments */
        @media (min-width: 600px) { /* Restore larger padding for tablets and desktops */
            main {
                padding: 2em;
            }
        }

        @media (min-width: 480px) { /* Slightly more padding for medium-sized phones */
            .auth-form, .group-options, .chat-section, .contacts-section, .settings-section,
            .private-chat-section, .posts-section, .welcome-section, .posts-studio-section {
                padding: 2em;
            }
        }

        @media (min-width: 650px) { /* Apply wider max-width on larger screens */
            .auth-form, .group-options, .chat-section, .contacts-section, .settings-section,
            .private-chat-section, .posts-section, .welcome-section, .posts-studio-section {
                max-width: 650px;
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2.5em;
            }
            .header-tabs {
                gap: 0.8em;
            }
            .tab-btn {
                padding: 0.7em 1.5em;
                font-size: 1em;
                max-width: 150px;
            }
            /* Main padding already adjusted above for mobile */
            /* Section padding already adjusted above for mobile */
            .group-options button, .contacts-list button, .posts-section button, .posts-studio-section button {
                padding: 1em;
                margin: 0.6em 0;
                font-size: 1em;
                max-width: 250px; /* Adjusted max-width for smaller screens */
            }
            .group-item, .contact-item {
                padding: 1em;
                margin: 0.6em 0;
            }
            .group-avatar, .contact-avatar, .profile-avatar, .post-avatar {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
                margin-right: 1em;
            }
            .group-name, .contact-name {
                font-size: 1.1em;
            }
            .group-desc, .contact-status {
                font-size: 0.85em;
            }
            .message {
                padding: 1em 1.2em;
                font-size: 0.95em;
            }
            .chat-header h2, .private-chat-header h2, .posts-studio-header h2 {
                font-size: 1.5em;
            }
            .settings-menu {
                width: 300px;
            }
            .avatar-preview {
                width: 120px;
                height: 120px;
                font-size: 3em;
            }
            .user-id-display {
                padding: 1em;
                font-size: 0.9em;
            }
            .custom-alert-content {
                padding: 30px;
            }
            #custom-alert-message {
                font-size: 1.1em;
            }
            #custom-alert-ok-btn {
                padding: 12px 25px;
                font-size: 1.1em;
            }
            .create-post-content, .edit-post-content {
                padding: 20px;
                gap: 0.8em;
            }
            .create-post-content h3, .edit-post-content h3 {
                font-size: 1.8em;
            }
            .create-post-content input, .create-post-content textarea, .create-post-content select,
            .edit-post-content input, .edit-post-content textarea {
                font-size: 0.95em;
                padding: 0.8em;
            }
            .emoji-input-group button {
                font-size: 1em;
                padding: 0.4em 0.8em;
            }
            .welcome-section h2 {
                font-size: 2em;
            }
            .welcome-section p {
                font-size: 1em;
            }
            .welcome-section li {
                padding: 0.8em 1.2em;
                font-size: 0.9em;
            }
            .welcome-section li strong {
                font-size: 1em;
            }
            .welcome-section .get-started-btn {
                padding: 0.8em 1.8em;
                font-size: 1.1em;
            }
            .posts-studio-controls {
                flex-direction: column;
                max-width: 100%;
            }
            .posts-studio-controls input,
            .posts-studio-controls select {
                min-width: unset;
            }
            .user-post-actions button {
                padding: 0.5em 1em;
                font-size: 0.8em;
            }
        }

        @media (max-width: 600px) { /* Styles for screens up to 600px wide (most mobiles) */
            .post-categories {
                flex-direction: column; /* Stack buttons vertically */
                align-items: center; /* Center the stacked buttons */
                gap: 0.8em; /* Adjusted gap for vertical stacking */
            }

            .post-categories button {
                width: 90%; /* Take up most of the screen width when stacked */
                max-width: 300px; /* Limit max-width even when stacked for aesthetics */
                padding: 1em; /* Slightly more padding for stacked buttons */
                font-size: 1.1em; /* Slightly larger text for stacked buttons */
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 1em 0.5em;
            }
            header h1 {
                font-size: 2em;
            }
            .header-tabs {
                flex-direction: column;
                gap: 0.5em;
                margin-top: 1em;
            }
            .tab-btn {
                padding: 0.6em 1em;
                font-size: 0.9em;
                max-width: 100%;
            }
            /* Main padding already adjusted above for mobile */
            /* Section padding already adjusted above for mobile */
            .form-group {
                margin-bottom: 1em;
            }
            .form-group label {
                font-size: 1em;
                margin-bottom: 0.5em;
            }
            input, button, textarea {
                padding: 0.8em;
                font-size: 0.9em;
            }
            button {
                padding: 1em;
                font-size: 1em;
                max-width: unset; /* Allow full width on very small screens */
            }
            .group-options button, .contacts-list button, .posts-section button, .posts-studio-section button {
                padding: 0.8em;
                margin: 0.5em 0;
                font-size: 0.9em;
                max-width: unset; /* Allow full width on very small screens */
            }
            .group-item, .contact-item {
                padding: 0.8em;
                margin: 0.5em 0;
                flex-direction: column; /* Stack avatar and info */
                align-items: flex-start;
            }
            .group-avatar, .contact-avatar {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
                margin-right: 0;
                margin-bottom: 0.5em;
            }
            .group-info, .contact-info {
                text-align: center;
            }
            .group-name, .contact-name {
                font-size: 1em;
            }
            .group-desc, .contact-status {
                font-size: 0.8em;
            }
            .message {
                padding: 0.8em 1em;
                font-size: 0.85em;
                margin: 0.8em 0;
            }
            .message .sender {
                font-size: 0.8em;
            }
            .timestamp {
                font-size: 0.6em;
            }
            footer {
                padding: 0.8em;
                gap: 0.5em;
                flex-direction: column; /* Stack input and button */
            }
            #msg-input, #private-msg-input {
                padding: 0.7em;
                font-size: 0.85em;
                width: 100%; /* Take full width when stacked */
                max-width: unset; /* Remove max-width when stacked */
            }
            #send-btn, #send-private-btn {
                padding: 0.7em 1em;
                font-size: 0.85em;
                width: 100%; /* Take full width when stacked */
                max-width: unset; /* Remove max-width when stacked */
            }
            .chat-header h2, .private-chat-header h2, .posts-studio-header h2 {
                font-size: 1.2em;
            }
            .back-btn {
                font-size: 1.5em;
            }
            .group-settings-btn {
                width: 30px;
                height: 30px;
                font-size: 1em;
            }
            .settings-menu {
                width: 100%;
                padding: 1.5em;
            }
            .settings-header h3 {
                font-size: 1.5em;
            }
            .close-settings {
                font-size: 1.5em;
            }
            .avatar-preview {
                width: 100px;
                height: 100px;
                font-size: 2.5em;
            }
            .user-id-display {
                padding: 0.8em;
                font-size: 0.8em;
            }
            .custom-alert-content {
                padding: 20px;
            }
            #custom-alert-message {
                font-size: 1em;
            }
            #custom-alert-ok-btn {
                padding: 10px 20px;
                font-size: 1em;
            }
            .posts-section {
                padding: 0.5em;
            }
            .post-item {
                padding: 1em;
            }
            .post-avatar {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
            }
            .post-username {
                font-size: 1em;
            }
            .post-description {
                font-size: 0.9em;
            }
            .like-btn {
                font-size: 1em;
            }
            .like-count {
                font-size: 0.8em;
            }
            .comment-input-group input, .comment-input-group button {
                font-size: 0.8em;
                padding: 0.6em;
                width: 100%; /* Take full width when stacked */
                max-width: unset; /* Remove max-width when stacked */
            }
            .comment-input-group {
                flex-direction: column; /* Stack input and button */
            }
            .comment-item {
                font-size: 0.8em;
            }
            .create-post-content, .edit-post-content {
                padding: 15px;
                gap: 0.6em;
            }
            .create-post-content h3, .edit-post-content h3 {
                font-size: 1.5em;
            }
            .create-post-content input, .create-post-content textarea, .create-post-content select,
            .edit-post-content input, .edit-post-content textarea {
                font-size: 0.85em;
                padding: 0.7em;
            }
            .emoji-input-group button {
                font-size: 0.9em;
                padding: 0.3em 0.6em;
            }
            .welcome-section h2 {
                font-size: 1.8em;
            }
            .welcome-section p {
                font-size: 0.9em;
            }
            .welcome-section li {
                font-size: 0.8em;
                padding: 0.7em 1em;
            }
            .welcome-section li strong {
                font-size: 0.9em;
            }
            .welcome-section .get-started-btn {
                padding: 0.7em 1.5em;
                font-size: 1em;
            }
        }

        @media (max-width: 400px) {
            .tab-btn {
                padding: 0.7em 1.2em; /* Slightly reduced padding */
                font-size: 0.9em; /* Slightly reduced font size */
            }
            .comment-input-group {
                flex-direction: column; /* Stack input and button */
            }
            .comment-input-group input,
            .comment-input-group button {
                width: 100%; /* Each takes full width when stacked */
                max-width: unset; /* Remove max-width when stacked */
            }
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading ThunderChat...</div>
    </div>

    <header>
        <h1>ThunderChat</h1>
        <div class="header-tabs">
            <button id="welcome-tab" class="tab-btn active">Welcome</button> 
            <button id="groups-tab" class="tab-btn">Groups</button>
            <button id="contacts-tab" class="tab-btn">Contacts</button>
            <button id="posts-tab" class="tab-btn">Posts</button>
            <button id="settings-tab" class="tab-btn">Settings</button>
        </div>
    </header>

    <main>
        <div id="auth-section" class="auth-form">
            <div id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input id="login-email" type="email" placeholder="Enter your email" />
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input id="login-password" type="password" placeholder="Enter your password" />
                </div>
                <button id="login-btn">Login</button>
                <div id="toggle-to-register" class="toggle-form">Don't have an account? Register</div>
            </div>

            <div id="register-form" style="display: none;">
                <div class="form-group">
                    <label for="reg-username">Username</label>
                    <input id="reg-username" type="text" placeholder="Choose a username" />
                </div>
                <div class="form-group">
                    <label for="reg-email">Email</label>
                    <input id="reg-email" type="email" placeholder="Enter your email" />
                </div>
                <div class="form-group">
                    <label for="reg-password">Password</label>
                    <input id="reg-password" type="password" placeholder="Create a password" />
                </div>
                <button id="register-btn">Register</button>
                <div id="toggle-to-login" class="toggle-form">Already have an account? Login</div>
            </div>
        </div>

        <div id="welcome-section" class="welcome-section"> 
            <h2>Welcome to ThunderChat! </h2>
            <p>Your all-in-one platform for seamless communication and community engagement. Connect with friends, family, and new people through secure group chats, private messages, and engaging community posts.</p>
            <h3>Key Features:</h3>
            <ul>
                <li><strong>Groups:</strong> Create or join private and public groups to chat with multiple people.</li>
                <li><strong>Contacts:</strong> Easily add and manage your contacts for one-on-one private conversations.</li>
                <li><strong>Posts:</strong> Share images and text with the community, like and comment on others' posts, and discover new content in "New" and "Trending" feeds.</li>
                <li><strong>Settings:</strong> Customize your profile, update your status, change your avatar, and switch between light and dark themes.</li>
            </ul>
            <button id="get-started-btn" class="get-started-btn">Get Started!</button>
        </div>

        <div id="group-options" class="group-options">
            <h2>Welcome, <span id="username-display"></span></h2>
            <button id="create-group-btn">Create Group </button>
            <button id="join-group-btn">Join New Group </button>
            
            <div class="groups-list">
                <h3>Your Groups (<span id="groups-count">0</span>)</h3>
                <div id="joined-groups-list">
                    <div class="no-groups">You haven't joined any groups yet</div>
                </div>
            </div>
        </div>

        <div id="chat-section" class="chat-section">
            <div class="chat-header">
                <button class="back-btn" id="back-btn"></button>
                <h2 id="group-name-display"></h2>
                <button class="group-settings-btn" id="group-settings-btn"></button>
            </div>
            <div id="messages"></div>
            <footer>
                <input id="msg-input" type="text" placeholder="Type a message..." />
                <button id="send-btn">Send </button>
            </footer>
        </div>

        <div id="contacts-section" class="contacts-section">
            <div class="contacts-list">
                <h2>Your Contacts</h2>
                <button id="add-contact-btn">Add Contact </button>
                
                <div class="contacts-container">
                    <div id="contacts-list">
                        <div class="no-contacts">You don't have any contacts yet</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="private-chat-section" class="private-chat-section">
            <div class="private-chat-header">
                <button class="back-btn" id="back-private-btn"></button>
                <h2 id="contact-name-display"></h2>
                </div>
            <div id="private-messages"></div>
            <footer>
                <input id="private-msg-input" type="text" placeholder="Type a message..." />
                <button id="send-private-btn">Send </button>
            </footer>
        </div>

        <div id="posts-section" class="posts-section">
            <h2>Community Posts</h2>
            <button id="create-post-btn">Create New Post </button>
            
            <div class="post-categories">
                <button id="new-posts-btn" class="secondary active">New</button>
                <button id="trending-posts-btn" class="secondary">Trending</button>
            </div>

            <div id="posts-container" class="posts-container">
                <div class="no-posts">No posts available yet. Be the first to share!</div>
            </div>
        </div>

        <div id="posts-studio-section" class="posts-studio-section">
            <div class="posts-studio-header"> <button class="back-btn" id="back-to-settings-btn"></button>
                <h2>Your Posts Studio</h2>
                <div></div> </div>
            <div class="posts-studio-controls">
                <input type="text" id="post-studio-search" placeholder="Search your posts..." />
                <select id="post-studio-sort">
                    <option value="newest">Sort by: Newest</option>
                    <option value="oldest">Sort by: Oldest</option>
                    <option value="most-likes">Sort by: Most Likes</option>
                    <option value="most-comments">Sort by: Most Comments</option>
                </select>
            </div>
            <div class="posts-studio-analytics">
                <p>Total Posts: <span id="total-posts-count">0</span></p>
                <p>Total Likes Received: <span id="total-likes-received">0</span></p>
                <p>Total Comments Received: <span id="total-comments-received">0</span></p>
            </div>
            <div id="user-posts-list" class="user-posts-list">
                <h3>Your Uploaded Posts</h3>
                <div class="no-user-posts">You haven't uploaded any posts yet.</div>
            </div>
        </div>

        <div id="settings-section" class="settings-section">
            <h2>Your Profile</h2>
            
            <div class="avatar-upload">
                <div class="avatar-preview" id="profile-avatar-preview">
                    
                </div>
                <div class="form-group" style="width: 100%;">
                    <label for="profile-avatar-url">Profile Picture URL</label>
                    <input type="text" id="profile-avatar-url" placeholder="Enter image URL" />
                </div>
            </div>
            
            <div class="form-group">
                <label for="profile-username">Username</label>
                <input id="profile-username" type="text" placeholder="Your username" />
                </div>
            
            <div class="form-group">
                <label for="profile-status">Status</label>
                <input id="profile-status" type="text" placeholder="Your status" />
            </div>

            <div class="form-group theme-switcher">
                <label>Theme</label>
                <div class="theme-options">
                    <button id="light-theme-btn" class="secondary">Light</button>
                    <button id="dark-theme-btn" class="secondary">Dark</button>
                </div>
            </div>
            
            <div class="user-id-display">
                <strong>Your ID:</strong>
                <div id="user-id-text">Loading...</div>
                </div>
            
            <button id="posts-studio-btn" class="secondary">Posts Studio </button> <button id="save-profile-btn">Save Changes </button>
            <button id="logout-btn" class="secondary">Logout </button>
        </div>
    </main>

    <div id="group-settings-menu" class="settings-menu">
        <div class="settings-header">
            <h3>Group Settings</h3>
            <button class="close-settings" id="close-group-settings"></button>
        </div>
        
        <div class="avatar-upload">
            <div class="avatar-preview" id="group-avatar-preview">
                
            </div>
            <div class="form-group" style="width: 100%;">
                <label for="group-avatar-url">Group Picture URL</label>
                <input type="text" id="group-avatar-url" placeholder="Enter image URL" />
            </div>
        </div>
        
        <div class="form-group">
            <label>Group Name</label>
            <input id="group-name-setting" type="text" readonly />
            <small>Note: Group name cannot be changed.</small>
        </div>
        
        <div class="form-group">
            <label>Group Password</label>
            <input id="group-password-setting" type="text" readonly />
            <small>Note: Group password cannot be changed.</small>
        </div>
        
        <div class="form-group">
            <label for="group-desc-setting">Group Description</label>
            <textarea id="group-desc-setting" placeholder="Enter group description"></textarea>
        </div>
        
        <button id="save-group-settings-btn">Save Changes </button>
    </div>

    <div id="create-post-modal" class="custom-alert-modal">
        <div class="create-post-content">
            <span id="close-create-post-modal" class="close-alert-btn">&times;</span>
            <h3>Create New Post</h3>
            <div class="form-group template-selector">
                <label for="post-template-select">Choose a Template</label>
                <select id="post-template-select">
                    <option value="">-- Select a template --</option>
                    <option value="announcement"> Announcement</option>
                    <option value="inspiration"> Daily Inspiration</option>
                    <option value="question"> Question of the Day</option>
                    <option value="sale"> Item for Sale</option>
                </select>
            </div>
            <div class="form-group">
                <label for="post-image-url">Image URL (Optional)</label>
                <input type="text" id="post-image-url" placeholder="Enter image URL" />
            </div>
            <div class="form-group">
                <label for="post-description">Post Content</label>
                <textarea id="post-description" placeholder="What's on your mind?"></textarea>
                <div class="emoji-input-group">
                    <input type="text" id="emoji-input" placeholder="Type emoji (e.g., )" maxlength="2" />
                    <button id="add-emoji-btn">Add Emoji</button>
                </div>
            </div>
            <button id="submit-post-btn">Post It! </button>
        </div>
    </div>

    <div id="edit-post-modal" class="custom-alert-modal">
        <div class="edit-post-content">
            <span id="close-edit-post-modal" class="close-alert-btn">&times;</span>
            <h3>Edit Post</h3>
            <div class="form-group">
                <label for="edit-post-image-url">Image URL (Optional)</label>
                <input type="text" id="edit-post-image-url" placeholder="Enter image URL" />
            </div>
            <div class="form-group">
                <label for="edit-post-description">Post Content</label>
                <textarea id="edit-post-description" placeholder="Edit your post content"></textarea>
                <div class="emoji-input-group">
                    <input type="text" id="edit-emoji-input" placeholder="Type emoji (e.g., )" maxlength="2" />
                    <button id="add-edit-emoji-btn">Add Emoji</button>
                </div>
            </div>
            <button id="save-edited-post-btn">Save Changes </button>
        </div>
    </div>

    <div id="custom-alert-modal" class="custom-alert-modal">
        <div class="custom-alert-content">
            <span id="close-alert-btn" class="close-alert-btn">&times;</span>
            <p id="custom-alert-message"></p>
            <button id="custom-alert-ok-btn">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            push, 
            onChildAdded, 
            get, 
            child,
            update,
            onValue,
            remove // Import remove for deleting posts
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBD4bDQgVtMd9cwq9Hfdz54NYSBcQvPr1Y",
            authDomain: "thunderboundthunderchat.firebaseapp.com",
            databaseURL: "https://thunderboundthunderchat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "thunderboundthunderchat",
            storageBucket: "thunderboundthunderchat.appspot.com",
            messagingSenderId: "79690962383",
            appId: "1:79690962383:web:fecf12881a13a4fdf22eba"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authSection = document.getElementById('auth-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const welcomeSection = document.getElementById('welcome-section');
        const groupOptions = document.getElementById('group-options');
        const chatSection = document.getElementById('chat-section');
        const contactsSection = document.getElementById('contacts-section');
        const privateChatSection = document.getElementById('private-chat-section');
        const postsSection = document.getElementById('posts-section'); 
        const postsStudioSection = document.getElementById('posts-studio-section');
        const settingsSection = document.getElementById('settings-section');
        const messagesDiv = document.getElementById('messages');
        const privateMessagesDiv = document.getElementById('private-messages');
        const usernameDisplay = document.getElementById('username-display');
        const groupNameDisplay = document.getElementById('group-name-display');
        const contactNameDisplay = document.getElementById('contact-name-display');
        const joinedGroupsList = document.getElementById('joined-groups-list');
        const groupsCount = document.getElementById('groups-count');
        const contactsList = document.getElementById('contacts-list');
        const postsContainer = document.getElementById('posts-container'); 
        const userPostsList = document.getElementById('user-posts-list');
        const welcomeTab = document.getElementById('welcome-tab');
        const groupsTab = document.getElementById('groups-tab');
        const contactsTab = document.getElementById('contacts-tab');
        const postsTab = document.getElementById('posts-tab'); 
        const settingsTab = document.getElementById('settings-tab');
        const groupSettingsMenu = document.getElementById('group-settings-menu');
        const closeGroupSettings = document.getElementById('close-group-settings');
        const groupSettingsBtn = document.getElementById('group-settings-btn');
        const addContactBtn = document.getElementById('add-contact-btn');
        const profileAvatarPreview = document.getElementById('profile-avatar-preview');
        const groupAvatarPreview = document.getElementById('group-avatar-preview');
        
        const profileAvatarUrlInput = document.getElementById('profile-avatar-url');
        const groupAvatarUrlInput = document.getElementById('group-avatar-url');

        const userIdText = document.getElementById('user-id-text');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const saveGroupSettingsBtn = document.getElementById('save-group-settings-btn');

        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const regUsernameInput = document.getElementById('reg-username');
        const regEmailInput = document.getElementById('reg-email');
        const regPasswordInput = document.getElementById('reg-password');
        const registerBtn = document.getElementById('register-btn');
        const toggleToRegister = document.getElementById('toggle-to-register');
        const toggleToLogin = document.getElementById('toggle-to-login');

        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
        const closeAlertBtn = document.getElementById('close-alert-btn');

        const lightThemeBtn = document.getElementById('light-theme-btn');
        const darkThemeBtn = document.getElementById('dark-theme-btn');

        const createPostBtn = document.getElementById('create-post-btn');
        const newPostsBtn = document.getElementById('new-posts-btn');
        const trendingPostsBtn = document.getElementById('trending-posts-btn');
        const createPostModal = document.getElementById('create-post-modal');
        const closeCreatePostModal = document.getElementById('close-create-post-modal');
        const postImageUrlInput = document.getElementById('post-image-url');
        const postDescriptionInput = document.getElementById('post-description');
        const submitPostBtn = document.getElementById('submit-post-btn');
        const postTemplateSelect = document.getElementById('post-template-select');
        const emojiInput = document.getElementById('emoji-input');
        const addEmojiBtn = document.getElementById('add-emoji-btn');

        const getStartedBtn = document.getElementById('get-started-btn');

        // Posts Studio elements
        const postsStudioBtn = document.getElementById('posts-studio-btn');
        const backToSettingsBtn = document.getElementById('back-to-settings-btn');
        const postStudioSearchInput = document.getElementById('post-studio-search');
        const postStudioSortSelect = document.getElementById('post-studio-sort');
        const totalPostsCountSpan = document.getElementById('total-posts-count');
        const totalLikesReceivedSpan = document.getElementById('total-likes-received');
        const totalCommentsReceivedSpan = document.getElementById('total-comments-received');

        // Edit Post Modal elements
        const editPostModal = document.getElementById('edit-post-modal');
        const closeEditPostModal = document.getElementById('close-edit-post-modal');
        const editPostImageUrlInput = document.getElementById('edit-post-image-url');
        const editPostDescriptionInput = document.getElementById('edit-post-description');
        const editEmojiInput = document.getElementById('edit-emoji-input');
        const addEditEmojiBtn = document.getElementById('add-edit-emoji-btn');
        const saveEditedPostBtn = document.getElementById('save-edited-post-btn');

        let currentGroup = "";
        let currentContact = "";
        let currentPostCategory = "new"; // Default post category for community posts
        let currentUser = null;
        let userGroups = [];
        let userContacts = [];
        let userData = {}; // Stores additional user profile data from Realtime DB
        let allPosts = []; // Store all community posts for sorting
        let userPosts = []; // Store only current user's posts for Posts Studio
        let editingPostId = null; // To keep track of the post being edited

        // Listener references for cleanup - these will now store unsubscribe functions
        let currentGroupChatUnsubscribe = null;
        let currentPrivateChatUnsubscribe = null;
        let currentCommunityPostsUnsubscribe = null;
        let currentUserPostsUnsubscribe = null;
        let alertTimeoutId = null; // To manage alert auto-hide

        // Initialize the app
        window.addEventListener('DOMContentLoaded', () => {
            loadingScreen.style.display = 'none';
            loadUserTheme(); // Load theme as soon as possible
            showSection('welcome-section'); // Show welcome section by default
        });

        // Custom Alert Modal functions
        function showAlert(message, duration = 3000) { // Default duration 3 seconds
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex'; // Use flex to center
            clearTimeout(alertTimeoutId); // Clear any existing timeout
            alertTimeoutId = setTimeout(hideAlert, duration);
        }

        function hideAlert() {
            customAlertModal.style.display = 'none';
        }

        customAlertOkBtn.addEventListener('click', hideAlert);
        closeAlertBtn.addEventListener('click', hideAlert);

        // --- Theme Switcher Logic ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                darkThemeBtn.classList.add('active');
                lightThemeBtn.classList.remove('active');
            } else {
                document.body.classList.remove('dark-theme');
                lightThemeBtn.classList.add('active');
                darkThemeBtn.classList.remove('active');
            }
            // Save theme preference to local storage
            localStorage.setItem('theme', theme);
            // Optionally, save to Firebase for cross-device sync
            if (currentUser && currentUser.uid) {
                update(ref(db, `users/${currentUser.uid}`), { theme: theme }).catch(e => console.error("Failed to save theme to DB:", e));
            }
        }

        async function loadUserTheme() {
            let savedTheme = localStorage.getItem('theme');
            if (currentUser && currentUser.uid) {
                const snapshot = await get(child(ref(db), `users/${currentUser.uid}/theme`));
                if (snapshot.exists()) {
                    savedTheme = snapshot.val();
                }
            }
            applyTheme(savedTheme || 'light'); // Default to light if no theme saved
        }

        lightThemeBtn.addEventListener('click', () => applyTheme('light'));
        darkThemeBtn.addEventListener('click', () => applyTheme('dark'));


        // --- Auth Functionality ---

        // Toggle between login and register forms
        toggleToRegister.addEventListener('click', () => {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        });

        toggleToLogin.addEventListener('click', () => {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        // Function to generate a memorable ID
        function generateMemorableId() {
            const randomNumber = Math.floor(1000 + Math.random() * 9000); // 4-digit number
            return `${randomNumber}ThunderChat`;
        }

        // Register User
        registerBtn.addEventListener('click', async () => {
            const email = regEmailInput.value;
            const password = regPasswordInput.value;
            const username = regUsernameInput.value;

            if (!email || !password || !username) {
                showAlert('Please fill in all registration fields.');
                return;
            }

            showLoading('Registering...');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const memorableId = generateMemorableId(); // Generate memorable ID

                // Store user data in Realtime Database
                await set(ref(db, `users/${user.uid}`), {
                    username: username,
                    email: email,
                    status: 'Online',
                    avatarUrl: '', // Default empty avatar URL
                    theme: 'light', // Default theme for new users
                    memorableId: memorableId // Store the memorable ID
                });

                // Immediately update the user ID display after successful registration
                userIdText.textContent = memorableId; 

                hideLoading();
                showAlert('Registration successful! You are now logged in.');
                // onAuthStateChanged will handle UI update
            } catch (error) {
                hideLoading();
                console.error("Error during registration:", error);
                showAlert(`Registration failed: ${error.message}`);
            }
        });

        // Login User
        loginBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            if (!email || !password) {
                showAlert('Please enter your email and password.');
                return;
            }

            showLoading('Logging in...');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideLoading();
                showAlert('Login successful!');
                // onAuthStateChanged will handle UI update
            } catch (error) {
                hideLoading();
                console.error("Error during login:", error);
                showAlert(`Login failed: ${error.message}`);
            }
        });

        // Auth state handler
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                showLoading('Loading your data...');
                const snapshot = await get(child(ref(db), `users/${user.uid}`));
                if (snapshot.exists()) {
                    currentUser = { ...user, ...snapshot.val() }; // Merge Firebase Auth user with Realtime DB data
                    userData = snapshot.val(); // Keep userData for other profile updates
                    hideLoading();
                    
                    authSection.style.display = 'none';
                    welcomeSection.style.display = 'none'; // Hide welcome section after login
                    groupOptions.style.display = 'flex'; // Show groups by default after login
                    groupsTab.classList.add('active'); // Set groups tab as active
                    usernameDisplay.textContent = currentUser.username;
                    
                    // Initialize sections after login
                    loadUserGroups();
                    loadUserContacts();
                    loadPosts(); // Load community posts after login
                    loadUserPostsForStudio(); // Load user's own posts for studio
                    loadUserProfile();
                    loadUserTheme(); // Re-load theme after user data is available
                } else {
                    // This case might happen if user registered but data wasn't saved (e.g., error)
                    hideLoading();
                    showAlert('User data not found in database. Please contact support or try registering again.');
                    signOut(auth); // Force logout if user data is missing
                }
            } else {
                hideLoading();
                authSection.style.display = 'flex'; // Show auth section
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                welcomeSection.style.display = 'none'; // Hide welcome section on logout
                groupOptions.style.display = 'none';
                chatSection.style.display = 'none';
                contactsSection.style.display = 'none';
                privateChatSection.style.display = 'none';
                postsSection.style.display = 'none'; 
                postsStudioSection.style.display = 'none'; // Hide posts studio on logout
                settingsSection.style.display = 'none';
                // Reset current user info on logout
                currentUser = null;
                userData = {};
                userGroups = [];
                userContacts = [];
                allPosts = []; // Clear community posts on logout
                userPosts = []; // Clear user's own posts on logout
                applyTheme('light'); // Revert to default theme on logout
                showSection('welcome-section'); // Show welcome section again on logout
            }
        });


        // Tab switching
        function showSection(sectionId) {
            const sections = [welcomeSection, groupOptions, chatSection, contactsSection, privateChatSection, postsSection, postsStudioSection, settingsSection];
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.style.display = 'flex';
                } else {
                    section.style.display = 'none';
                }
            });

            // Update active tab button
            const tabs = [welcomeTab, groupsTab, contactsTab, postsTab, settingsTab];
            tabs.forEach(tab => {
                if (tab.id.includes(sectionId.replace('-section', ''))) { // Simple mapping
                    tab.classList.add('active');
                } else if (tab.id.includes('groups') && sectionId === 'group-options') {
                    tab.classList.add('active');
                } else if (tab.id.includes('welcome') && sectionId === 'welcome-section') { // Handle welcome tab
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        welcomeTab.addEventListener('click', () => { // New Welcome Tab Listener
            showSection('welcome-section');
        });

        getStartedBtn.addEventListener('click', () => { // Get Started button on Welcome page
            if (currentUser) {
                showSection('group-options');
            } else {
                showSection('auth-section');
            }
        });

        groupsTab.addEventListener('click', () => {
            if (!currentUser) { showAlert("Please log in to access groups."); return; }
            showSection('group-options');
        });

        contactsTab.addEventListener('click', () => {
            if (!currentUser) { showAlert("Please log in to access contacts."); return; }
            showSection('contacts-section');
            loadUserContacts(); // Reload contacts when tab is clicked
        });

        postsTab.addEventListener('click', () => { 
            if (!currentUser) { showAlert("Please log in to access posts."); return; }
            showSection('posts-section');
            loadPosts(); // Load community posts when tab is clicked
        });

        settingsTab.addEventListener('click', () => {
            if (!currentUser) { showAlert("Please log in to access settings."); return; }
            showSection('settings-section');
            loadUserProfile();
        });

        // New: Posts Studio button in settings
        postsStudioBtn.addEventListener('click', () => {
            if (!currentUser) { showAlert("Please log in to access Posts Studio."); return; }
            showSection('posts-studio-section');
            loadUserPostsForStudio();
        });

        // New: Back button from Posts Studio to Settings
        backToSettingsBtn.addEventListener('click', () => {
            showSection('settings-section');
            loadUserProfile(); // Reload profile just in case
        });


        // Group settings
        groupSettingsBtn.addEventListener('click', () => {
            groupSettingsMenu.classList.add('open');
            loadGroupSettings();
        });

        closeGroupSettings.addEventListener('click', () => {
            groupSettingsMenu.classList.remove('open');
        });

        // Save profile
        saveProfileBtn.addEventListener('click', async () => {
            const username = document.getElementById('profile-username').value;
            const status = document.getElementById('profile-status').value;
            const avatarUrl = profileAvatarUrlInput.value.trim(); // Get URL from input
            
            showLoading('Saving profile...');
            try {
                await update(ref(db, `users/${currentUser.uid}`), {
                    username,
                    status,
                    avatarUrl // Use the URL directly
                });
                
                // Update local data and display
                userData = { ...userData, username, status, avatarUrl };
                currentUser.username = username; // Update currentUser's username
                usernameDisplay.textContent = username;
                
                hideLoading();
                showAlert('Profile saved successfully!');
                loadUserProfile(); // Reload profile to ensure avatar is updated
            } catch (error) {
                hideLoading();
                console.error("Error saving profile:", error);
                showAlert(`Failed to save profile: ${error.message}`);
            }
        });

        // Save group settings
        saveGroupSettingsBtn.addEventListener('click', async () => {
            const description = document.getElementById('group-desc-setting').value;
            const groupAvatarUrl = groupAvatarUrlInput.value.trim(); // Get URL from input
            
            showLoading('Saving group settings...');
            try {
                await update(ref(db, `groups/${currentGroup}`), {
                    description,
                    avatarUrl: groupAvatarUrl // Use the URL directly
                });
                
                hideLoading();
                groupSettingsMenu.classList.remove('open');
                showAlert('Group settings saved!');
                loadUserGroups(); // Reload groups to reflect changes
            } catch (error) {
                hideLoading();
                console.error("Error saving group settings:", error);
                showAlert(`Failed to save group settings: ${error.message}`);
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            showLoading('Logging out...');
            try {
                await signOut(auth);
                hideLoading();
                // The onAuthStateChanged listener will handle redirecting to auth section
            } catch (error) {
                hideLoading();
                console.error("Error during logout:", error);
                showAlert(`Logout failed: ${error.message}`);
            }
        });

        // Add contact
        addContactBtn.addEventListener('click', () => {
            const contactId = prompt("Enter the user's ID you want to add:");
            if (contactId) {
                if (contactId === currentUser.memorableId) { // Check against memorableId
                    showAlert("You can't add yourself as a contact!");
                } else {
                    addContact(contactId);
                }
            }
        });

        // Load user profile
        async function loadUserProfile() {
            if (!currentUser || !currentUser.uid) return;
            
            const snapshot = await get(child(ref(db), `users/${currentUser.uid}`));
            if (snapshot.exists()) {
                userData = snapshot.val();
                document.getElementById('profile-username').value = userData.username || '';
                document.getElementById('profile-status').value = userData.status || '';
                profileAvatarUrlInput.value = userData.avatarUrl || ''; // Populate URL input
                
                // Display the memorable ID if available, otherwise fallback to Firebase UID
                userIdText.textContent = userData.memorableId || currentUser.uid;
                
                if (userData.avatarUrl) {
                    profileAvatarPreview.innerHTML = `<img src="${userData.avatarUrl}" alt="Profile" onerror="this.onerror=null;this.src='https://placehold.co/140x140/00bcd4/ffffff?text=${userData.username?.charAt(0).toUpperCase() || 'U'}'" />`;
                    profileAvatarPreview.style.backgroundColor = 'transparent'; // Reset background for image
                    profileAvatarPreview.style.color = 'inherit';
                } else {
                    profileAvatarPreview.innerHTML = `<div>${userData.username?.charAt(0).toUpperCase() || 'U'}</div>`;
                    profileAvatarPreview.style.backgroundColor = 'var(--color-cyan-primary)'; // Fallback background
                    profileAvatarPreview.style.color = 'white';
                }
            }
        }

        // Load group settings
        async function loadGroupSettings() {
            if (!currentGroup) return;
            
            const snapshot = await get(child(ref(db), `groups/${currentGroup}`));
            if (snapshot.exists()) {
                const groupData = snapshot.val();
                document.getElementById('group-name-setting').value = currentGroup;
                document.getElementById('group-password-setting').value = groupData.password || 'No password set';
                document.getElementById('group-desc-setting').value = groupData.description || '';
                groupAvatarUrlInput.value = groupData.avatarUrl || ''; // Populate URL input
                
                if (groupData.avatarUrl) {
                    groupAvatarPreview.innerHTML = `<img src="${groupData.avatarUrl}" alt="Group" onerror="this.onerror=null;this.src='https://placehold.co/140x140/00bcd4/ffffff?text=${currentGroup.charAt(0).toUpperCase()}'" />`;
                    groupAvatarPreview.style.backgroundColor = 'transparent'; // Reset background for image
                    groupAvatarPreview.style.color = 'inherit';
                } else {
                    groupAvatarPreview.innerHTML = `<div>${currentGroup.charAt(0).toUpperCase()}</div>`;
                    groupAvatarPreview.style.backgroundColor = 'var(--color-cyan-primary)'; // Fallback background
                    groupAvatarPreview.style.color = 'white';
                }
            }
        }

        // Add contact function
        async function addContact(contactId) {
            showLoading('Adding contact...');
            
            // Check if user exists (by memorable ID or Firebase UID)
            let targetUserId = null;
            const usersRef = ref(db, 'users');
            const usersSnapshot = await get(usersRef);

            if (usersSnapshot.exists()) {
                usersSnapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    if (user.memorableId === contactId || childSnapshot.key === contactId) {
                        targetUserId = childSnapshot.key;
                        return true; // Break forEach loop
                    }
                });
            }

            if (!targetUserId) {
                hideLoading();
                showAlert('User not found!');
                return;
            }
            
            if (targetUserId === currentUser.uid) {
                hideLoading();
                showAlert("You can't add yourself as a contact!");
                return;
            }

            // Check if already in contacts
            const contactsSnapshot = await get(child(ref(db), `userContacts/${currentUser.uid}`));
            if (contactsSnapshot.exists() && contactsSnapshot.val()[targetUserId]) {
                hideLoading();
                showAlert('This user is already in your contacts!');
                return;
            }
            
            // Add to contacts
            await set(ref(db, `userContacts/${currentUser.uid}/${targetUserId}`), {
                addedAt: Date.now()
            });
            
            // Optionally, add reverse contact
            // This creates a mutual connection. Decide if this is desired behavior.
            await set(ref(db, `userContacts/${targetUserId}/${currentUser.uid}`), {
                addedAt: Date.now()
            });
            
            hideLoading();
            loadUserContacts();
            showAlert('Contact added successfully!');
        }

        // Load user contacts
        async function loadUserContacts() {
            if (!currentUser) return;
            
            try {
                const snapshot = await get(child(ref(db), `userContacts/${currentUser.uid}`));
                if (snapshot.exists()) {
                    const contacts = snapshot.val();
                    const contactIds = Object.keys(contacts);
                    
                    // Get details for each contact
                    userContacts = [];
                    for (const contactId of contactIds) {
                        const userSnapshot = await get(child(ref(db), `users/${contactId}`));
                        if (userSnapshot.exists()) {
                            userContacts.push({
                                id: contactId,
                                ...userSnapshot.val(),
                                ...contacts[contactId]
                            });
                        }
                    }
                    
                    renderContactsList();
                } else {
                    userContacts = [];
                    renderContactsList();
                }
            } catch (error) {
                console.error("Error loading contacts:", error);
                userContacts = [];
                renderContactsList();
            }
        }

        // Render contacts list
        function renderContactsList() {
            if (userContacts.length === 0) {
                contactsList.innerHTML = '<div class="no-contacts">You don\'t have any contacts yet</div>';
                return;
            }
            
            contactsList.innerHTML = userContacts.map(contact => `
                <div class="contact-item" data-contact="${contact.id}">
                    <div class="contact-avatar">
                        ${contact.avatarUrl ? 
                            `<img src="${contact.avatarUrl}" alt="${contact.username}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/00bcd4/ffffff?text=${contact.username?.charAt(0).toUpperCase() || 'U'}'" />` : 
                            `<div>${contact.username?.charAt(0).toUpperCase() || 'U'}</div>`}
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.username || 'Unknown User'}</div>
                        <div class="contact-status">${contact.status || 'No status'}</div>
                    </div>
                </div>
            `).join('');

            // Apply styles for fallback avatars (initials)
            document.querySelectorAll('.contact-avatar div').forEach(div => {
                div.style.backgroundColor = 'var(--color-cyan-primary)'; /* Use the primary cyan */
                div.style.color = 'white';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.fontSize = '1.8em'; /* Larger initials */
            });
            
            // Add click event to contacts
            document.querySelectorAll('.contact-item').forEach(item => {
                item.addEventListener('click', () => {
                    const contactId = item.getAttribute('data-contact');
                    const contact = userContacts.find(c => c.id === contactId);
                    if (contact) {
                        enterPrivateChat(contact);
                    }
                });
            });
        }

        // Enter private chat
        function enterPrivateChat(contact) {
            currentContact = contact.id;
            showSection('private-chat-section'); // Use showSection
            contactNameDisplay.textContent = contact.username || 'Unknown User';
            privateMessagesDiv.innerHTML = '';
            
            // Detach previous listener if exists
            if (currentPrivateChatUnsubscribe) {
                currentPrivateChatUnsubscribe(); // Call the unsubscribe function
                currentPrivateChatUnsubscribe = null;
            }

            const chatId = [currentUser.uid, contact.id].sort().join('_');
            const chatRef = ref(db, `privateMessages/${chatId}`);
            
            // Attach new listener and store its reference
            currentPrivateChatUnsubscribe = onChildAdded(chatRef, async (data) => {
                const msgData = data.val();
                const msg = document.createElement('div');
                msg.className = `message ${msgData.senderId === currentUser?.uid ? 'sent' : 'received'}`;
                
                // Fetch sender's username and avatar for display
                let senderUsername = 'Unknown';
                try {
                    const senderSnapshot = await get(child(ref(db), `users/${msgData.senderId}`));
                    if (senderSnapshot.exists()) {
                        const senderInfo = senderSnapshot.val();
                        senderUsername = senderInfo.username || 'Unknown';
                    }
                } catch (e) {
                    console.error("Error fetching sender info:", e);
                }

                msg.innerHTML = `
                    <div class="sender">${senderUsername}</div>
                    <div class="text">${msgData.text}</div>
                    <div class="timestamp">${formatTime(msgData.timestamp)}</div>
                `;
                
                privateMessagesDiv.appendChild(msg);
                privateMessagesDiv.scrollTop = privateMessagesDiv.scrollHeight;
            });
            console.log("Entered private chat with:", contact.username, "Private chat section display:", privateChatSection.style.display);
        }

        // Back button for private chat
        document.getElementById('back-private-btn').addEventListener('click', () => {
            showSection('contacts-section'); // Use showSection
            currentContact = "";
            // Detach the listener when leaving private chat
            if (currentPrivateChatUnsubscribe) {
                currentPrivateChatUnsubscribe(); // Call the unsubscribe function
                currentPrivateChatUnsubscribe = null;
            }
        });

        // Send private message
        document.getElementById('send-private-btn').addEventListener('click', sendPrivateMessage);
        document.getElementById('private-msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default Enter key behavior (e.g., new line in textarea)
                sendPrivateMessage();
            }
        });

        function sendPrivateMessage() {
            const input = document.getElementById('private-msg-input');
            const text = input.value.trim();
            
            if (text && currentContact && currentUser) {
                const chatId = [currentUser.uid, currentContact].sort().join('_');
                const chatRef = ref(db, `privateMessages/${chatId}`);
                
                push(chatRef, {
                    text: text,
                    sender: currentUser.username || currentUser.email,
                    senderId: currentUser.uid,
                    timestamp: Date.now()
                });
                
                input.value = "";
            }
        }


        // --- Group Functionality (Existing, slightly modified for clarity) ---

        // Create Group
        document.getElementById('create-group-btn').addEventListener('click', async () => {
            const groupName = prompt("Enter new group name:");
            if (!groupName) return;
            
            const groupPassword = prompt("Enter group password (optional):");

            showLoading('Creating group...');
            try {
                const groupRef = ref(db, `groups/${groupName}`);
                const snapshot = await get(groupRef);
                
                if (snapshot.exists()) {
                    showAlert('Group name already exists!');
                    hideLoading();
                    return;
                }
                
                await set(groupRef, {
                    name: groupName,
                    password: groupPassword || null,
                    createdAt: Date.now(),
                    admin: currentUser.uid,
                    description: '',
                    avatarUrl: ''
                });

                // Add user to group members
                await set(ref(db, `groupMembers/${groupName}/${currentUser.uid}`), {
                    joinedAt: Date.now()
                });

                // Add group to user's joined groups
                await set(ref(db, `userGroups/${currentUser.uid}/${groupName}`), {
                    joinedAt: Date.now()
                });

                hideLoading();
                showAlert('Group created and joined successfully!');
                loadUserGroups(); // Reload groups after creation
            } catch (error) {
                hideLoading();
                console.error("Error creating group:", error);
                showAlert(`Failed to create group: ${error.message}`);
            }
        });

        // Join New Group
        document.getElementById('join-group-btn').addEventListener('click', async () => {
            const groupName = prompt("Enter group name to join:");
            if (!groupName) return;
            
            showLoading('Joining group...');
            try {
                const groupRef = ref(db, `groups/${groupName}`);
                const snapshot = await get(groupRef);
                
                if (!snapshot.exists()) {
                    showAlert('Group does not exist!');
                    hideLoading();
                    return;
                }
                
                const groupData = snapshot.val();
                if (groupData.password) {
                    const enteredPassword = prompt("Enter group password:");
                    if (enteredPassword !== groupData.password) {
                        showAlert('Incorrect password!');
                        hideLoading();
                        return;
                    }
                }

                // Check if already a member
                const memberSnapshot = await get(child(ref(db), `groupMembers/${groupName}/${currentUser.uid}`));
                if (memberSnapshot.exists()) {
                    showAlert('You are already a member of this group!');
                    hideLoading();
                    return;
                }
                
                await set(ref(db, `groupMembers/${groupName}/${currentUser.uid}`), {
                    joinedAt: Date.now()
                });
                await set(ref(db, `userGroups/${currentUser.uid}/${groupName}`), {
                    joinedAt: Date.now()
                });
                
                hideLoading();
                showAlert('Joined group successfully!');
                loadUserGroups(); // Reload groups after joining
            } catch (error) {
                hideLoading();
                console.error("Error joining group:", error);
                showAlert(`Failed to join group: ${error.message}`);
            }
        });

        // Load User Groups
        async function loadUserGroups() {
            if (!currentUser) return;
            
            try {
                const snapshot = await get(child(ref(db), `userGroups/${currentUser.uid}`));
                if (snapshot.exists()) {
                    const groups = snapshot.val();
                    const groupNames = Object.keys(groups);
                    userGroups = [];
                    for (const groupName of groupNames) {
                        const groupSnapshot = await get(child(ref(db), `groups/${groupName}`));
                        if (groupSnapshot.exists()) {
                            userGroups.push({
                                id: groupName,
                                ...groupSnapshot.val()
                            });
                        }
                    }
                    renderGroupsList();
                } else {
                    userGroups = [];
                    renderGroupsList();
                }
            } catch (error) {
                console.error("Error loading groups:", error);
                userGroups = [];
                renderGroupsList();
            }
        }

        // Render Groups List
        function renderGroupsList() {
            groupsCount.textContent = userGroups.length;
            if (userGroups.length === 0) {
                joinedGroupsList.innerHTML = '<div class="no-groups">You haven\'t joined any groups yet</div>';
                return;
            }
            
            joinedGroupsList.innerHTML = userGroups.map(group => `
                <div class="group-item" data-group="${group.id}">
                    <div class="group-avatar">
                        ${group.avatarUrl ? 
                            `<img src="${group.avatarUrl}" alt="${group.name}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/00bcd4/ffffff?text=${group.name.charAt(0).toUpperCase()}'" />` : 
                            `<div>${group.name.charAt(0).toUpperCase()}</div>`}
                    </div>
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-desc">${group.description || 'No description'}</div>
                    </div>
                </div>
            `).join('');

            // Apply styles for fallback avatars (initials)
            document.querySelectorAll('.group-avatar div').forEach(div => {
                div.style.backgroundColor = 'var(--color-cyan-primary)'; /* Use the primary cyan */
                div.style.color = 'white';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.fontSize = '1.8em'; /* Larger initials */
            });

            // Add click event to each group item
            document.querySelectorAll('.group-item').forEach(item => {
                item.addEventListener('click', () => {
                    const groupId = item.getAttribute('data-group');
                    enterGroupChat(groupId);
                });
            });
        }

        // Enter Group Chat
        function enterGroupChat(groupId) {
            currentGroup = groupId;
            showSection('chat-section'); // Use showSection
            groupNameDisplay.textContent = groupId;
            messagesDiv.innerHTML = ''; // Clear previous messages
            
            // Detach previous listener if exists
            if (currentGroupChatUnsubscribe) {
                currentGroupChatUnsubscribe(); // Call the unsubscribe function
                currentGroupChatUnsubscribe = null;
            }

            const messagesRef = ref(db, `groupMessages/${groupId}`);
            
            // Attach new listener and store its reference
            currentGroupChatUnsubscribe = onChildAdded(messagesRef, async (data) => {
                const msgData = data.val();
                const msg = document.createElement('div');
                msg.className = `message ${msgData.senderId === currentUser?.uid ? 'sent' : 'received'}`;
                
                // Fetch sender's username and avatar for display
                let senderUsername = 'Unknown';
                try {
                    const senderSnapshot = await get(child(ref(db), `users/${msgData.senderId}`));
                    if (senderSnapshot.exists()) {
                        const senderInfo = senderSnapshot.val();
                        senderUsername = senderInfo.username || 'Unknown';
                    }
                } catch (e) {
                    console.error("Error fetching sender info:", e);
                }

                msg.innerHTML = `
                    <div class="sender">${senderUsername}</div>
                    <div class="text">${msgData.text}</div>
                    <div class="timestamp">${formatTime(msgData.timestamp)}</div>
                `;
                
                messagesDiv.appendChild(msg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // Back button for group chat
        document.getElementById('back-btn').addEventListener('click', () => {
            showSection('group-options'); // Use showSection
            currentGroup = "";
            // Detach the listener when leaving group chat
            if (currentGroupChatUnsubscribe) {
                currentGroupChatUnsubscribe(); // Call the unsubscribe function
                currentGroupChatUnsubscribe = null;
            }
        });

        // Send Group Message
        document.getElementById('send-btn').addEventListener('click', sendGroupMessage);
        document.getElementById('msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default Enter key behavior
                sendGroupMessage();
            }
        });

        function sendGroupMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            
            if (text && currentGroup && currentUser) {
                const messagesRef = ref(db, `groupMessages/${currentGroup}`);
                push(messagesRef, {
                    text: text,
                    sender: currentUser.username || currentUser.email, // Use username from updated currentUser
                    senderId: currentUser.uid,
                    timestamp: Date.now()
                });
                input.value = "";
            }
        }

        // --- Community Posts Functionality ---

        // Open Create Post Modal
        createPostBtn.addEventListener('click', () => {
            if (!currentUser) {
                showAlert("Please log in to create a post.");
                return;
            }
            createPostModal.style.display = 'flex';
            postImageUrlInput.value = '';
            postDescriptionInput.value = '';
            postTemplateSelect.value = ''; // Reset template selection
            emojiInput.value = ''; // Reset emoji input
        });

        // Close Create Post Modal
        closeCreatePostModal.addEventListener('click', () => {
            createPostModal.style.display = 'none';
        });

        // Handle Template Selection
        postTemplateSelect.addEventListener('change', () => {
            const selectedTemplate = postTemplateSelect.value;
            switch (selectedTemplate) {
                case 'announcement':
                    postImageUrlInput.value = 'https://placehold.co/600x300/00bcd4/ffffff?text=Announcement';
                    postDescriptionInput.value = 'Important Announcement: [Your message here]';
                    break;
                case 'inspiration':
                    postImageUrlInput.value = 'https://placehold.co/600x300/80deea/263238?text=Inspiration';
                    postDescriptionInput.value = 'Daily Dose of Inspiration: "The only way to do great work is to love what you do." - Steve Jobs ';
                    break;
                case 'question':
                    postImageUrlInput.value = 'https://placehold.co/600x300/e0f7fa/00838f?text=Question';
                    postDescriptionInput.value = 'Question of the Day: What\'s your favorite book and why? ';
                    break;
                case 'sale':
                    postImageUrlInput.value = 'https://placehold.co/600x300/ffcc80/263238?text=Item+for+Sale';
                    postDescriptionInput.value = 'For Sale: [Item Name] - [Price]. DM me for details! ';
                    break;
                default:
                    postImageUrlInput.value = '';
                    postDescriptionInput.value = '';
                    break;
            }
        });

        // Add Emoji to Post Description
        addEmojiBtn.addEventListener('click', () => {
            const emoji = emojiInput.value.trim();
            if (emoji) {
                postDescriptionInput.value += ` ${emoji}`; // Append emoji to description
                emojiInput.value = ''; // Clear emoji input
            }
        });

        // Submit New Post
        submitPostBtn.addEventListener('click', async () => {
            const imageUrl = postImageUrlInput.value.trim();
            const description = postDescriptionInput.value.trim();

            if (!imageUrl && !description) {
                showAlert('Please provide an image URL or a description for your post.');
                return;
            }

            if (!currentUser) {
                showAlert("You must be logged in to create a post.");
                return;
            }

            const MAX_POST_CHARS = 7500;
            if (description.length > MAX_POST_CHARS) {
                showAlert(`Post content cannot exceed ${MAX_POST_CHARS} characters.`);
                return;
            }

            showLoading('Creating post...');
            try {
                const newPostRef = push(ref(db, 'posts'));
                await set(newPostRef, {
                    userId: currentUser.uid,
                    username: currentUser.username || 'Anonymous',
                    avatarUrl: currentUser.avatarUrl || '',
                    imageUrl: imageUrl,
                    description: description,
                    timestamp: Date.now(),
                    likes: {},
                    comments: {}
                });
                hideLoading();
                createPostModal.style.display = 'none';
                showAlert('Post created successfully!');
                loadPosts(); // Reload community posts to show the new one
                loadUserPostsForStudio(); // Also reload user's posts for the studio
            } catch (error) {
                hideLoading();
                console.error("Error creating post:", error);
                showAlert(`Failed to create post: ${error.message}`);
            }
        });

        // Load Community Posts
        function loadPosts() {
            if (!currentUser) return;

            // Detach previous listener if exists
            if (currentCommunityPostsUnsubscribe) {
                currentCommunityPostsUnsubscribe();
                currentCommunityPostsUnsubscribe = null;
            }

            const postsRef = ref(db, 'posts');
            currentCommunityPostsUnsubscribe = onValue(postsRef, (snapshot) => {
                allPosts = [];
                snapshot.forEach((childSnapshot) => {
                    allPosts.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                renderPosts(); // Render community posts whenever data changes
            }, (error) => {
                console.error("Error loading community posts:", error);
                showAlert("Failed to load community posts.");
                allPosts = [];
                renderPosts();
            });
        }

        // Render Community Posts
        function renderPosts() {
            let postsToDisplay = [...allPosts]; // Create a copy to sort

            if (currentPostCategory === 'new') {
                postsToDisplay.sort((a, b) => b.timestamp - a.timestamp); // Latest first
            } else if (currentPostCategory === 'trending') {
                postsToDisplay.sort((a, b) => {
                    const likesA = Object.keys(a.likes || {}).length;
                    const likesB = Object.keys(b.likes || {}).length;
                    return likesB - likesA; // Most likes first
                });
            }

            if (postsToDisplay.length === 0) {
                postsContainer.innerHTML = '<div class="no-posts">No posts available yet. Be the first to share!</div>';
                return;
            }

            postsContainer.innerHTML = postsToDisplay.map(post => {
                const likeCount = Object.keys(post.likes || {}).length;
                const isLiked = post.likes && post.likes[currentUser?.uid];
                const commentsHtml = post.comments ? Object.values(post.comments).map(comment => `
                    <div class="comment-item">
                        <span class="comment-author">${comment.username || 'Anonymous'}:</span>
                        <span class="comment-text">${comment.text}</span>
                        <div class="comment-timestamp">${formatTime(comment.timestamp)}</div>
                    </div>
                `).join('') : '';

                const originalDescription = post.description || '';
                const TRUNCATE_LENGTH = 300; // Characters for "show less"
                let displayDescription = originalDescription;
                let showMoreLessButton = '';

                if (originalDescription.length > TRUNCATE_LENGTH) {
                    displayDescription = originalDescription.substring(0, TRUNCATE_LENGTH) + '...';
                    showMoreLessButton = `
                        <button class="show-more-less-btn secondary" data-post-id="${post.id}" data-action="show-more">Show More</button>
                    `;
                }

                return `
                    <div class="post-item" data-post-id="${post.id}">
                        <div class="post-header">
                            <div class="post-avatar">
                                ${post.avatarUrl ? 
                                    `<img src="${post.avatarUrl}" alt="${post.username}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/00bcd4/ffffff?text=${post.username?.charAt(0).toUpperCase() || 'U'}'" />` : 
                                    `<div>${post.username?.charAt(0).toUpperCase() || 'U'}</div>`}
                            </div>
                            <div class="post-username">${post.username || 'Anonymous'}</div>
                            <div class="post-timestamp">${formatTime(post.timestamp)}</div>
                        </div>
                        ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" class="post-image" onerror="this.onerror=null;this.style.display='none';">` : ''}
                        <p class="post-description" data-full-text="${originalDescription}" data-truncated-text="${displayDescription}">
                            ${displayDescription}
                        </p>
                        ${showMoreLessButton}
                        <div class="post-actions">
                            <button class="like-btn ${isLiked ? 'liked' : ''}" data-post-id="${post.id}">Like</button>
                            <span class="like-count">${likeCount} Likes</span>
                        </div>
                        <div class="comment-section">
                            <div class="comment-input-group">
                                <input type="text" class="comment-input" placeholder="Add a comment..." data-post-id="${post.id}" />
                                <button class="send-comment-btn" data-post-id="${post.id}">Send</button>
                            </div>
                            <div class="comment-list">
                                ${commentsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Re-attach event listeners for dynamic content
            document.querySelectorAll('.like-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    toggleLike(postId);
                });
            });

            document.querySelectorAll('.send-comment-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    const input = e.currentTarget.previousElementSibling;
                    addComment(postId, input.value);
                    input.value = '';
                });
            });

            document.querySelectorAll('.comment-input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const postId = e.currentTarget.getAttribute('data-post-id');
                        addComment(postId, e.currentTarget.value);
                        e.currentTarget.value = '';
                    }
                });
            });

            document.querySelectorAll('.show-more-less-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    togglePostDescription(postId, e.currentTarget);
                });
            });

            // Apply styles for fallback avatars (initials) for posts
            document.querySelectorAll('.post-avatar div').forEach(div => {
                div.style.backgroundColor = 'var(--color-cyan-primary)'; /* Use the primary cyan */
                div.style.color = 'white';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.fontSize = '1.5em'; /* Larger initials for posts */
            });
        }

        // Toggle Like on a Post
        async function toggleLike(postId) {
            if (!currentUser) {
                showAlert("You must be logged in to like posts.");
                return;
            }
            const postRef = ref(db, `posts/${postId}/likes/${currentUser.uid}`);
            const snapshot = await get(postRef);

            if (snapshot.exists()) {
                // User already liked, so unlike
                await set(postRef, null); // Remove the like
            } else {
                // User hasn't liked, so like
                await set(postRef, true);
            }
            // loadPosts() will automatically re-render with updated like count
        }

        // Add Comment to a Post
        async function addComment(postId, commentText) {
            const trimmedComment = commentText.trim();
            if (!trimmedComment) {
                showAlert("Comment cannot be empty.");
                return;
            }
            if (!currentUser) {
                showAlert("You must be logged in to comment.");
                return;
            }

            const commentsRef = ref(db, `posts/${postId}/comments`);
            await push(commentsRef, {
                userId: currentUser.uid,
                username: currentUser.username || 'Anonymous',
                text: trimmedComment,
                timestamp: Date.now()
            });
            // loadPosts() will automatically re-render with new comment
        }

        // Toggle Post Description (Show More/Less)
        function togglePostDescription(postId, buttonElement) {
            const postItem = document.querySelector(`.post-item[data-post-id="${postId}"]`);
            const descriptionElement = postItem.querySelector('.post-description');
            
            const fullText = descriptionElement.getAttribute('data-full-text');
            const truncatedText = descriptionElement.getAttribute('data-truncated-text');

            if (buttonElement.getAttribute('data-action') === 'show-more') {
                descriptionElement.textContent = fullText;
                buttonElement.textContent = 'Show Less';
                buttonElement.setAttribute('data-action', 'show-less');
            } else {
                descriptionElement.textContent = truncatedText;
                buttonElement.textContent = 'Show More';
                buttonElement.setAttribute('data-action', 'show-more');
            }
        }

        // Event listeners for post categories
        newPostsBtn.addEventListener('click', () => {
            currentPostCategory = 'new';
            newPostsBtn.classList.add('active');
            trendingPostsBtn.classList.remove('active');
            renderPosts();
        });

        trendingPostsBtn.addEventListener('click', () => {
            currentPostCategory = 'trending';
            trendingPostsBtn.classList.add('active');
            newPostsBtn.classList.remove('active');
            renderPosts();
        });

        // --- Posts Studio Functionality ---

        // Load User's Posts for Studio
        function loadUserPostsForStudio() {
            if (!currentUser) return;

            // Detach previous listener if exists
            if (currentUserPostsUnsubscribe) {
                currentUserPostsUnsubscribe();
                currentUserPostsUnsubscribe = null;
            }

            const postsRef = ref(db, 'posts');
            currentUserPostsUnsubscribe = onValue(postsRef, async (snapshot) => {
                userPosts = [];
                let totalLikes = 0;
                let totalComments = 0;

                // Fetch pinned post ID from user data
                let pinnedPostId = null;
                const userSnapshot = await get(child(ref(db), `users/${currentUser.uid}/pinnedPostId`));
                if (userSnapshot.exists()) {
                    pinnedPostId = userSnapshot.val();
                }

                snapshot.forEach((childSnapshot) => {
                    const post = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    if (post.userId === currentUser.uid) {
                        userPosts.push(post);
                        totalLikes += Object.keys(post.likes || {}).length;
                        totalComments += Object.keys(post.comments || {}).length;
                    }
                });
                
                totalPostsCountSpan.textContent = userPosts.length;
                totalLikesReceivedSpan.textContent = totalLikes;
                totalCommentsReceivedSpan.textContent = totalComments;

                renderUserPostsForStudio(pinnedPostId); // Pass pinnedPostId to render function
            }, (error) => {
                console.error("Error loading user posts for studio:", error);
                showAlert("Failed to load your posts for the studio.");
                userPosts = [];
                renderUserPostsForStudio(null);
            });
        }

        // Render User's Posts for Studio
        function renderUserPostsForStudio(pinnedPostId) {
            let postsToDisplay = [...userPosts]; // Create a copy to sort and filter

            // Filter by search term
            const searchTerm = postStudioSearchInput.value.toLowerCase();
            if (searchTerm) {
                postsToDisplay = postsToDisplay.filter(post => 
                    (post.description && post.description.toLowerCase().includes(searchTerm)) ||
                    (post.imageUrl && post.imageUrl.toLowerCase().includes(searchTerm))
                );
            }

            // Sort based on selected option
            const sortOption = postStudioSortSelect.value;
            if (sortOption === 'newest') {
                postsToDisplay.sort((a, b) => b.timestamp - a.timestamp);
            } else if (sortOption === 'oldest') {
                postsToDisplay.sort((a, b) => a.timestamp - b.timestamp);
            } else if (sortOption === 'most-likes') {
                postsToDisplay.sort((a, b) => {
                    const likesA = Object.keys(a.likes || {}).length;
                    const likesB = Object.keys(b.likes || {}).length;
                    return likesB - likesA;
                });
            } else if (sortOption === 'most-comments') {
                postsToDisplay.sort((a, b) => {
                    const commentsA = Object.keys(a.comments || {}).length;
                    const commentsB = Object.keys(b.comments || {}).length;
                    return commentsB - commentsA;
                });
            }

            // Move pinned post to the top if it exists and is in the filtered/sorted list
            if (pinnedPostId) {
                const pinnedPostIndex = postsToDisplay.findIndex(post => post.id === pinnedPostId);
                if (pinnedPostIndex !== -1) {
                    const pinnedPost = postsToDisplay.splice(pinnedPostIndex, 1)[0];
                    postsToDisplay.unshift(pinnedPost); // Add to the beginning
                }
            }

            if (postsToDisplay.length === 0) {
                userPostsList.innerHTML = '<div class="no-user-posts">You haven\'t uploaded any posts yet.</div>';
                return;
            }

            userPostsList.innerHTML = `<h3>Your Uploaded Posts</h3>` + postsToDisplay.map(post => `
                <div class="user-post-item" data-post-id="${post.id}">
                    <div class="post-header">
                        <div class="post-avatar">
                            ${post.avatarUrl ? 
                                `<img src="${post.avatarUrl}" alt="${post.username}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/00bcd4/ffffff?text=${post.username?.charAt(0).toUpperCase() || 'U'}'" />` : 
                                `<div>${post.username?.charAt(0).toUpperCase() || 'U'}</div>`}
                        </div>
                        <div class="post-username">${post.username || 'Anonymous'} ${post.id === pinnedPostId ? '' : ''}</div>
                        <div class="post-timestamp">${formatTime(post.timestamp)}</div>
                    </div>
                    ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" class="post-image" onerror="this.onerror=null;this.style.display='none';">` : ''}
                    <p class="post-description">${post.description || ''}</p>
                    <div class="user-post-actions">
                        <button class="edit-btn" data-post-id="${post.id}">Edit</button>
                        <button class="delete-btn" data-post-id="${post.id}">Delete</button>
                        <button class="pin-btn ${post.id === pinnedPostId ? 'pinned' : ''}" data-post-id="${post.id}">${post.id === pinnedPostId ? 'Unpin' : 'Pin'}</button>
                        <button class="share-btn" data-post-id="${post.id}">Share</button>
                    </div>
                </div>
            `).join('');

            // Apply styles for fallback avatars (initials) for posts
            document.querySelectorAll('.user-post-item .post-avatar div').forEach(div => {
                div.style.backgroundColor = 'var(--color-cyan-primary)';
                div.style.color = 'white';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.fontSize = '1.5em';
            });

            // Attach event listeners for edit and delete buttons
            document.querySelectorAll('.user-post-item .edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    const postToEdit = userPosts.find(p => p.id === postId);
                    if (postToEdit) {
                        openEditPostModal(postToEdit);
                    }
                });
            });

            document.querySelectorAll('.user-post-item .delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    deletePost(postId);
                });
            });

            document.querySelectorAll('.user-post-item .pin-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    togglePinPost(postId);
                });
            });

            document.querySelectorAll('.user-post-item .share-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    copyPostLink(postId);
                });
            });
        }

        // Event listeners for Posts Studio controls
        postStudioSearchInput.addEventListener('input', () => renderUserPostsForStudio(userData.pinnedPostId));
        postStudioSortSelect.addEventListener('change', () => renderUserPostsForStudio(userData.pinnedPostId));

        // Toggle Pin Post
        async function togglePinPost(postId) {
            if (!currentUser) {
                showAlert("You must be logged in to pin posts.");
                return;
            }

            showLoading('Updating pin status...');
            try {
                const userRef = ref(db, `users/${currentUser.uid}`);
                const currentPinnedId = userData.pinnedPostId;

                if (currentPinnedId === postId) {
                    // Unpin the post
                    await update(userRef, { pinnedPostId: null });
                    userData.pinnedPostId = null;
                    showAlert('Post unpinned successfully!');
                } else {
                    // Pin the new post
                    await update(userRef, { pinnedPostId: postId });
                    userData.pinnedPostId = postId;
                    showAlert('Post pinned successfully!');
                }
                loadUserPostsForStudio(); // Re-render to reflect changes
            } catch (error) {
                console.error("Error toggling pin status:", error);
                showAlert(`Failed to update pin status: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Copy Post Link to Clipboard
        function copyPostLink(postId) {
            // In a real application, this would be a public URL to the post.
            // For this demo, we'll create a dummy link.
            const dummyLink = `https://thunderchat.app/posts/${postId}`;
            
            // Use document.execCommand('copy') for better iframe compatibility
            const tempInput = document.createElement('textarea');
            tempInput.value = dummyLink;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showAlert('Post link copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showAlert('Failed to copy link. Please try manually: ' + dummyLink);
            }
            document.body.removeChild(tempInput);
        }

        // Open Edit Post Modal
        function openEditPostModal(post) {
            editingPostId = post.id;
            editPostImageUrlInput.value = post.imageUrl || '';
            editPostDescriptionInput.value = post.description || '';
            editPostModal.style.display = 'flex';
        }

        // Close Edit Post Modal
        closeEditPostModal.addEventListener('click', () => {
            editPostModal.style.display = 'none';
            editingPostId = null;
        });

        // Add Emoji to Edit Post Description
        addEditEmojiBtn.addEventListener('click', () => {
            const emoji = editEmojiInput.value.trim();
            if (emoji) {
                editPostDescriptionInput.value += ` ${emoji}`;
                editEmojiInput.value = '';
            }
        });

        // Save Edited Post
        saveEditedPostBtn.addEventListener('click', async () => {
            if (!editingPostId) return;

            const newImageUrl = editPostImageUrlInput.value.trim();
            const newDescription = editPostDescriptionInput.value.trim();

            if (!newImageUrl && !newDescription) {
                showAlert('Please provide an image URL or a description for your post.');
                return;
            }

            const MAX_POST_CHARS = 7500;
            if (newDescription.length > MAX_POST_CHARS) {
                showAlert(`Post content cannot exceed ${MAX_POST_CHARS} characters.`);
                return;
            }

            showLoading('Saving changes...');
            try {
                await update(ref(db, `posts/${editingPostId}`), {
                    imageUrl: newImageUrl,
                    description: newDescription,
                    lastEdited: Date.now() // Add a last edited timestamp
                });
                hideLoading();
                editPostModal.style.display = 'none';
                showAlert('Post updated successfully!');
                // loadUserPostsForStudio() will be triggered by the onValue listener
                // loadPosts() will also be triggered for community view
            } catch (error) {
                hideLoading();
                console.error("Error saving edited post:", error);
                showAlert(`Failed to save changes: ${error.message}`);
            } finally {
                editingPostId = null;
            }
        });

        // Delete Post
        async function deletePost(postId) {
            // Using custom alert modal instead of confirm()
            customAlertMessage.innerHTML = 'Are you sure you want to delete this post? This action cannot be undone.';
            customAlertOkBtn.textContent = 'Yes, Delete';
            customAlertOkBtn.classList.add('delete-confirm-btn'); // Add a class to distinguish
            customAlertModal.style.display = 'flex';

            // Temporarily store original click handlers
            const originalOkBtnClickListener = customAlertOkBtn.onclick;
            const originalCloseBtnClickListener = closeAlertBtn.onclick;

            // Override OK button for delete confirmation
            customAlertOkBtn.onclick = async () => {
                hideAlert();
                showLoading('Deleting post...');
                try {
                    await remove(ref(db, `posts/${postId}`));
                    hideLoading();
                    showAlert('Post deleted successfully!');
                } catch (error) {
                    hideLoading();
                    console.error("Error deleting post:", error);
                    showAlert(`Failed to delete post: ${error.message}`);
                } finally {
                    // Restore original click handlers after operation
                    customAlertOkBtn.onclick = originalOkBtnClickListener;
                    customAlertOkBtn.classList.remove('delete-confirm-btn');
                    closeAlertBtn.onclick = originalCloseBtnClickListener;
                }
            };
            // Override Close button to just hide and restore original handlers
            closeAlertBtn.onclick = () => {
                hideAlert();
                customAlertOkBtn.onclick = originalOkBtnClickListener;
                customAlertOkBtn.classList.remove('delete-confirm-btn');
                closeAlertBtn.onclick = originalCloseBtnClickListener;
            };
        }


        // Helper functions
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();

            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            const diffWeeks = Math.floor(diffDays / 7);
            const diffMonths = Math.floor(diffDays / 30);
            const diffYears = Math.floor(diffDays / 365);

            if (diffSeconds < 60) {
                return `${diffSeconds}s ago`;
            } else if (diffMinutes < 60) {
                return `${diffMinutes}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            } else if (diffWeeks < 4) {
                return `${diffWeeks}w ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
        }
        function showLoading(message = 'Loading...') {
            loadingScreen.style.display = 'flex';
            loadingScreen.querySelector('.loading-text').textContent = message;
        }

        function hideLoading() {
            loadingScreen.style.display = 'none';
        }
    </script>
</body>
</html>
